!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).taxonpicker={})}(this,(function(e){"use strict";class t extends Error{}function a(e){try{const t=document.createElement("textarea");return t.innerHTML=e,t.innerHTML.replace(/"/g,"&quot;")}catch(t){const a=document.createElement("pre");return a.appendChild(document.createTextNode(e)),a.innerHTML.replace(/"/g,"&quot;")}}class s{static rawTaxa;id;nameString="";canonical="";hybridCanonical="";acceptedEntityId="";qualifier="";authority="";vernacular="";vernacularRoot="";badVernacular=!1;used;sortOrder;parentIds=[];static showVernacular=!0;static setTaxa(e){s.rawTaxa=e}static fromId(e){if(!s.rawTaxa)throw new t("Taxon.fromId() called before taxon list has been initialise.");if(!s.rawTaxa.hasOwnProperty(e))throw new t(`Taxon id '${e}' not found.`);const a=s.rawTaxa[e],n=new s;return n.id=e,n.nameString=a[0],n.canonical=a[1]||a[0],n.hybridCanonical=a[2]||n.canonical,n.acceptedEntityId=a[3]||e,n.qualifier=a[4],n.authority=a[5],n.vernacular=a[6],n.vernacularRoot=a[7],n.used=a[8],n.sortOrder=a[9],n.parentIds=a[10],a[11]&&(n.badVernacular=!0),n}formattedHTML(e){let t;return this.id!==this.acceptedEntityId&&(t=s.fromId(this.acceptedEntityId)),s.showVernacular?e?t?`<q class="taxon-vernacular">${a(this.vernacular)}</q><wbr> <span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${a(this.authority)}</span> = <span class="italictaxon">${t.nameString}${t.qualifier?` <span class="taxon-qualifier">${t.qualifier}</span>`:""}</span> <span class="taxauthority">${a(t.authority)}</span>`:`<q class="taxon-vernacular">${a(this.vernacular)}</q><wbr> <span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${a(this.authority)}</span>`:t?`<span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${this.authority}</span>${this.vernacular?` <wbr><q class="taxon-vernacular">${a(this.vernacular)}</q>`:""} = <span class="italictaxon">${t.nameString}${t.qualifier?` <span class="taxon-qualifier">${t.qualifier}</span>`:""}</span> <span class="taxauthority">${a(t.authority)}</span>`:`<span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${a(this.authority)}</span>${this.vernacular?` <wbr><q class="taxon-vernacular">${a(this.vernacular)}</q>`:""}`:t?`<span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${this.authority}</span> = <span class="italictaxon">${t.nameString}${t.qualifier?` <span class="taxon-qualifier">${t.qualifier}</span>`:""}</span> <span class="taxauthority">${a(t.authority)}</span>`:`<span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${a(this.authority)}</span>`}}const n=/\b(subg\.|sect\.|subsect\.|ser\.|group|subsp\.|morph\.|var\.|nothovar\.|f\.|nothosubsp\.|pv\.)/g,i=/\s(subfam\.|subg\.|sect\.|subsect\.|ser\.|subser\.|subsp\.|nothosubsp\.|microsp\.|praesp\.|agsp\.|race|convar\.|nm\.|microgene|f\.|subvar\.|var\.|nothovar\.|cv\.|sublusus|taxon|morph\.|group|sp\.)\s/g,r=new Intl.Collator("en",{sensitivity:"base",ignorePunctuation:!0}),l=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");class c{minimumRankSort=null;requireExtantDDbRecords=!1;static showVernacular=!0;static MIN_SEARCH_LENGTH=1;static MAXIMUM_RESULTS=20;constructor(){if(!s.rawTaxa)throw new Error("Taxon.rawTaxa must be initialised before TaxonSearch")}static formatter(e,t=""){const a=e.uname.replace(/\bx\b/g,"×").replace(n,'<span class="rank-name">$1</span>'),s=`<span class="taxon-qualifier${"s.s."===e.qualifier||"s.l."===e.qualifier?"-latin":""}">${e.qualifier}</span>`;if(c.showVernacular){if(e.vernacularMatched)return e.acceptedEntityId?`<q><b>${e.vernacular}</b></q> <span class="italictaxon">${a}${e.qualifier?` ${s}`:""}</span> <span class="taxauthority">${e.authority}</span><span class="pref-taxon-name"> = <span class="italictaxon">${e.acceptedNameString}${e.acceptedQualifier?` <b>${e.acceptedQualifier}</b>`:""}</span> <span class="taxauthority">${e.acceptedAuthority}</span></span>`:`<q><b>${e.vernacular}</b></q> <span class="italictaxon">${a}${e.qualifier?` ${s}`:""}</span> <span class="taxauthority">${e.authority}</span>`;if(e.acceptedEntityId){const t=e.acceptedNameString.replace("/\bx\b/","×").replace(n,'<span class="rank-name">$1</span>');return`<span class="italictaxon">${a}${e.qualifier?` ${s}`:""}</span> <span class="taxauthority">${e.authority}</span>${e.vernacular?` <q class="taxon-vernacular"><b>${e.vernacular}</b></q>`:""}<span class="pref-taxon-name"> = <span class="italictaxon">${t}${e.acceptedQualifier?` <b>${e.acceptedQualifier}</b>`:""}</span> <span class="taxauthority">${e.acceptedAuthority}</span></span>`}return`<span class="italictaxon">${a}${e.qualifier?` ${s}`:""}</span> <span class="taxauthority">${e.authority}</span>${e.vernacular?` <q class="taxon-vernacular"><b>${e.vernacular}</b></q>`:""}`}if(e.acceptedEntityId){const t=e.acceptedNameString.replace("/\bx\b/","×").replace(n,'<span class="rank-name">$1</span>');return`<span class="italictaxon">${a}${e.qualifier?` ${s}`:""}</span> <span class="taxauthority">${e.authority}</span><span class="pref-taxon-name"> = <span class="italictaxon">${t}${e.acceptedQualifier?` <b>${e.acceptedQualifier}</b>`:""}</span> <span class="taxauthority">${e.acceptedAuthority}</span></span>`}return`<span class="italictaxon">${a}${e.qualifier?` ${s}`:""}</span> <span class="taxauthority">${e.authority}</span>`}static abbreviatedGenusRegex=/^(X\s+)?([a-z])[.\s]+(.*?)$/i;static nameStringColumn=0;static canonicalColumn=1;static hybridCanonicalColumn=2;static acceptedEntityIdColumn=3;static qualifierColumn=4;static authorityColumn=5;static vernacularColumn=6;static vernacularRootColumn=7;static usedColumn=8;static minRankColumn=9;static badVernacularColumn=11;static taxonRankNameSearchRegex=[/\s+sub-?g(?:en(?:us)?)?[.\s]+/i,/\s+sect(?:ion)?[.\s]+/i,/\s+subsect(?:ion)?[.\s]+/i,/\s+ser(?:ies)?[.\s]+/i,/\s+gp[.\s]+/i,/\s+s(?:ub)?-?sp(?:ecies)?[.\s]+/i,/\s+morphotype\s+/i,/\s+var[.\s]+/i,/\s+cv[.\s]+/i,/\s+n(?:otho)?v(?:ar)?[.\s]+/i,/\s+f[.\s]+|\s+forma?\s+/i,/\s+n(?:otho)?ssp[.\s]+/i];static taxonRankNameReplacement=[" subg. "," sect. "," subsect. "," ser. "," group "," subsp. "," morph. "," var. "," cv. "," nothovar. "," f. "," nothosubsp. "];static taxonQualifierSearchRegex=[/\s*\(?\bf\s*x\s*m or m\s*x\s*f\)?\s*$/i,/\s*\(?\bm\s*x\s*f or f\s*x\s*m\)?\s*$/i,/\s*\(?\bf\s*x\s*m\)?\s*$/i,/\s*\(?\bm\s*x\s*f\)?\s*$/i,/\s*\(?\bfemale\s*x\s*male\)?\s*$/i,/\s*\(?\bmale\s*x\s*female\)?\s*$/i,/\s*'male'\s*$/i,/\s*'female'\s*$/i,/\b\s*sens\.?\s*lat[.\s]+/i,/\b\s*s\.\s*lat\.?\s*\b/i,/\b\s*s\.?\s*l\.?\s+\b/i,/\b\s*sensu\s*lato\s+\b|\(\s*sensu\s*lato\s*\)/i,/\b\s*sensu\s*stricto\s+\b|\(\s*sensu\s*stricto\s*\)/i,/\b\s*sens\.?\s*strict[.\s]+/i,/\b\s*sens\.?\s*str\.?\s*(?=\))|\b\s*sens\.?\s*str[.\s]+/i,/\b\s*s\.\s*str[.\s]+/i,/\b\s*s\.?\s*s\.?\s+\b/i,/\b\s*sens\.?\s*lat\.?\s*$/i,/\b\s*s\.\s*lat\.?\s*$/i,/\b\s*s\.?\s*l\.?\s*$/i,/\b\s*sensu\s*lato\s*$/i,/\b\s*sensu\s*stricto\s*$/i,/\b\s*sens\.?\s*strict\.?\s*$/i,/\b\s*sens\.?\s*str\.?\s*$/i,/\b\s*s\.\s*str\.?\s*$/i,/\b\s*s\.?\s*s\.?\s*$/i,/\b\s*agg\.?\s*$/i,/\b\s*aggregate\s*$/i,/\b\s*sp\.?\s*cultivar\s*$/i,/\b\s*sp\.?\s*cv\.?\s*$/i,/\b\s*cultivars?\s*$/i,/\b\s*cv\s+$/i,/\b\s*cv$/i,/\b\s*cf\s*$/i,/\b\s*aff\s*$/i,/\b\s*s\.?n\.?\s*$/i,/\b\s*sp\.?\s*nov\.?\s*$/i,/\b\s*auct[.\s]*$/i,/\b\s*ined[.\s]*$/i,/\b\s*nom\.?\snud[.\s]*$/i,/\b\s*p\.p[.\s?]*$/i,/\b\s*spp?\.?[\s?]*$/i,/\b\s*species\s*$/i,/\b\s*spp?\.?\s*\(/i,/\b\s*species\s*\(/i];static taxonQualifierReplacement=[" "," "," (f x m)"," (m x f)"," (f x m)"," (m x f)"," male"," female"," s.l. "," s.l. "," s.l. "," s.l. "," s.s. "," s.s. "," s.s. "," s.s. "," s.s. "," s.l."," s.l."," s.l."," s.l."," s.s."," s.s."," s.s."," s.s."," s.s."," agg."," agg."," cv. "," cv. "," cv. "," cv. "," cv. "," cf."," aff."," sp.nov."," sp.nov."," auct."," ined."," nom. nud."," pro parte","",""," ("," ("];static normaliseTaxonName(e){e=e.replace(/[×✕]/gu," x ").replace(/\s+/gu," ").trim();for(let t=0,a=c.taxonRankNameSearchRegex.length;t<a;t++)e=e.replace(c.taxonRankNameSearchRegex[t],c.taxonRankNameReplacement[t]);for(let t=0,a=c.taxonQualifierSearchRegex.length;t<a;t++)e=e.replace(c.taxonQualifierSearchRegex[t],c.taxonQualifierReplacement[t]);return e}static generate_hybrid_combinations_regex(e){const t=l(e).split(/\s+x\s+/i);if(t.length<2)return t[0];const a=[],s=(e,t)=>{if(0===e.length)a[a.length]=t.join("[a-zA-Z]* x ");else for(let a=e.length-1;a>=0;--a){const n=e.slice(0),i=t.slice(0);i.unshift(n.splice(a,1)[0]),s(n,i)}};return s(t,[]),`(?:${a.join("|")})`}lookup_parent_results(e,t){const a=s.fromId(e);if(a.parentIds.length){const e=new Set(a.parentIds),n={};if(t)for(let t in s.rawTaxa){let a=s.rawTaxa[t];a[6]&&a[10].filter(Set.prototype.has,e).length&&(n[t]={exact:!1,near:!1,vernacular:!0})}else for(let t in s.rawTaxa){let a=s.rawTaxa[t];!a[3]&&a[10].filter(Set.prototype.has,e).length&&(n[t]={exact:!1,near:!1})}return this.compile_results(n,!1,[])}return[]}lookup(e,t=[],a=!0){let n,i,o,u,d={};const p=decodeURIComponent(e).trim();if(i=c.normaliseTaxonName(p),u=/ x\b/.test(i),i=i.replace(/\s+x$/i,""),""!==i){const h=i.match(c.abbreviatedGenusRegex);if(h){let e,r;"X"===h[2]||"x"===h[2]?(e=new RegExp(`^(X\\s|X[a-z]+\\s+)(x )?\\b${c.generate_hybrid_combinations_regex(h[3])}.*`,"i"),r=e):(e=new RegExp(`^(X )?${l(h[2])}[a-z]+ (x )?.*\\b${c.generate_hybrid_combinations_regex(h[3])}.*`,"i"),r=new RegExp(`^(X )?${l(h[2])}[a-z]+ (x )?\\b${c.generate_hybrid_combinations_regex(h[3])}.*`,"i"));for(let t in s.rawTaxa){let n=s.rawTaxa[t];o=0===n[c.canonicalColumn]?n[c.nameStringColumn]:n[c.canonicalColumn],(e.test(o)||""!==n[c.hybridCanonicalColumn]&&e.test(n[c.hybridCanonicalColumn]))&&(d[t]={exact:a&&n[c.nameStringColumn]===i,near:r.test(n[c.nameStringColumn])})}n=this.compile_results(d,u,t)}else{let e,h;const m=l(i),x=l(p);i.includes(" ")?(e=`${l(i.substring(0,i.indexOf(" ")))} (x )?.*\\b${c.generate_hybrid_combinations_regex(i.substring(i.indexOf(" ")+1))}.*`,h=new RegExp(`^(?:Xs+)?${l(i.substring(0,i.indexOf(" ")))} (x )?\\b${c.generate_hybrid_combinations_regex(i.substring(i.indexOf(" ")+1))}.*`,"i")):(e=`${m}.*`,h=new RegExp(`^${m}.*`));const f=`^${x}.*`,v=new RegExp(`^(?:Xs+)?${e}`,"i");if(c.showVernacular){const e=new RegExp(f.replace(/(?<=\p{L})[\s-]+(?=\p{L})/gu,"[\\s-]*"),"i");for(let t in s.rawTaxa){let n=s.rawTaxa[t];o=0===n[c.canonicalColumn]?n[c.nameStringColumn]:n[c.canonicalColumn],v.test(n[c.nameStringColumn])||o!==n[c.nameStringColumn]&&v.test(o)?d[t]={exact:a&&0===r.compare(n[c.nameStringColumn],i),near:h.test(n[c.nameStringColumn])||h.test(o)}:n[c.badVernacularColumn]||!e.test(n[c.vernacularColumn])&&!e.test(n[c.vernacularRootColumn])||(d[t]={exact:a&&0===r.compare(n[c.vernacularColumn],i),vernacular:!0})}if(n=this.compile_results(d,u,t),n.length<5){const e=m.replace(/(?<=\p{L})[\s-]+(?=\p{L})/gu,"[\\s-]*"),r=x.replace(/(?<=\p{L})[\s-]+(?=\p{L})/gu,"[\\s-]*"),l=new RegExp(`\\b${e}.*`,"i"),o=new RegExp(`\\b${r}.*`,"i");for(let e in s.rawTaxa)if(!d.hasOwnProperty(e)){let t=s.rawTaxa[e];l.test(t[c.nameStringColumn])?d[e]={exact:a&&t[c.nameStringColumn]===i}:(0!==t[c.canonicalColumn]&&l.test(t[c.canonicalColumn])||!t[c.badVernacularColumn]&&o.test(t[c.vernacularColumn]))&&(d[e]={exact:a&&t[c.nameStringColumn]===i,vernacular:!0})}n=this.compile_results(d,u,t)}}else{for(let e in s.rawTaxa){let t=s.rawTaxa[e];o=0===t[c.canonicalColumn]?t[c.nameStringColumn]:t[c.canonicalColumn],(v.test(t[c.nameStringColumn])||o!==t[c.nameStringColumn]&&v.test(o))&&(d[e]={exact:a&&0===r.compare(t[c.nameStringColumn],i)})}n=this.compile_results(d,u,t)}}if(1===n.length&&0===t.length){let t=!1;if(i.indexOf(" ")>0&&!n[0].vernacularMatched){n[0].exact&&(n=n.concat(this.lookup_parent_results(n[0].entityId,!1)));const a=i.substring(0,e.indexOf(" "));n=n.concat(this.lookup(a,n,!1)),t=!0}else n[0].vernacularMatched&&n[0].exact&&(n=n.concat(this.lookup_parent_results(n[0].entityId,!0)),t=!0);if(t){const e=[];for(let t=0;t<n.length;t++)n.hasOwnProperty(t)&&-1!==e.indexOf(n[t].entityId)?delete n[t]:e.push(n[t].entityId);n=n.filter((e=>!0))}}}else n=[];return n}compile_results(e,t,a=[]){const n=[].concat(a);for(const t in e)if(e.hasOwnProperty(t)){const a=s.rawTaxa[t];if((!this.requireExtantDDbRecords||this.requireExtantDDbRecords&&1===a[c.usedColumn])&&(!this.minimumRankSort||this.minimumRankSort>0&&a[c.minRankColumn]>=this.minimumRankSort)){const i=a[c.nameStringColumn]+(a[c.qualifierColumn]?` ${a[c.qualifierColumn]}`:""),r={entityId:t,vernacular:a[c.vernacularColumn],qname:i,name:i,qualifier:a[c.qualifierColumn],authority:a[c.authorityColumn],uname:a[c.nameStringColumn],vernacularMatched:e[t].hasOwnProperty("vernacular")&&e[t].vernacular,exact:e[t].hasOwnProperty("exact")&&e[t].exact,near:e[t].hasOwnProperty("near")&&e[t].near};if(r.formatted=c.formatter(r),a[c.acceptedEntityIdColumn]){const e=s.rawTaxa[a[c.acceptedEntityIdColumn]];if(!e)throw s.rawTaxa?new Error(`Failed to find taxon for accepted entity id ${a[c.acceptedEntityIdColumn]}`):new Error(`Taxon.rawTaxa set is undefined, when trying to find taxon for accepted entity id ${a[c.acceptedEntityIdColumn]}`);r.acceptedEntityId=a[c.acceptedEntityIdColumn],r.acceptedNameString=e[c.nameStringColumn],r.acceptedQualifier=e[c.qualifierColumn],r.acceptedAuthority=e[c.authorityColumn],r.acceptedQname=r.acceptedNameString+(r.acceptedQualifier?` ${r.acceptedQualifier}`:"")}n.push(r)}}return n.length&&(n.sort(((e,a)=>{if(e.exact)return a.exact&&e.acceptedEntityId?1:-1;if(a.exact)return 1;if(e.near){if(!a.near)return-1}else if(a.near)return 1;let s=null!==e.uname.match(/\bx\b/i),n=null!==a.uname.match(/\bx\b/i);if(s)return n?e.uname===a.uname?e.acceptedEntityId?1:0:e.qname<a.qname?-1:1:t?-1:1;if(n)return t?1:-1;if(e.uname===a.uname){if(!e.acceptedEntityId&&!a.acceptedEntityId||e.acceptedEntityId&&a.acceptedEntityId){let t=["s.s.","",null,"s.l.","agg."].indexOf(e.qualifier),s=["s.s.","",null,"s.l.","agg."].indexOf(a.qualifier);return t===s?0:t<s?1:-1}return e.acceptedEntityId?1:-1}if(e.vernacularMatched&&a.vernacularMatched&&e.vernacular!==a.vernacular)return e.vernacular.length===a.vernacular.length?r.compare(e.vernacular,a.vernacular):e.vernacular.length<a.vernacular.length?-1:1;if(e.acceptedEntityId&&!a.acceptedEntityId)return 1;if(a.acceptedEntityId&&!e.acceptedEntityId)return-1;const l=e.uname.replaceAll(i," ").replaceAll("'","").replaceAll(/\bx /gi,""),c=a.uname.replaceAll(i," ").replaceAll("'","").replaceAll(/\bx /gi,"");return r.compare(l,c)})),n.length>c.MAXIMUM_RESULTS&&(n.length=c.MAXIMUM_RESULTS)),n}}class o{#e=[];static STOP_PROPAGATION="STOP_PROPAGATION";bindListener(e,t,a,s){this.#e=this.#e||[];const n=function(e,n,i){return a.call(t,e,n,i,s)};return this.#e[e]?this.#e[e].push(n)-1:(this.#e[e]=[n],0)}addListener(e,t,a={}){this.#e=this.#e||[];const s=function(e,s,n={}){return t({context:e,eventName:s,...n,...a})};return this.#e[e]?this.#e[e].push(s)-1:(this.#e[e]=[s],0)}removeListener(e,t){this.#e[e]&&this.#e[e][t]?delete this.#e[e][t]:console.log("trying to remove non-existent event handler, event = "+e+" handle = "+t)}destructor(){this.#e=null}fireEvent(e,t){if(this.#e)for(let t in this.#e[e])if(this.#e[e].hasOwnProperty(t)&&this.#e[e][t](this,e,arguments[1])===o.STOP_PROPAGATION)break}}class u extends o{_value=null;_fieldEl;label="";helpText="";validationMessage="";static COMPLETION_COMPULSORY="compulsory";static COMPLETION_DESIRED="desired";static COMPLETION_OPTIONAL="optional";completion=u.COMPLETION_OPTIONAL;static#t=1;static EVENT_CHANGE="fieldChange";constructor(){super()}setParams(e){e.label&&(this.label=e.label),e.helpText&&(this.helpText=e.helpText),e.validationMessage&&(this.validationMessage=e.validationMessage)}static get nextId(){return`field${u.#t++}_${Date.now()}`}get value(){return this._value}set value(e){}get fieldElement(){return this._fieldEl||this.buildField(),this._fieldEl}attributeName;addField(e){e.appendChild(this.fieldElement)}markValidity(e){}static cleanRawInput(e){return e.value.trim().replace(/\s\s+/g," ")}static cleanRawString(e){return e.trim().replace(/\s\s+/g," ")}static isEmpty(e){return""===e||null==e}static isValid(e,t,a){return!t.attributes.completion||t.attributes.completion!==u.COMPLETION_COMPULSORY&&t.attributes.completion!==u.COMPLETION_DESIRED?null:!(!a.hasOwnProperty(e)||t.field.isEmpty(a[e]))}static summarise(e,t,a){return!t.summary||t.summary.hasOwnProperty("summarise")&&!0!==t.summary.summarise?"":t.summarise?t.summarise(e,t,a):t.field.summariseImpl(e,t,a)}static summariseImpl(e,t,a){return""}buildField(){}}const d="taxon-invalid",p="dropdown-focused",h="taxon-selected";class m extends u{taxonSearch;#a;#s;#n;#i;#r;#l;#c=null;#o=null;#u=null;_lastInputValue="";unrecognizedWarningText="";alwaysUseAcceptedName=!0;allowTaxonMismatches=!1;hangLeft=!1;#d=[];_value={taxonId:"",taxonName:"",vernacularMatch:!1};#p="";static timeoutDelay=50;constructor(){super(),this.taxonSearch=new c}set value(e){let t;if(e&&e.taxonId){t=s.fromId(e.taxonId);const a=t.nameString+(t.qualifier?` ${t.qualifier}`:"");this._value={taxonId:t.id,taxonName:e.vernacularMatch?t.vernacular:a,vernacularMatch:e.vernacularMatch}}else this._value={taxonId:"",taxonName:e&&e.taxonName?e.taxonName:"",vernacularMatch:null};this.updateView()}get value(){return this._value}static isEmpty(e){return!e||e&&!e.taxonName}updateView(){if(this._fieldEl){const e=document.getElementById(this.#a);if(e.value=this._value.taxonName,this._value.taxonId){const t=s.fromId(this._value.taxonId);e.title=t.nameString+(t.qualifier?` ${t.qualifier}`:"")+(t.authority?` ${t.authority}`:"")+(t.vernacular?` “${t.vernacular}”`:"")}else e.title="Search for a taxon.";this._lastInputValue=this._value.taxonName;const t=document.getElementById(this.#l);t&&(this._value.taxonName?this._value.taxonId?t.classList.remove(d):t.classList.add(d):t.classList.remove(d))}}markValidity(e){const t=document.getElementById(this.#a);null===e?t.classList.remove("is-invalid","is-valid"):(t.classList.remove(e?"is-invalid":"is-valid"),t.classList.add(e?"is-valid":"is-invalid"))}buildField(){const e=document.createElement("div");if(e.className="form-group mb-3",this.#r=e.id=u.nextId,this.#a=u.nextId,this.unrecognizedWarningText){const t=e.appendChild(document.createElement("p"));t.id=this.#l=u.nextId,t.className="taxon-unrecognized-container",t.textContent=this.unrecognizedWarningText}if(this.label){const t=e.appendChild(document.createElement("label"));t.htmlFor=this.#a,t.textContent=this.label}const t=e.appendChild(document.createElement("div"));t.className="dropdown-wrapper",this.#i=t.id=u.nextId;const a=t.appendChild(document.createElement("input"));if(a.className="form-control dropdown-input",a.id=this.#a,a.autocomplete="off",a.spellcheck=!1,a.type="search",a.placeholder="Search for a taxon",a.setAttribute("aria-autocomplete","list"),a.setAttribute("role","combobox"),a.setAttribute("aria-expanded","false"),a.setAttribute("aria-activedescendant",""),this.validationMessage){const e=t.appendChild(document.createElement("div"));e.className="invalid-feedback",e.innerHTML=this.validationMessage}const s=t.appendChild(document.createElement("div"));if(s.className="dropdown-list",this.#s=s.id=u.nextId,s.setAttribute("role","listbox"),a.setAttribute("aria-controls",this.#s),this.#n=u.nextId,this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText}a.addEventListener("keydown",this.keydownHandler.bind(this)),a.addEventListener("input",this.inputHandler.bind(this)),a.addEventListener("change",this.inputChangeHandler.bind(this)),e.addEventListener("focusin",this.focusHandler.bind(this)),e.addEventListener("focusout",this.blurHandler.bind(this)),s.addEventListener("click",this.dropboxClickHandler.bind(this)),this._fieldEl=e}setTabIndex(e){const t=document.getElementById(this.#a);t&&(t.tabIndex=e)}keydownHandler(e){switch(this._lastInputValue=e.target.value.trimStart(),e.key){case"Enter":e.preventDefault(),this.#h(e);break;case"ArrowUp":e.preventDefault(),this.#u>0&&this.setSelectedIndex(this.#u-1);break;case"ArrowDown":e.preventDefault(),this.#d.length&&(null===this.#u?this.setSelectedIndex(0):this.#u<this.#d.length-1&&this.setSelectedIndex(this.#u+1));break;case"ArrowRight":if(this.#d.length&&null===this.#u){let t;t="backward"===e.target.selectionDirection?e.target.selectionStart:e.target.selectionEnd,t===e.target.value.length&&(this.#m(0),this.#x(e.target),e.preventDefault())}break;case"Escape":if(e.preventDefault(),this.#d.length&&null!==this.#u)this.#h(e);else{const e=document.getElementById(this.#a);e.value="",this.#d.length=0,e.blur()}}}#h(e){this.#c&&(clearTimeout(this.#c),this.#c=null),this.inputChangeHandler(e);document.getElementById(this.#i).classList.remove(p),document.body.classList.remove("hide-controls"),document.getElementById(this.#a).blur()}inputHandler(e){e.target.value.trimStart()!==this._lastInputValue&&this.#x(e.target)}#x(e){let t=u.cleanRawInput(e);this.#c&&clearTimeout(this.#c),t.length>=c.MIN_SEARCH_LENGTH?this.#c=setTimeout((()=>{this.#d=this.taxonSearch.lookup(u.cleanRawInput(document.getElementById(this.#a))),this.refreshSearchResultsList(),this.#c=null}),m.timeoutDelay):(this.#d=[],this.refreshSearchResultsList())}focusHandler(e){const t=document.getElementById(this.#i);if(!t.classList.contains(p)){const e=document.getElementById(this.#a);if(this.#x(e),t.classList.add(p),document.body.classList.add("hide-controls"),this.hangLeft){const e=document.getElementById(this.#s);e.style.right="0",e.style.position="absolute",e.style.width="24em"}if(this._value.taxonId&&this._value.taxonName===e.value&&!this._value.vernacularMatch){const t=this._value.taxonName.indexOf(" ");t>-1&&e.setSelectionRange(t+1,e.value.length,"backward")}}}blurHandler(e){this.#c&&(clearTimeout(this.#c),this.#c=null),setTimeout((()=>{document.getElementById(this.#i).classList.remove(p);const e=document.getElementById(this.#a);e.setAttribute("aria-expanded","false"),e.setAttribute("aria-activedescendant",""),document.body.classList.remove("hide-controls")}),500)}refreshSearchResultsList(){const e=document.getElementById(this.#s),t=document.getElementById(this.#a);if(this.#u=null,this.#d.length){const a=[];let s=0;for(let e of this.#d){let t=`taxonitem${this.#s}_${e.entityId}`;a[a.length]=`<a class="list-group-item list-group-item-action" href="#" data-occurrenceId="${e.entityId}" data-resultnumber="${s}" id="${t}">${c.formatter(e)}</a>`,++s}e.innerHTML=`<div class="list-group" id="${this.#n}">${a.join("")}</div>`,this.#d[0].exact&&this.setSelectedIndex(0),t.setAttribute("aria-expanded","true")}else e.innerHTML=`<div class="list-group" id="${this.#n}"><p class="taxon-picker-type-prompt">Start typing the name of a taxon.</p></div>`,t.setAttribute("aria-expanded","false"),t.setAttribute("aria-activedescendant","")}setSelectedIndex(e){if(e!==this.#u){if(null!==this.#u){const e=document.querySelector(`div#${this.#s} a[data-resultnumber="${this.#u}"]`);e&&(e.classList.remove(h),e.setAttribute("aria-selected","false"))}const t=document.querySelector(`div#${this.#s} a[data-resultnumber="${e}"]`);if(t){t.classList.add(h),this.#u=e,t.setAttribute("aria-selected","true");document.getElementById(this.#a).setAttribute("aria-activedescendant",t.id)}else this.#u=null}}static cleanRawInput(e){return e.value.trim().replace(/\s\s+/g," ")}dropboxClickHandler(e){if(function(e){return!!(e.detail&&e.detail>1)&&(e.preventDefault(),e.stopPropagation(),!0)}(e))return;const t=e.target.closest("a");this.#o&&(clearTimeout(this.#o),this.#o=null),t&&t.dataset.occurrenceid&&(e.preventDefault(),this.#m(parseInt(t.dataset.resultnumber)))}#m(e){const t=this.#d[e];t.acceptedEntityId&&this.alwaysUseAcceptedName?this.value={taxonId:t.acceptedEntityId,taxonName:t.acceptedQname,vernacularMatch:!1}:this.value={taxonId:t.entityId,taxonName:t.vernacularMatched?t.vernacular:t.qname,vernacularMatch:t.vernacularMatched},this.#p!==this._value.taxonId&&(this.#p=this._value.taxonId,this.fireEvent(u.EVENT_CHANGE))}setTaxonFromId(e){if(e){let t=s.fromId(e);t.acceptedEntityId&&(t=s.fromId(t.acceptedEntityId));const a=t.nameString+(t.qualifier?` ${t.qualifier}`:"");this.value={taxonId:t.id,taxonName:a,vernacularMatch:!1}}else this.value={taxonId:"",taxonName:"",vernacularMatch:null};this.#p=this._value.taxonId,this.updateView()}inputChangeHandler(e){e.stopPropagation(),this.#o&&clearTimeout(this.#o),this.#o=setTimeout((()=>{if(""===document.getElementById(this.#a).value){this.#c&&(clearTimeout(this.#c),this.#c=null);document.getElementById(this.#i).classList.remove(p)}else{let e;e=null!==this.#u?this.#d[this.#u]:this.#d.find((e=>e.exact)),e?e.acceptedEntityId&&this.alwaysUseAcceptedName?this.value={taxonId:e.acceptedEntityId,taxonName:e.acceptedQname,vernacularMatch:!1}:this.value={taxonId:e.entityId,taxonName:e.vernacularMatched?e.vernacular:e.qname,vernacularMatch:e.vernacularMatched}:this.value={taxonId:"",taxonName:this.allowTaxonMismatches?document.getElementById(this.#a).value.trim():"",vernacularMatch:null}}this.#p!==this._value.taxonId&&(this.#p=this._value.taxonId,this.fireEvent(u.EVENT_CHANGE))}),500)}}e.Taxon=s,e.TaxonError=t,e.TaxonPickerField=m,e.TaxonSearch=c}));
//# sourceMappingURL=taxonpicker.min.umd.js.map
