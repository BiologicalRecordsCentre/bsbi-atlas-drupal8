{"version":3,"file":"bsbi-atlas-min.umd.js","sources":["../jssrc/js/dataAccessAtlas.js","../jssrc/js/metaTags.js","../jssrc/js/gen.js","../jssrc/js/ecology.js","../jssrc/js/gallery.js","../jssrc/js/utils.js","../jssrc/js/mapping.js","../jssrc/js/devel.js","../jssrc/js/trendSummary.js","../jssrc/js/download.js","../jssrc/js/main.js","../jssrc/index.js"],"sourcesContent":["import * as d3 from 'd3'\n\n// Only one export from this file - the data\n// access structure. All the data access functions\n// are members of this structure.\nexport const bsbiDataAccess = {}\n\nbsbiDataAccess.bsbiDataRoot = ''\nbsbiDataAccess.periodClasses = 'standard'\nbsbiDataAccess.showStatus = true\nbsbiDataAccess.resolution = 'hectad'\nbsbiDataAccess.displayedMapType = 'static'\nbsbiDataAccess.taxaHybridList = []\nbsbiDataAccess.taxaNoStatusList = []\nbsbiDataAccess.changeColours = ['#FAD0C8', '#DD5A2F', '#525252']\nbsbiDataAccess.symboltype ='circle'\nbsbiDataAccess.periodColours = {}\nbsbiDataAccess.dotCaption = ''\n\nbsbiDataAccess.periodColours.standard = {\n  x: {\n    \"to 1929\": '#f7f7f7',\n    \"1930 - 1969\": '#c6c6c6',\n    \"1970 - 1986\": '#909090',\n    \"1987 - 1999\": '#4e4e4e',\n    \"2000 - 2019\": '#000000'\n  },\n  n: {\n    \"to 1929\": '#eff3ff',\n    \"1930 - 1969\": '#bdd7e7',\n    \"1970 - 1986\": '#6baed6',\n    \"1987 - 1999\": '#2b71a5',\n    \"2000 - 2019\": '#004d99'\n  },\n  a: {\n    \"to 1929\": '#FEE5D9',\n    \"1930 - 1969\": '#FCBCB4',\n    \"1970 - 1986\": '#FF8C86',\n    \"1987 - 1999\": '#FF0000',\n    \"2000 - 2019\": '#B30000'\n  },\n  bullseye: {\n    \"to 1929\": 'black',\n    \"1930 - 1969\": 'black',\n    \"1970 - 1986\": 'black',\n    \"1987 - 1999\": 'black',\n    \"2000 - 2019\": 'black'\n  },\n  missing: {\n    \"to 1929\": 'black',\n    \"1930 - 1969\": 'black',\n    \"1970 - 1986\": 'black',\n    \"1987 - 1999\": 'black',\n    \"2000 - 2019\": 'black'\n  }\n}\n\nbsbiDataAccess.periodColours.print = {\n  x: {\n    \"pre-1970\": '#f7f7f7',\n    \"1970 - 1986\": '#b9b9b9',\n    \"1987 - 1999\": '#6f6f6f',\n    \"2000 - 2019\": '#000000'\n  },\n  n: {\n    \"pre-1970\": '#eff3ff',\n    \"1970 - 1986\": '#bdd7e7',\n    \"1987 - 1999\": '#368dcd',\n    \"2000 - 2019\": '#004d99'\n  },\n  a: {\n    \"pre-1970\": '#fee5d9',\n    \"1970 - 1986\": '#fc9898',\n    \"1987 - 1999\": '#ff4646',\n    \"2000 - 2019\": '#b30000'\n  },\n  bullseye: {\n    \"pre-1970\": 'black',\n    \"1970 - 1986\": 'black',\n    \"1987 - 1999\": 'black',\n    \"2000 - 2019\": 'black'\n  },\n  missing: {\n    \"pre-1970\": 'black',\n    \"1970 - 1986\": 'black',\n    \"1987 - 1999\": 'black',\n    \"2000 - 2019\": 'black'\n  }\n}\n\nbsbiDataAccess.periodStroke = {}\n\nbsbiDataAccess.periodStroke.standard = {\n  x: {\n    \"to 1929\": '#808080',\n    \"1930 - 1969\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  },\n  n: {\n    \"to 1929\": '#808080',\n    \"1930 - 1969\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  },\n  a: {\n    \"to 1929\": '#808080',\n    \"1930 - 1969\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  },\n  bullseye: {\n    \"to 1929\": '#808080',\n    \"1930 - 1969\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  },\n  missing: {\n    \"to 1929\": '#808080',\n    \"1930 - 1969\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  }\n}\n\nbsbiDataAccess.periodStroke.print = {\n  x: {\n    \"pre-1970\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  },\n  n: {\n    \"pre-1970\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  },\n  a: {\n    \"pre-1970\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  },\n  bullseye: {\n    \"pre-1970\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  },\n  missing: {\n    \"pre-1970\": '#808080',\n    \"1970 - 1986\": '#808080',\n    \"1987 - 1999\": '#808080',\n    \"2000 - 2019\": '#808080'\n  }\n}\n\n// The periodMappsing code added 19/01/2020 to deal with mapping periods required in app\n// that are different from those expressed in CSV files that I have available at that time.\n// Was extended to meet the requirement of showing faded symbols for hectads where recorded\n// in earlier time period.\n\nconst periodMappings = {}\n\nperiodMappings.print = {\n  \"pre-1970\": {\n    prior: [],\n    csvperiods: [\"to 1929\", \"1930 - 1969\"]\n  },\n  \"1970 - 1986\": {\n    prior: [\"to 1929\", \"1930 - 1969\"],\n    csvperiods: [\"1970 - 1986\"],\n  },\n  \"1987 - 1999\": {\n    prior: [\"to 1929\", \"1930 - 1969\", \"1970 - 1986\"],\n    csvperiods: [\"1987 - 1999\"]\n  },\n  \"2000 - 2019\": {\n    prior: [\"to 1929\", \"1930 - 1969\", \"1970 - 1986\", \"1987 - 1999\"],\n    csvperiods: [\"2000 - 2009\", \"2010 - 2019\"]\n  }\n}\n\nperiodMappings.standard = {\n  \"to 1929\": {\n    prior:[],\n    csvperiods: [\"to 1929\"]\n  },\n  \"1930 - 1969\": {\n    prior: [\"to 1929\"],\n    csvperiods: [\"1930 - 1969\"]\n  },\n  \"1970 - 1986\": {\n    prior: [\"to 1929\", \"1930 - 1969\"],\n    csvperiods: [\"1970 - 1986\"],\n  },\n  \"1987 - 1999\": {\n    prior: [\"to 1929\", \"1930 - 1969\", \"1970 - 1986\"],\n    csvperiods: [\"1987 - 1999\"]\n  },\n  \"2000 - 2019\": {\n    prior: [\"to 1929\", \"1930 - 1969\", \"1970 - 1986\", \"1987 - 1999\"],\n    csvperiods: [\"2000 - 2009\", \"2010 - 2019\"]\n  }\n}\n\nbsbiDataAccess.distAllClasses = function(identifier) {\n\n  if (bsbiDataAccess.resolution === 'hectad') {\n    return distAllClasses(identifier)\n  } else if (bsbiDataAccess.resolution === 'tetrad') {\n    return distAllClassesTetrad(identifier)\n  } else {\n    return distAllClassesMonad(identifier)\n  }\n}\n\nbsbiDataAccess.status_29 = function(identifier) {\n  return nativeSpeciesStatus(identifier, 'to 1929')\n}\n\nbsbiDataAccess.status_30_69 = function(identifier) {\n  return nativeSpeciesStatus(identifier, '1930 - 1969')\n}\n\nbsbiDataAccess.status_70_86 = function(identifier) {\n  return nativeSpeciesStatus(identifier, '1970 - 1986')\n}\n\nbsbiDataAccess.status_87_99 = function(identifier) {\n  return nativeSpeciesStatus(identifier, '1987 - 1999')\n}\n\nbsbiDataAccess.status_00_19 = function(identifier) {\n  return nativeSpeciesStatus(identifier, '2000 - 2019')\n}\n\nbsbiDataAccess.hybrid = function(identifier) {\n\n  const hybridInfo = bsbiDataAccess.taxaHybridList.find(function(h){return h.taxon === identifier})\n\n  function markup(text) {\n    // Look for ' x ' and replace either size with '</i> x <i>'\n    const textOut = text.replace(/ x /g, '</i> x <i>')\n    return '<i>' + textOut + '</i>'\n  }\n\n  const pHybrid =  new Promise(function (resolve, reject) {\n    d3.csv(getCSV(identifier)).then(function (data) {\n      resolve(data)\n    })[\"catch\"](function (e) {\n      console.log(`Hybrid map: can't retrieve map data for hybrid taxon ${identifier}`)\n      reject(e)\n    })\n  })\n  const pParent1 =  new Promise(function (resolve, reject) {\n    d3.csv(getCSV(hybridInfo.parent1)).then(function (data) {\n      resolve(data)\n    })[\"catch\"](function (e) {\n      console.log(`Hybrid map: can't retrieve map data for parent taxon ${hybridInfo.parent1}`)\n      reject(e)\n    })\n  })\n  const pParent2 =  new Promise(function (resolve, reject) {\n    d3.csv(getCSV(hybridInfo.parent2)).then(function (data) {\n      resolve(data)\n    })[\"catch\"](function (e) {\n      console.log(`Hybrid map: can't retrieve map data for parent taxon ${hybridInfo.parent2}`)\n      reject(e)\n    })\n  })\n\n  bsbiDataAccess.dotCaption = `Hectad: <br/>\n    <i>${hybridInfo.parent1Name}</i>: </br>\n    <i>${hybridInfo.parent2Name}</i>: </br>\n    Hybrid:`\n\n  return new Promise(function (resolve, reject) {\n    Promise.all([pHybrid, pParent1, pParent2]).then(function (data) {\n      //https://nbn.org.uk/wp-content/uploads/2020/01/Preston_et_al-2015-Biological_Journal_of_the_Linnean_Society.pdf\n\n      const pink = '#E4C3AA'\n      const blue = '#A8CBE2'\n      const yellow = '#F7F619'\n\n      const all = []\n      data.forEach(function(taxonData, iTaxonData) {\n        taxonData.forEach(function(r){\n          const match = all.find(function(ar){return r.hectad === ar.gr})\n          if (match){\n            match.presence[iTaxonData] = true\n          } else {\n            const presence = [false, false, false]\n            presence[iTaxonData] = true\n            all.push({\n              gr: r.hectad,\n              presence: presence\n            })\n          }\n        })\n      })\n      all.forEach(function(r) {\n        r.colour = r.presence[1] && r.presence[2] ? yellow : r.presence[1] ? pink : blue\n        r.caption = `Hectad: <b>${r.gr}</b><br/>\n          <i>${hybridInfo.parent1Name}</i>: <b>${r.presence[1] ? 'present' : 'absent'}</b></br>\n          <i>${hybridInfo.parent2Name}</i>: <b>${r.presence[2] ? 'present' : 'absent'}</b></br>\n          Hybrid: <b>${r.presence[0] ? 'present' : 'absent'}</b>`\n        r.noCaption = bsbiDataAccess.dotCaption\n      }) \n      const n = all.length\n      for (let i=0; i<n; i++) {\n        //console.log(all[i])\n        if (all[i].presence[0]) {\n          all.push({\n            gr: all[i].gr,\n            shape: 'square',\n            size: 0.6,\n            colour: 'black',\n            caption: all[i].caption,\n            noCaption: all[i].noCaption\n          })\n        }\n      }\n      \n      resolve({\n        records: all,\n        precision: 10000,\n        shape: 'circle',\n        size: 1,\n        opacity: 1,\n        legend: {\n          lines:[\n            {\n              colour: 'black',\n              text: 'Hybrid recorded',\n              shape: 'square',\n              size: 0.6\n            },\n            {\n              colour: pink,\n              text: markup(hybridInfo.parent1Name),\n            },\n            {\n              colour: blue,\n              text: markup(hybridInfo.parent2Name),\n            },\n            {\n              colour: yellow,\n              text: 'Both parents',\n            }\n          ]\n        }\n      })\n    })[\"catch\"](function (e) {\n      reject(e)\n    })\n  })\n}\n\nfunction getCSV(identifier, type) {\n  const folder = type ? type : 'hectads'\n  const file = `${bsbiDataAccess.bsbiDataRoot}${folder}/${identifier.replace(\".\", \"_\")}.csv`\n  return file\n}\n\nfunction distAllClasses(identifier) {\n\n  const statusText = {\n    n: 'Native', //inative\n    a: 'Non-native (alien)', //non-native (alien),\n    bullseye: 'Introduced',\n    missing: 'missing' //no value yet\n  }\n\n  const legendText = {\n    \"pre-1970\": \"pre-1970\",\n    \"to 1929\": \"pre-1930\",\n    \"1930 - 1969\": \"1930–69\",\n    \"1970 - 1986\": \"1970–86\",\n    \"1987 - 1999\": \"1987–99\",\n    \"2000 - 2019\": \"2000–19\"\n  }\n\n  const opacities = {\n    \"pre-1970\": 1,\n    \"to 1929\": 1,\n    \"1930 - 1969\": 1,\n    \"1970 - 1986\": 1,\n    \"1987 - 1999\": 1,\n    \"2000 - 2019\": 1\n  }\n\n  const periods = Object.keys(periodMappings[bsbiDataAccess.periodClasses]).reverse()\n  \n  return new Promise(function (resolve, reject) {\n\n    const counts = {}\n    periods.forEach(function (p) {\n      counts[p] = {\n        ire: {\n          n: 0,\n          a: 0,\n          bullseye: 0,\n          missing: 0,\n          total: 0\n        },\n        gb: {\n          n: 0,\n          a: 0,\n          bullseye: 0,\n          missing: 0,\n          total: 0\n        }\n      }\n    })\n\n    if (bsbiDataAccess.showStatus) {\n      bsbiDataAccess.dotCaption = `Hectad:<br/>\n        Most recent dateclass:<br/>\n        Status:</b>`\n    } else {\n      bsbiDataAccess.dotCaption = `Hectad:<br/>\n        Most recent dateclass:`\n    }\n\n    d3.csv(getCSV(identifier), function (r) {\n      if (r.hectad ) {\n        // GB or Irish?\n        let country\n        if (r.hectad.length === 3) {\n          country='ire'\n        } else {\n          country='gb'\n        }\n\n        // Status (can be n for native, a for alien, or bullseye for reintroduced)\n        let hectadstatus = r.hectadstatus ? r.hectadstatus : 'missing'\n        const statusValid = ['n', 'a', 'bullseye', 'missing']\n        if (statusValid.indexOf(hectadstatus) === -1) {\n          // If status not valid, consider missing\n          hectadstatus = 'missing'\n        }\n\n        // Count the occurrences in each date category for legend\n        // (not just the last one recorded in)\n        let occurs = false\n        let period, recent\n        for (let iPeriod = 0; iPeriod < periods.length; iPeriod++) {\n          period = periods[iPeriod]\n          const csvperiods = periodMappings[bsbiDataAccess.periodClasses][period].csvperiods\n          for (let iCsvperiod = 0; iCsvperiod < csvperiods.length; iCsvperiod++) {\n            const csvperiod = csvperiods[iCsvperiod]\n            if (r[csvperiod] === '1') {\n              counts[period][country][hectadstatus]++\n              counts[period][country]['total']++\n              occurs = true\n              recent = recent ? recent : period // Save the most recent period which is used to get styles\n              // If recent = 'pre-1970', reset\n              // if (recent === 'pre-1970') recent = '1930 - 1969'\n              break\n            }\n          }\n        }\n\n        // Presence attrs - required for data download\n        const attrs = {}\n        for (let iPeriod = 0; iPeriod < periods.length; iPeriod++) {\n          period = periods[iPeriod]\n          attrs[period] = 0\n          const csvperiods = periodMappings[bsbiDataAccess.periodClasses][period].csvperiods\n          for (let iCsvperiod = 0; iCsvperiod < csvperiods.length; iCsvperiod++) {\n            const csvperiod = csvperiods[iCsvperiod]\n            if (r[csvperiod] === '1') {\n              attrs[period] = 1\n              break\n            }\n          }\n        }\n\n        if (occurs) {\n          let point\n          if (bsbiDataAccess.showStatus) {\n            point = {\n              gr: r.hectad,\n              //shape: bsbiDataAccess.displayedMapType === 'static' ? 'circle' : 'circlerad',\n              shape: 'circle',\n              colour: bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses][hectadstatus][recent],\n              stroke: bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses][hectadstatus][recent],\n              size: hectadstatus === 'missing' ? 0.5 : 1,\n              opacity: opacities[recent],\n              caption: `Hectad: <b>${r.hectad}</b><br/>\n                        Most recent dateclass: <b>${getPeriodText(recent)}</b><br/>\n                        Status: <b>${statusText[hectadstatus]}</b>`,\n              noCaption: bsbiDataAccess.dotCaption,\n            }\n          } else {\n            point = {\n              gr: r.hectad,\n              //shape: bsbiDataAccess.displayedMapType === 'static' ? 'circle' : 'circlerad',\n              shape: 'circle',\n              colour: bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses].x[recent],\n              stroke: bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses].x[recent],\n              size: 1,\n              opacity: opacities[recent],\n              caption: `Hectad: <b>${r.hectad}</b><br/>\n                        Most recent dateclass: <b>${getPeriodText(recent)}</b>`,\n              noCaption: bsbiDataAccess.dotCaption,\n            }\n          }\n          // Add attributes required for download\n          // Use the legend keys as the attr names\n          Object.keys(attrs).forEach(k => {\n            point[legendText[k]] = attrs[k]\n          })\n          return point\n        }\n      }\n    }).then(function (data) {\n      let legend\n      const totalAlien = periods.reduce(function(t, p) {return t + counts[p].gb.a + counts[p].ire.a}, 0)\n      const totalNative = periods.reduce(function(t, p) {return t + counts[p].gb.n + counts[p].ire.n}, 0)\n      let lines = []\n      if (bsbiDataAccess.showStatus) {\n        if (totalNative) {\n          lines.push({text: ['Native', '', 'GB', 'IR'], underline: true})\n          periods.forEach(function(p) {\n            lines.push ({\n              colour: bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses].n[p],\n              stroke: bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses].n[p],\n              opacity: opacities[p],\n              text: [legendText[p], 'symbol', counts[p].gb.n, counts[p].ire.n],\n              shape: 'circle'\n            })\n          })\n        }\n        if(totalNative && totalAlien){\n          lines.push({text: []})\n        }\n        if (totalAlien) {\n          lines.push({text: ['Alien', '', 'GB', 'IR'], underline: true})\n          periods.forEach(function(p) {\n            lines.push ({\n              colour: bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses].a[p],\n              stroke: bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses].a[p],\n              opacity: opacities[p],\n              text: [legendText[p], 'symbol', counts[p].gb.a, counts[p].ire.a],\n              shape: 'circle'\n            })\n          })\n        }\n      } else {\n        lines = [{text: ['', '', 'GB', 'IR'], underline: true}]\n        periods.forEach(function(p) {\n          lines.push ({\n            colour: bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses].x[p],\n            stroke: bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses].x[p],\n            opacity: opacities[p],\n            text: [legendText[p], 'symbol', counts[p].gb.total, counts[p].ire.total],\n            shape: 'circle'\n          })\n        })\n      }\n      legend = {\n        size: 0.8,\n        raligned: [false, false, true, true],\n        padding: 5,\n        lines: lines\n      }\n\n      resolve({\n        records: data,\n        precision: 10000,\n        size: 1,\n        legend: legend\n      })\n    })[\"catch\"](function (e) {\n      reject(e)\n    })\n  })\n}\n\nfunction distAllClassesTetrad(identifier) {\n\n  bsbiDataAccess.dotCaption = `Tetrad:`\n\n  return new Promise(function (resolve, reject) {\n\n    d3.csv(getCSV(identifier, 'tetrads'), function (r) {\n      if (r.tetrad ) {\n        return {\n          gr: r.tetrad,\n          //shape: bsbiDataAccess.symboltype, //'circle' dev only,\n          shape: 'square',\n          colour: 'black',\n          size: 1,\n          opacity: 1,\n          caption: `Tetrad: <b>${r.tetrad}</b>`,\n          noCaption: bsbiDataAccess.dotCaption\n        }\n      }\n    }).then(function (data) {\n      resolve({\n        records: data,\n        precision: 2000,\n        size: 1,\n        legend: {\n          lines:[\n            {\n              colour: 'black',\n              opacity: 1,\n              text: 'Present in tetrad',\n              //shape: bsbiDataAccess.symboltype === 'square' ? 'square' : 'circle', //'circle' dev only\n              shape: 'square'\n            }\n          ]\n        }\n      })\n    })[\"catch\"](function (e) {\n      reject(e)\n    })\n  })\n}\n\nfunction distAllClassesMonad(identifier) {\n\n  return new Promise(function (resolve, reject) {\n\n    d3.csv(getCSV(identifier, 'monads'), function (r) {\n      if (r.gr ) {\n        return {\n          gr: r.gr,\n          shape: 'square',\n          colour: 'black',\n          size: 1,\n          opacity: 1,\n        }\n      }\n    }).then(function (data) {\n      resolve({\n        records: data,\n        precision: 1000,\n        size: 1,\n        legend: {\n          lines:[\n            {\n              colour: 'black',\n              opacity: 1,\n              text: 'Present in monad',\n              shape: 'square'\n            }\n          ]\n        }\n      })\n    })[\"catch\"](function (e) {\n      reject(e)\n    })\n  })\n}\n\nfunction getPeriodText(p) {\n  return p === \"to 1929\" ? \"pre-1930\" : p.replace(\" - \", \"–\")\n}\n\nfunction nativeSpeciesStatus(identifier, period) {\n\n  const counts = {\n    occurs: {\n      missing: 0,\n      n: 0,\n      a: 0,\n      y: 0,\n      w: 0,\n      bullseye:0\n    },\n    prior: {\n      missing: 0,\n      n: 0,\n      a: 0,\n      y: 0,\n      w: 0,\n      bullseye:0\n    }\n  }\n\n  bsbiDataAccess.dotCaption = `Hectad:<br/>Occurrence:`\n\n  return new Promise(function (resolve, reject) {\n\n    d3.csv(getCSV(identifier), function (r) {\n      if (r.hectad ) {\n        let occurs = false\n        periodMappings[bsbiDataAccess.periodClasses][period].csvperiods.forEach(function(csvPeriod) {\n          if (r[csvPeriod] === '1') {\n            occurs = true\n          }\n        })\n        let prior = false\n        periodMappings[bsbiDataAccess.periodClasses][period].prior.forEach(function(csvPeriod) {\n          if (r[csvPeriod] === '1') {\n            prior = true\n          }\n        })\n        if (occurs || prior) {\n          return {\n            gr: r.hectad,\n            shape: 'circle',\n            size: 1,\n            colour: occurs ? '#000000' : '#b0b0b0',\n            opacity: 1,\n            stroke: '#808080',\n            caption: `Hectad: <b>${r.hectad}</b><br/>\n            Occurrence: <b>${occurs ? 'in' : 'prior to'}</b> the period <b>${getPeriodText(period)}</b>`,\n            noCaption: bsbiDataAccess.dotCaption\n          }\n        }\n      }\n    }).then(function (data) {\n      const legend = {\n        precision: 10000,\n        size: 1,\n        lines: [{\n          //colour: 'black',\n          colour: '#636363',\n          opacity: 1,\n          stroke: 'black',\n          text: getPeriodText(period),\n          shape: 'circle'\n        }, {\n          //colour: 'black',\n          colour: '#bdbdbd',\n          //opacity: 0.5,\n          opacity: 1,\n          stroke: 'black',\n          text: 'Earlier',\n          shape: 'circle'\n        }]\n      }\n      // If period is 'to 1929' remove the 'earlier' line\n      if (period == 'to 1929') {\n        legend.lines.pop()\n      }\n\n      resolve({\n        records: data,\n        precision: 10000,\n        opacity: 1,\n        size: 1,\n        legend: legend\n      })\n    })[\"catch\"](function (e) {\n      reject(e)\n    })\n  })\n}\n\nbsbiDataAccess.change_1987_1999_vs_2000_2019 = function(identifier) {\n  return change(identifier, ['1987 - 1999'], ['2000 - 2009', '2010 - 2019'], 'Change from 1987–1999 to 2000–2019')\n}\n\nbsbiDataAccess.change_1930_1969_vs_2000_2019 = function(identifier) {\n  //return change(identifier, ['1930 - 1949', '1950 - 1969'], ['2000 - 2009', '2010 - 2019'], 'Change from 1930–1969 to 2000–2019')\n  //return change(identifier, ['to 1929', '1930 - 1969'], ['2000 - 2009', '2010 - 2019'], 'Change from 1930–1969 to 2000–2019')\n  return change(identifier, ['1930 - 1969'], ['2000 - 2009', '2010 - 2019'], 'Change from 1930–1969 to 2000–2019')\n}\n\nfunction change(identifier, early, late, legendTitle) {\n\n  bsbiDataAccess.dotCaption = \"Hectad:</br>Change:\"\n\n  const shapes = ['square', 'triangle-up', 'triangle-down']\n  //const colours = ['#FAD0C8', '#DD5A2F', '#525252']\n  const colours = bsbiDataAccess.changeColours\n  return new Promise(function (resolve, reject) {\n    d3.csv(getCSV(identifier), function (r) {\n      const presentEarly = early.some(function (f) {\n        return r[f] === '1'\n      })\n      const presentLate = late.some(function (f) {\n        return r[f] === '1'\n      })\n      let i, capText\n\n      if (presentEarly && presentLate) {\n        i = 0 //present\n        capText = 'Present in both periods'\n      } else if (!presentEarly && presentLate) {\n        i = 1 //gain\n        capText = 'Gain'\n      } else if (presentEarly && !presentLate) {\n        i = 2 //loss\n        capText = 'Loss'\n      } else {\n        i = 100 //not present in either period\n      }\n\n      if (r.hectad && i < 100) {\n        return {\n          gr: r.hectad,\n          colour: colours[i],\n          shape: shapes[i],\n          caption: \"Hectad: <b>\".concat(r.hectad, \"</b></br>Change: <b>\").concat(capText, \"</b>\"),\n          noCaption: bsbiDataAccess.dotCaption,\n        }\n      }\n    }).then(function (data) {\n      resolve({\n        records: data,\n        size: 1,\n        precision: 10000,\n        opacity: 1,\n        legend: {\n          title: legendTitle,\n          size: 1,\n          precision: 10000,\n          opacity: 1,\n          lines: [{\n            colour: colours[1],\n            text: 'Gain',\n            shape: 'triangle-up'\n          }, {\n            colour: colours[0],\n            text: 'No change',\n            shape: 'square'\n          }, {\n            colour: colours[2],\n            text: 'Loss',\n            shape: 'triangle-down'\n          }]\n        }\n      })\n    })[\"catch\"](function (e) {\n      reject(e)\n    })\n  })\n}\n\nbsbiDataAccess.bsbiHectadDateTetFreq = function(identifier) {\n\n  const fields = [\"to 1929\", \"1930 - 1969\", \"1970 - 1986\", \"1987 - 1999\", \"2000 - 2009\", \"2010 - 2019\"]\n  const legendSizeFact = 0.5\n  bsbiDataAccess.dotCaption = \"Hectad: </br>Tetrads where present:\"\n  //const colour = d3.scaleLinear().domain([1, 13, 25]).range(['#edf8b1', '#7fcdbb', '#2c7fb8'])\n  return new Promise(function (resolve, reject) {\n    d3.csv(getCSV(identifier), function (r) {\n\n      const tetrads = Number(r['distinct tetrads'])\n      const tetround = Math.ceil(tetrads/5)*5\n\n      if (r.hectad && tetrads) {\n        return {\n          gr: r.hectad,\n          size: Math.sqrt(tetround)/5,\n          caption: \"Hectad: <b>\".concat(r.hectad, \"</b></br>Tetrads where present: <b>\").concat(tetrads, \"</b>\"),\n          noCaption: bsbiDataAccess.dotCaption\n        }\n      }\n    }).then(function (data) {\n      resolve({\n        records: data,\n        //size: 1,\n        colour: 'black',\n        //shape: bsbiDataAccess.displayedMapType === 'static' ? 'circle' : 'circlerad',\n        shape: 'circle',\n        precision: 10000,\n        opacity: 1,\n        legend: {\n          title: 'Tetrad frequency',\n          size: 1,\n          shape: 'circle',\n          colour: 'black',\n          precision: 10000,\n          opacity: 1,\n          lines: [{\n            text: '1–5',\n            size: Math.sqrt(5)/5 * legendSizeFact,\n          }, {\n            text: '6–10',\n            size: Math.sqrt(10)/5 * legendSizeFact,\n          },{\n            text: '11–15',\n            size: Math.sqrt(15)/5 * legendSizeFact,\n          }, {\n            text: '16–20',\n            size: Math.sqrt(20)/5 * legendSizeFact,\n          }, {\n            text: '21–25',\n            size: Math.sqrt(25)/5 * legendSizeFact,\n          }]\n        }\n      })\n    })[\"catch\"](function (e) {\n      reject(e)\n    })\n  })\n}","const $=jQuery // eslint-disable-line no-undef\n\nexport function setBaseMetaTags() {\n\n  addMetaTags('title', 'BSBI Online Plant Atlas 2020')\n  addMetaTags('authors', 'Stroh, P. A., Humphrey, T., Burkmar, R. J., Pescott, O. L., , Roy, D.B., and Walker, K. J.')\n  addMetaTags('author', 'Stroh, P. A.')\n  addMetaTags('author', 'Humphrey, T.')\n  addMetaTags('author', 'Burkmar, R. J.')\n  addMetaTags('author', 'Pescott, O. L.')\n  addMetaTags('author', 'Roy, D. B.')\n  addMetaTags('author', 'Walker, K. J.')\n  addMetaTags('year', '2022')\n  addMetaTags('url', location.origin + '/atlas')\n}\n\nexport function addMetaTags(type, value, update) {\n\n  const addHeadTag = (name, content, update) => {\n    if (update) {\n      $('meta[name=\"' + name + '\"').attr('content', content) \n    } else {\n      $('head').append('<meta name=\"' + name + '\" content=\"' + content + '\" />') \n    }\n  }\n\n  // http://div.div1.com.au/div-thoughts/div-commentaries/66-div-commentary-metadata\n  switch(type) {\n    case 'title':\n      $('head title').html(value)\n      addHeadTag(\"citation_title\", value, update)\n      addHeadTag(\"dc.title\", value, update)\n      addHeadTag(\"dcterms.title\", value, update)\n      addHeadTag(\"prism.alternateTitle\", value, update)\n      addHeadTag(\"eprints.title\", value, update)\n      addHeadTag(\"bepress_citation_title\", value, update)\n      break\n    case 'author':\n      addHeadTag(\"citation_author\", value)\n      addHeadTag(\"dc.creator\", value)\n      addHeadTag(\"dcterms.creator\", value)\n      addHeadTag(\"eprints.creators_name\", value)\n      addHeadTag(\"bepress_citation_author\", value)\n      break\n    case 'authors':\n      addHeadTag(\"author\", value)\n      addHeadTag(\"citation_authors\", value)\n      break\n    case 'year':\n      addHeadTag(\"citation_year\", value)\n      addHeadTag(\"citation_date\", value)\n      addHeadTag(\"citation_publication_date\", value)\n      addHeadTag(\"dc.date\", value)\n      addHeadTag(\"dcterms.date\", value)\n      addHeadTag(\"dcterms.created\", value)\n      addHeadTag(\"prism.copyrightYear\", value)\n      addHeadTag(\"prism.coverDate\", value)\n      addHeadTag(\"prism.publicationDate\", value)\n      addHeadTag(\"eprints.datestamp\", value)\n      addHeadTag(\"eprints.date\", value)\n      addHeadTag(\"bepress_citation_date\", value)\n      break\n    case 'url':\n      addHeadTag(\"citation_public_url\", value)\n      addHeadTag(\"prism.url\", value)\n      addHeadTag(\"eprints.official_url\", value)\n      addHeadTag(\"bepress_citation_pdf_url\", value)\n  }\n}\n\n\n","export const pcache = '20062022x1'","import * as d3 from 'd3'\n\nconst $=jQuery // eslint-disable-line no-undef\nlet phen1, phen2, phen3, altlat\nlet apparencyByLatData\nimport { pcache } from './gen'\n\nexport function createEcology(sel) {\n\n  $('<h4>').appendTo($(sel)).text('Phenology & Apparency')\n\n  const $p1 = $('<p>').appendTo($(sel))\n  $p1.text(\"Explanation of apparency and phenology charts. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque blandit dui vel mauris maximus interdum. Aliquam orci eros, venenatis vel purus nec, venenatis congue leo. Pellentesque rhoncus metus eros, tincidunt congue massa volutpat facilisis. Curabitur pellentesque turpis velit, quis ornare mauris ullamcorper a.\")\n  \n  const $phenFlexParent = $('<div>').appendTo($(sel))\n  $phenFlexParent.attr('class', 'phenRow')\n  const $phenFlexLeft = $('<div>').appendTo($phenFlexParent)\n  $phenFlexLeft.attr('class', 'phenColumn')\n  const $phenFlexRight = $('<div>').appendTo($phenFlexParent)\n  $phenFlexRight.attr('class', 'phenColumn')\n  \n  $('<h4>').appendTo($(sel)).text('Altitude vs Latitude')\n  const $p2 = $('<p>').appendTo($(sel))\n  $p2.text(\"Explanation of latitude/altitude chart. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque blandit dui vel mauris maximus interdum. Aliquam orci eros, venenatis vel purus nec, venenatis congue leo. Pellentesque rhoncus metus eros, tincidunt congue massa volutpat facilisis. Curabitur pellentesque turpis velit, quis ornare mauris ullamcorper a.\")\n  const $altlat = $('<div>').appendTo($(sel))\n\n  const $apparency = $('<div>').appendTo($phenFlexLeft)\n  $apparency.attr('id', 'bsbi-apparency-chart').css('max-width', '400px')\n\n  phen1 = brccharts.phen1({\n    selector: '#bsbi-apparency-chart',\n    data: [],\n    taxa: ['taxon'],\n    metrics: [{ prop: 'n', label: 'Apparency', colour: 'green', fill: '#ddffdd' }],\n    width: 400,\n    height: 250,\n    headPad: 35,\n    perRow: 1,\n    expand: true,\n    showTaxonLabel: false,\n    axisLeft: 'off',\n    showLegend: false,\n    interactivity: 'none'\n  })\n  \n  const $phenology = $('<div>').appendTo($phenFlexLeft)\n  $phenology.attr('id', 'bsbi-phenology-chart').css('max-width', '400px')\n\n  phen2 = brccharts.phen2({\n    selector: '#bsbi-phenology-chart',\n    data: [],\n    taxa: ['taxon'],\n    metrics: [],\n    width: 400,\n    height: 25,\n    split: true,\n    headPad: 35,\n    chartPad: 35,\n    perRow: 1,\n    expand: true,\n    showTaxonLabel: false,\n    interactivity: 'none'\n  })\n\n  const $phenSource = $('<div>').appendTo($phenFlexLeft)\n  $phenSource.attr('id', 'bsbi-phenology-source')\n  $phenSource.css('font-size', '0.8em')\n  $phenSource.css('padding-left', '32px')\n  $phenSource.css('max-width', '400px')\n\n  const $apparencyByLat = $('<div>').appendTo($phenFlexRight)\n  $apparencyByLat.attr('id', 'bsbi-apparency-by-lat-chart').css('max-width', '400px')\n\n  // $apparencyByLat = $('<div>').appendTo($phenFlexRight)\n  // $apparencyByLat.attr('id', 'bsbi-apparency-by-lat-chart').css('max-width', '400px')\n\n  phen3 = brccharts.phen1({\n    selector: '#bsbi-apparency-by-lat-chart',\n    data: [],\n    taxa: ['taxon'],\n    metrics: [],\n    lines: ['white', 'white', '#dddddd', 'white', 'white', '#dddddd', 'white', 'white', '#dddddd', 'white', 'white', '#dddddd'],\n    width: 400,\n    height: 410,\n    spread: true,\n    perRow: 1,\n    expand: true,\n    showTaxonLabel: false,\n    showLegend: false,\n    interactivity: 'mousemove',\n    margin: {left: 40, right: 0, top: 20, bottom: 5},\n    axisLeftLabel: 'Latitudinal band',\n    axisLabelFontSize: 12\n  })\n\n  //latPhenNormalizeCheckbox($phenFlexRight, phen3) \n  latPhenDataTypeDropdown($phenFlexRight) \n\n  // Alt vs Lat visualisation\n  $altlat.attr('id', 'bsbi-altlat-chart')\n  $altlat.css('max-width', '600px')\n\n  const opts = {\n    selector: '#bsbi-altlat-chart',\n    data: [],\n    ranges:  [\n      {\n        min: 0,\n        max: 0.99999,\n        radius: 8,\n        legend: '<1%'\n      },\n      {\n        min: 1,\n        max: 10,\n        radius: 11,\n        legend: '1-10%'\n      },\n      {\n        min: 10.00001,\n        max: 30,\n        radius: 14,\n        legend: '11-30%'\n      },\n      {\n        min: 30.00001,\n        max: 40,\n        radius: 16,\n        legend: '31-40%'\n      },\n      {\n        min: 40.00001,\n        max: 50,\n        radius: 18,\n        legend: '41-50%'\n      },\n      {\n        min: 50.00001,\n        max: 100,\n        radius: 20,\n        legend: '51-100%'\n      }\n    ],\n    taxa: ['dummy'],\n    width: 600,\n    height: 300,\n    perRow: 1,\n    expand: true,\n    margin: {left: 45, right: 10, top: 20, bottom: 35},\n    showTaxonLabel: false,\n    showLegend: true,\n    axisLabelFontSize: 12,\n    legendFontSize: 10,\n    interactivity: 'toggle'\n  }\n\n  altlat = brccharts.altlat(opts)\n\n  // Website style is overriding some charts style, so reset it\n  $('.brc-chart-phen1').css('overflow', 'visible')\n\n  // Chart line width - not currently a chart option\n  $('#bsbi-apparency-by-lat-chart .phen-path').css('stroke-width', 1)\n}\n\nfunction latPhenNormalizeCheckbox($parent, phenChart) {\n  // Overall control container\n  const $container = $('<div style=\"margin-left: 0px\">').appendTo($parent)\n  $container.addClass('atlas-phen-normalize-checkbox-control')\n  $container.css('margin-left', '35px')\n\n  // Normalize checkbox\n  const $checDiv = $('<div class=\"checkbox\">').appendTo($container)\n  $checDiv.css('margin-top', '0')\n\n  $('<label><input type=\"checkbox\" class=\"atlas-phen-normalize-checkbox\"/><span>Normalize over latitudes</span></label>').appendTo($checDiv)\n\n  $('.atlas-phen-normalize-checkbox').change(function() {\n    const normalize = $(this).is(':checked')\n    phenChart.setChartOpts({ytype: normalize ? 'normalized' : 'count'})\n  })\n}\n\nfunction latPhenDataTypeDropdown($parent) {\n\n  const dataTypes = [\n    {\n      caption: 'Scale by relative abundance',\n      val: 'count'\n    },\n    {\n      caption: 'Scale across latitudes',\n      val: 'scaled'\n    },\n    {\n      caption: 'Scale within latitude',\n      val: 'density'\n    }\n  ]\n\n  // Main type selector\n  const $div = $('<div>').appendTo($parent)\n  $div.css('margin-left', '35px')\n  const $sel = $('<select>').appendTo($div)\n  $sel.attr('id', 'atlas-lat-phen-data-type')\n  $sel.addClass('selectpicker')\n  //$sel.attr('data-width', '100%')\n  $sel.on('changed.bs.select', function () {\n    if (apparencyByLatData.length) {\n      apparencyByLat(phen3, apparencyByLatData)\n    }\n  })\n\n  dataTypes.forEach(function(t){\n    const $opt = t.selected  ? $('<option>') : $('<option>')\n    $opt.attr('value', t.val)\n    $opt.html(t.caption).appendTo($sel)\n  })\n \n  $sel.val('count')\n\n  // This seems to be necessary if interface regenerated,\n  // e.g. changing from tabbed to non-tabbed display.\n  $sel.selectpicker()\n}\n\nexport function changeEcology(dataRoot, identifier) {\n   \n  if (!identifier) return \n\n  const apparencyRoot = dataRoot + 'bsbi/apparency/'\n  const captionRoot = dataRoot + 'bsbi/captions/'\n  const mapRoot = dataRoot + 'bsbi/20220606/'\n\n  // Apparency all\n  const fileAll = apparencyRoot + 'all/' + identifier.replace(/\\./g, \"_\") + '.csv'\n  d3.csv(fileAll + '?prevent-cache=')\n    .then(function(data) {\n      apparency(phen1, data)\n    })\n    .catch(function() {\n      console.warn(`Apparency chart failed for ${fileAll}. Error message:`, e)\n      phen1.setChartOpts({data: []})\n      // TEMPORARY CODE FOR TESTING so that a file always returned \n      // const fileDefault = apparencyRoot + 'all/dummy.csv'\n      // d3.csv(fileDefault + '?prevent-cache=')\n      //   .then(function(data) {\n      //     apparency(phen1, data)\n      //   })\n    })\n\n  // Apparency by latitude\n  const fileLat = apparencyRoot + 'byLat/' + identifier.replace(/\\./g, \"_\") + '.csv'\n  d3.csv(fileLat + '?prevent-cache=')\n    .then(function(data) {\n      apparencyByLatData = data // Saved so that apparencyByLat if \n                                // data type dropdown used.\n      apparencyByLat(phen3, apparencyByLatData)\n    })\n    .catch(function() {\n      console.warn(`Apparency by latitude chart failed for ${fileLat}. Error message:`, e)\n      phen3.setChartOpts({data: [], metrics: [], spread: false})\n      // TEMPORARY CODE FOR TESTING so that a file always returned \n      // const fileDefault = apparencyRoot + 'byLat/dummy.csv'\n      // d3.csv(fileDefault + '?prevent-cache=')\n      //   .then(function(data) {\n      //     apparencyByLat(phen3, data)\n      //   })\n    })\n\n  // Phenology\n  const file = `${captionRoot}${identifier.replace(/\\./g, \"_\")}.csv`\n\n  d3.csv(file + `?prevent-cache=${pcache}`)\n    .then(function(data) {\n      phenology(phen2, data, 'bsbi-phenology-source')\n    })\n    // .catch(function() {\n    //   console.warn(`Phenology chart failed for ${file}. Error message:`, e)\n    //   phen2.setChartOpts({data: []})\n    // })\n  \n  // Alt/Lat\n\n  // Using raw tetrad mapping data\n  // const tetrads = `${mapRoot}tetrads/${identifier.replace(/\\./g, \"_\")}.csv`\n  // d3.csv(tetrads, function(row) {\n  //   return row.tetrad\n  // }).then(function(data){\n  //   altlat.dataFromTetrads(data).then(function(data) {\n  //     altlat.setChartOpts({data: data })\n  //   })\n  // })\n\n  // Using pre-processed altlat data\n  const altlatdata = `${mapRoot}altlat/${identifier.replace(/\\./g, \"_\")}.csv`\n  d3.csv(altlatdata).then(function(data){\n    return altLat(altlat, data)\n  }).catch(e => {\n    console.warn(`altlat chart failed for ${altlatdata}. Error message:`, e)\n    altlat.setChartOpts({data: []})\n  })\n}\n\n// For Oli's stuff October - reformatted \nexport function apparency(chart, data) {\n  // Map text to numeric values and add taxon\n  const numeric = data.map(d => {\n    return {\n      taxon: 'taxon',\n      week: Number(d.week),\n      n: Number(d.n)\n    }\n  })\n  // Sort it - just in case\n  const sorted = numeric.sort((a,b) => a.week > b.week)\n  // Update the apparency chart\n  return chart.setChartOpts({\n    data: sorted,\n  })\n}\n\nexport function phenology(chart, data, textId) {\n\n  // Chart\n  const m2d = [1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 365]\n\n  const fs = data[0].phenFlowerStart\n  const fe = data[0].phenFlowerEnd\n  const ls = data[0].phenLeafStart\n  const le = data[0].phenLeafEnd\n\n  const flowerStart = m2d[Number(fs)-1]\n  const flowerEnd = m2d[Number(fe)]\n  const leafStart = m2d[Number(ls)-1]\n  const leafEnd = m2d[Number(le)]\n\n  //console.log('ls le', ls, le)\n  \n  // Work out area of overlap between flowering and leafing\n  let flowerRange = []\n  let leafRange = []\n  let overlapRange = []\n  if (flowerStart && flowerEnd) {\n    if (flowerStart > flowerEnd) {\n      flowerRange = [[flowerStart, 365], [1, flowerEnd]]\n    } else {\n      flowerRange = [[flowerStart, flowerEnd]]\n    }\n  }\n  if (leafStart && leafEnd) {\n    if (leafStart > leafEnd) {\n      leafRange = [[leafStart, 365], [1, leafEnd]]\n    } else {\n      leafRange = [[leafStart, leafEnd]]\n    }\n  }\n  // flowerRange.forEach(fr => {\n  //   leafRange.forEach(lr => {\n  //     const fs = fr[0]\n  //     const fe = fr[1]\n  //     const ls = lr[0]\n  //     const le = lr[1]\n  //     let os, oe\n  //     if (fs > ls && fs < le) {\n  //       os = fs\n  //     }\n  //     if (fe > ls && fe < le) {\n  //       oe = fe\n  //     }\n  //     if (os && !oe) {\n  //       oe = le\n  //     }\n  //     if (oe && !os) {\n  //       os = ls\n  //     }\n  //     if (os) {\n  //       overlapRange.push([os, oe])\n  //     }\n  //   })\n  // })\n\n  // console.log('flowerRange', flowerRange)\n  // console.log('leafRange', leafRange)\n  // console.log('overlapRange', overlapRange)\n\n  const svgLeaf=\"m12941 19084-175-112-108 54c-59 30-112 54-117 54s-97-112-203-250l-193-250h-150-151l-177-188c-97-104-186-197-197-207-19-17-23-16-139 49-66 36-124 66-128 65-6 0-219-276-359-464-10-14-30-7-149 53l-138 70-26-32c-15-17-103-124-195-238-92-115-171-208-175-208s-61 25-127 55l-119 55-90-92c-50-51-149-155-220-230l-130-138-112 100c-61 55-115 100-120 100-4 0-123-122-263-269-140-148-260-270-266-270-5-1-65 39-131 88l-122 90-233-207c-129-114-264-233-300-265l-66-58-138 80-139 80-139-147c-77-81-181-189-231-240l-91-94-161 80-160 81-169-201c-93-110-176-209-184-219-15-19-19-18-174 26-87 25-162 42-167 39s-79-90-164-194c-140-171-158-188-178-181-12 5-73 30-134 56-62 26-116 45-121 43-5-1-105-104-222-226-192-202-216-223-239-218-14 3-82 23-151 44l-126 38-249-262c-138-145-252-263-255-263s-45 55-95 124c-49 68-92 121-96 117s-98-138-209-299l-201-292-138 69-139 69-223-336c-123-184-227-339-230-344s-83-20-177-33c-95-12-174-25-176-27s-52-107-111-234c-59-126-111-233-114-237-4-4-62 8-130 27-69 19-125 34-127 32-1-1-57-139-125-307-67-168-124-307-125-309-2-2-69-14-150-27-80-12-147-24-149-26-3-2-30-125-60-273-31-149-58-272-60-274-3-2-68 2-146 8-77 7-144 10-147 6-3-3-16-132-28-286s-23-281-25-283-79-18-171-36l-168-34-2-380-3-381-193-79c-139-57-192-84-192-95 0-9 29-149 65-310s65-295 63-296c-2-2-86-43-188-91s-188-90-192-93 45-170 108-371l114-365-67-65c-38-36-110-104-162-152l-93-86 136-329c75-181 136-332 136-337 0-4-58-90-128-190-71-99-132-187-136-194-6-10 62-142 290-561 15-26 21-48 16-55-5-6-66-82-135-170-70-87-127-162-127-166 0-5 108-183 239-396l240-387-90-99c-49-54-89-102-89-107s111-164 246-353c136-188 253-353 261-365 13-20 10-32-43-149-55-124-56-128-38-143 11-9 182-159 381-334l361-317-5-43c-3-23-13-105-24-182-10-77-16-141-15-143 4-3 510-150 857-248 15-4 13-20-18-141-18-74-32-137-31-139 2-1 138-21 303-42 279-37 309-43 431-86 238-83 552-155 824-188 141-17 699-17 840 0 648 79 1266 287 1860 624 111 64 378 237 494 320 46 34 67 44 62 32-4-11-35-107-68-214-397-1294-750-2359-915-2764-72-178-107-247-165-332-72-104-110-172-148-269-56-142-97-325-73-325 29 0 420 94 429 104 6 6 46 128 89 271 42 143 142 478 222 745 79 267 202 679 273 915 71 237 185 621 255 855s151 506 181 604c30 99 54 185 54 193 0 27 18 12 35-30 31-80 204-397 305-558 282-454 581-807 1323-1564l245-250 114 113c62 61 116 112 120 112s118-122 253-270c136-149 250-270 254-270 3 0 40 68 81 151s78 152 82 155c3 2 122-66 263-152 180-110 259-153 264-145 5 7 18 57 30 112l22 99h515c283 0 514 1 514 3s-20 52-44 112l-44 110 479 3c310 1 479 6 479 12s-14 58-31 116-30 106-28 108c2 1 179 26 392 56 214 30 392 57 398 60 5 4-4 44-21 95-16 49-30 94-30 100 0 7 112 32 288 64 158 29 296 55 307 58 20 4 20 7 9 141-7 75-12 138-11 138 5 5 558 214 564 214 5 0 14 4 21 9 13 8 10 15-74 227-3 5 144 82 326 169 181 88 330 164 330 170s-30 84-66 174c-53 134-63 166-52 176 7 7 105 85 218 175s210 168 217 174c9 8-1 46-42 164-30 84-55 157-55 162s101 91 225 190 225 183 225 186-56 66-124 140l-125 135 194 217c107 119 195 219 194 222 0 3-45 41-100 85-54 44-111 90-125 101l-26 21 145 289c80 159 147 294 148 299 1 6-25 25-57 44-33 18-78 44-101 57l-41 24 124 226c69 124 124 229 122 234-2 4-42 42-90 84l-87 76 28 63c15 34 72 158 126 276l98 214-39 36c-21 20-68 61-103 93l-64 56 136 261c76 144 137 263 137 265 0 3-57 23-127 46-71 24-132 46-136 50-4 3 33 128 82 276s88 270 86 272-45-6-95-18c-51-11-95-19-98-16-5 6-4 13 77 405 28 135 49 246 47 248-1 2-36-11-76-27-39-17-74-30-76-27-2 2 1 111 6 243 5 131 10 284 10 339v100l-87-10c-49-6-89-8-90-5s29 140 66 305 67 301 66 303c-2 2-53-22-114-52-91-46-111-53-111-39 0 10 9 144 20 298s20 297 20 317v37l-72-20c-40-11-81-22-90-25-17-5-18 16-18 350 0 278-3 356-12 356-7 0-53-9-102-20s-91-19-92-17c-1 1-17 106-35 232-18 127-35 233-38 237-3 3-39-7-79-24s-74-29-76-27c-3 2-15 155-27 339s-23 336-25 338c-1 2-45-15-98-39-53-23-99-39-102-36s-17 167-30 364c-12 197-23 359-24 361 0 1-43-32-96-73s-99-75-103-75-26 141-50 313c-23 171-44 319-47 328-4 14-14 14-102-6-53-12-100-20-103-16-4 3-31 143-60 309-30 167-57 309-61 315-4 7-30 0-77-21-39-18-73-32-76-32s-5 149-5 330c0 182-3 330-6 330s-49-29-101-65c-53-36-97-64-98-63-2 2-8 154-15 338-6 184-13 337-15 338-2 2-40-24-85-57-44-34-84-61-89-61-4 0-7 10-5 23 2 12 11 139 19 282s18 291 21 329l6 69-126-5c-114-5-126-4-122 11 8 27 126 657 126 673 0 10-37 25-115 48-104 30-114 35-110 54 3 12 16 71 30 131 102 438 125 539 125 551 0 10-24 14-99 16l-98 3 112 248 113 248-27 10c-14 6-61 22-104 35l-77 25 52 97c28 53 75 142 105 196 29 55 52 100 51 101-2 1-42 17-90 35-49 18-88 38-88 45s11 86 25 175c14 90 24 166 23 170-2 4-81-43-177-106z\"\n  const svgFlower=\"M1048.256,633.499c212.849-356.854,285.555-335.845-191.845-590.438C384.889,283.217,484.493,353.496,664.566,633.499 c-310.065-285.921-239.639-396.021-620.823,0c64.157,504.336,28.591,448.084,502.257,364.911 c-416.078,181.718-421.368,113.233-191.845,590.438c503.843,103.322,428.181,97.12,502.257-364.911 c69.825,407.236,10.978,486.041,502.257,364.911c233.666-457.592,211.268-427.46-191.845-590.438 c452.881,101.063,461.097,199.985,502.257-364.911C1305.872,228.612,1381.606,318.787,1048.256,633.499z M856.411,1100.523 c-114.579,0-207.463-92.884-207.463-207.463s92.884-207.463,207.463-207.463c114.578,0,207.463,92.884,207.463,207.463 S970.989,1100.523,856.411,1100.523z\"\n  \n  // const svgBoth=\"M 10482.56 6334.99 c 2128.49 -3568.54 2855.55 -3358.45 -1918.45 -5904.38 C 3848.89 2832.17 4844.93 3534.96 6645.66 6334.99 c -3100.65 -2859.21 -2396.39 -3960.21 -6208.23 0 c 641.57 5043.36 285.91 4480.84 5022.57 3649.11 c -4160.78 1817.18 -4213.68 1132.33 -1918.45 5904.38 c 5038.43 1033.22 4281.81 971.2 5022.57 -3649.11 c 698.25 4072.36 109.78 4860.41 5022.57 3649.11 c 2336.66 -4575.92 2112.68 -4274.6 -1918.45 -5904.38 c 4528.81 1010.63 4610.97 1999.85 5022.57 -3649.11 C 13058.72 2286.12 13816.06 3187.87 10482.56 6334.99 z M 8564.11 11005.23 c -1145.79 0 -2074.63 -928.84 -2074.63 -2074.63 s 928.84 -2074.63 2074.63 -2074.63 c 1145.78 0 2074.63 928.84 2074.63 2074.63 S 9709.89 11005.23 8564.11 11005.23 z m-2000 7000-175-112-108 54c-59 30-112 54-117 54s-97-112-203-250l-193-250h-150-151l-177-188c-97-104-186-197-197-207-19-17-23-16-139 49-66 36-124 66-128 65-6 0-219-276-359-464-10-14-30-7-149 53l-138 70-26-32c-15-17-103-124-195-238-92-115-171-208-175-208s-61 25-127 55l-119 55-90-92c-50-51-149-155-220-230l-130-138-112 100c-61 55-115 100-120 100-4 0-123-122-263-269-140-148-260-270-266-270-5-1-65 39-131 88l-122 90-233-207c-129-114-264-233-300-265l-66-58-138 80-139 80-139-147c-77-81-181-189-231-240l-91-94-161 80-160 81-169-201c-93-110-176-209-184-219-15-19-19-18-174 26-87 25-162 42-167 39s-79-90-164-194c-140-171-158-188-178-181-12 5-73 30-134 56-62 26-116 45-121 43-5-1-105-104-222-226-192-202-216-223-239-218-14 3-82 23-151 44l-126 38-249-262c-138-145-252-263-255-263s-45 55-95 124c-49 68-92 121-96 117s-98-138-209-299l-201-292-138 69-139 69-223-336c-123-184-227-339-230-344s-83-20-177-33c-95-12-174-25-176-27s-52-107-111-234c-59-126-111-233-114-237-4-4-62 8-130 27-69 19-125 34-127 32-1-1-57-139-125-307-67-168-124-307-125-309-2-2-69-14-150-27-80-12-147-24-149-26-3-2-30-125-60-273-31-149-58-272-60-274-3-2-68 2-146 8-77 7-144 10-147 6-3-3-16-132-28-286s-23-281-25-283-79-18-171-36l-168-34-2-380-3-381-193-79c-139-57-192-84-192-95 0-9 29-149 65-310s65-295 63-296c-2-2-86-43-188-91s-188-90-192-93 45-170 108-371l114-365-67-65c-38-36-110-104-162-152l-93-86 136-329c75-181 136-332 136-337 0-4-58-90-128-190-71-99-132-187-136-194-6-10 62-142 290-561 15-26 21-48 16-55-5-6-66-82-135-170-70-87-127-162-127-166 0-5 108-183 239-396l240-387-90-99c-49-54-89-102-89-107s111-164 246-353c136-188 253-353 261-365 13-20 10-32-43-149-55-124-56-128-38-143 11-9 182-159 381-334l361-317-5-43c-3-23-13-105-24-182-10-77-16-141-15-143 4-3 510-150 857-248 15-4 13-20-18-141-18-74-32-137-31-139 2-1 138-21 303-42 279-37 309-43 431-86 238-83 552-155 824-188 141-17 699-17 840 0 648 79 1266 287 1860 624 111 64 378 237 494 320 46 34 67 44 62 32-4-11-35-107-68-214-397-1294-750-2359-915-2764-72-178-107-247-165-332-72-104-110-172-148-269-56-142-97-325-73-325 29 0 420 94 429 104 6 6 46 128 89 271 42 143 142 478 222 745 79 267 202 679 273 915 71 237 185 621 255 855s151 506 181 604c30 99 54 185 54 193 0 27 18 12 35-30 31-80 204-397 305-558 282-454 581-807 1323-1564l245-250 114 113c62 61 116 112 120 112s118-122 253-270c136-149 250-270 254-270 3 0 40 68 81 151s78 152 82 155c3 2 122-66 263-152 180-110 259-153 264-145 5 7 18 57 30 112l22 99h515c283 0 514 1 514 3s-20 52-44 112l-44 110 479 3c310 1 479 6 479 12s-14 58-31 116-30 106-28 108c2 1 179 26 392 56 214 30 392 57 398 60 5 4-4 44-21 95-16 49-30 94-30 100 0 7 112 32 288 64 158 29 296 55 307 58 20 4 20 7 9 141-7 75-12 138-11 138 5 5 558 214 564 214 5 0 14 4 21 9 13 8 10 15-74 227-3 5 144 82 326 169 181 88 330 164 330 170s-30 84-66 174c-53 134-63 166-52 176 7 7 105 85 218 175s210 168 217 174c9 8-1 46-42 164-30 84-55 157-55 162s101 91 225 190 225 183 225 186-56 66-124 140l-125 135 194 217c107 119 195 219 194 222 0 3-45 41-100 85-54 44-111 90-125 101l-26 21 145 289c80 159 147 294 148 299 1 6-25 25-57 44-33 18-78 44-101 57l-41 24 124 226c69 124 124 229 122 234-2 4-42 42-90 84l-87 76 28 63c15 34 72 158 126 276l98 214-39 36c-21 20-68 61-103 93l-64 56 136 261c76 144 137 263 137 265 0 3-57 23-127 46-71 24-132 46-136 50-4 3 33 128 82 276s88 270 86 272-45-6-95-18c-51-11-95-19-98-16-5 6-4 13 77 405 28 135 49 246 47 248-1 2-36-11-76-27-39-17-74-30-76-27-2 2 1 111 6 243 5 131 10 284 10 339v100l-87-10c-49-6-89-8-90-5s29 140 66 305 67 301 66 303c-2 2-53-22-114-52-91-46-111-53-111-39 0 10 9 144 20 298s20 297 20 317v37l-72-20c-40-11-81-22-90-25-17-5-18 16-18 350 0 278-3 356-12 356-7 0-53-9-102-20s-91-19-92-17c-1 1-17 106-35 232-18 127-35 233-38 237-3 3-39-7-79-24s-74-29-76-27c-3 2-15 155-27 339s-23 336-25 338c-1 2-45-15-98-39-53-23-99-39-102-36s-17 167-30 364c-12 197-23 359-24 361 0 1-43-32-96-73s-99-75-103-75-26 141-50 313c-23 171-44 319-47 328-4 14-14 14-102-6-53-12-100-20-103-16-4 3-31 143-60 309-30 167-57 309-61 315-4 7-30 0-77-21-39-18-73-32-76-32s-5 149-5 330c0 182-3 330-6 330s-49-29-101-65c-53-36-97-64-98-63-2 2-8 154-15 338-6 184-13 337-15 338-2 2-40-24-85-57-44-34-84-61-89-61-4 0-7 10-5 23 2 12 11 139 19 282s18 291 21 329l6 69-126-5c-114-5-126-4-122 11 8 27 126 657 126 673 0 10-37 25-115 48-104 30-114 35-110 54 3 12 16 71 30 131 102 438 125 539 125 551 0 10-24 14-99 16l-98 3 112 248 113 248-27 10c-14 6-61 22-104 35l-77 25 52 97c28 53 75 142 105 196 29 55 52 100 51 101-2 1-42 17-90 35-49 18-88 38-88 45s11 86 25 175c14 90 24 166 23 170-2 4-81-43-177-106z\"\n  \n  // Source\n  if (textId) {\n    const flowerText = tweakRef(data[0].phenFlowerRef)\n    const leafText = tweakRef(data[0].phenLeafRef)\n\n    let source\n    if (flowerRange.length) {\n      source = `Data for flower phenology from ${flowerText}.`\n    }\n    if (flowerRange.length && leafRange.length) {\n      source = `${source}</br>`\n    }\n    if (leafRange.length) {\n      source = `${source}Data for leafing phenology from ${leafText}.`\n    }\n    $(`#${textId}`).html(source)\n  }\n\n  // '#009900' '#ff9900'\n  const metrics = []\n  let iMetric = 0\n  if (flowerRange.length) {\n    metrics.push({ prop: 'flower', label: 'Flowering', colour: '#fc8d62', svg: svgFlower, legendOrder: ++iMetric })\n  }\n  if (leafRange.length) {\n    metrics.push({ prop: 'leaf', label: 'In leaf', colour: '#66c2a5', svg: svgLeaf, legendOrder: ++iMetric })\n  }\n  // if (overlapRange.length) {\n  //   metrics.push({ prop: 'both', label: 'In leaf & flowering', colour: '#8da0cb', svg: svgBoth , svgScale: 1.4, legendOrder: 3})\n  // }\n \n  return chart.setChartOpts({\n    data: [\n      {\n        taxon: 'taxon',\n        leaf: leafRange.map(r => {return {start: r[0], end: r[1]}}),\n        flower: flowerRange.map(r => {return {start: r[0], end: r[1]}}),\n        //both: overlapRange.map(r => {return {start: r[0], end: r[1]}}),\n      }\n    ],\n    metrics: metrics\n  })\n\n  function tweakRef(ref) {\n    const $tmp = $('<div>')\n    $tmp.html(ref)\n\n    // Replace 'Poland, J. personal observation' with 'John Poland, personal observation'\n    const $span1 = $tmp.children('span').eq(0)\n    const $span2 = $tmp.children('span').eq(1)\n    if ($span1 && $span1 \n      && $span1.text() === 'Poland, J.'\n      && $span2.text() === 'personal observation') {\n      $span1.text('John Poland,')\n    }\n\n    return $tmp.html()\n  }\n}\n\nexport function apparencyByLat(chart, data) {\n  // Map text to numeric values and add taxon\n  const dataType = $('#atlas-lat-phen-data-type').val()\n  //console.log('dataType', dataType)\n\n  const numeric = data.filter(d => d.type === dataType).map(d => {\n    const nd = {taxon: 'taxon'}\n    Object.keys(d).forEach(function(k){\n      nd[k] = Number(d[k])\n    })\n    return nd\n  })\n\n  //const latitudes = Object.keys(data[0]).filter(f => f.length === 2)\n  const latitudes = ['50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60']\n  const metrics = latitudes.map(l => {\n    return {prop: l, label: l, colour: 'green', fill: '#ddffdd' }\n  })\n\n  // Sort it - just in case\n  const sorted = numeric.sort((a,b) => a.week > b.week)\n  // Update the apparency chart\n  return chart.setChartOpts({\n    data: sorted,\n    metrics: metrics,\n    spread: true\n  })\n}\n\nexport function altLat(chart, data) {\n  const mdata = data.map(function(r) {\n    return {\n      distance: Number(r.distance),\n      altitude: Number(r.altitude),\n      metric: Number(r.percent),\n      taxon: 'dummy'\n    }\n  })\n  return chart.setChartOpts({data: mdata })\n}","import { pcache } from './gen'\n\nconst $ = jQuery // eslint-disable-line no-undef\nconst ds = drupalSettings // eslint-disable-line no-undef\n\nexport function createGallery(id, ddbid) {\n\n  // DO I NEED TO HAVE SEPARATE FUNCTIONS FOR CREATE AND UPDATED GALLERY\n  // FOR CONSISTENCY ON MAIN.JS?\n\n  document.getElementById(id).innerHTML = ''\n  if (ddbid) {\n\n    // Images are listed in the caption file, so fetch it\n    const captionRoot = ds.bsbi_atlas.dataRoot + 'bsbi/captions/'\n    const captionFile = `${captionRoot}${ddbid.replace(/\\./g, \"_\")}.csv?prevent-cache=${pcache}`\n    \n    d3.csv(captionFile)\n      .then(function(d) {\n        // Filter out empty image strings\n        const dynamicEl = d[0].images.split(';').filter(i => i).map(img => {\n          //console.log(img.replace('{PIXELSIZE}', '192'))\n          return {\n            src: img.replace('{PIXELSIZE}', '1920'),\n            thumb: img.replace('{PIXELSIZE}', '192'),\n            subHtml: `\n              <div class=\"lightGallery-captions\">\n                <div style=\"background-color: black; opacity: 0.7\">\n                <p style=\"margin: 0.3em\">Copyright Rob Still/Chris Gibson</p>\n                <div>\n              </div>`\n          }\n        })\n\n        //console.log(dynamicEl)\n\n        const lgContainer = document.getElementById(id)\n        \n        if (dynamicEl.length) {\n          \n          // After https://www.lightgalleryjs.com/demos/inline/ & https://codepen.io/sachinchoolur/pen/zYZqaGm\n          const inlineGallery = lightGallery(lgContainer, { // eslint-disable-line no-undef\n            container: lgContainer,\n            dynamic: true,\n            // Turn off hash plugin in case if you are using it\n            // as we don't want to change the url on slide change\n            hash: false,\n            // Do not allow users to close the gallery\n            closable: false,\n            // Hide download button\n            download: false,\n            // Add maximize icon to enlarge the gallery\n            showMaximizeIcon: true,\n            // Append caption inside the slide item\n            // to apply some animation for the captions (Optional)\n            appendSubHtmlTo: '.lg-item',\n            // Delay slide transition to complete captions animations\n            // before navigating to different slides (Optional)\n            // You can find caption animation demo on the captions demo page\n            slideDelay: 400,\n            plugins: [lgZoom, lgThumbnail], // eslint-disable-line no-undef\n            dynamicEl: dynamicEl,\n            thumbWidth: 90,\n            thumbHeight: \"60px\",\n            thumbMargin: 4\n          })\n          // Since we are using dynamic mode, we need to programmatically open lightGallery\n          setTimeout(() => {\n            inlineGallery.openGallery()\n            $('#bsbi-gallery-copyright').show()\n          }, 200)\n        } else {\n          lgContainer.innerHTML = `<i>No images are available for this taxon.</i>`\n          $('#bsbi-gallery-copyright').hide()\n        }\n      })\n  }\n}","export function copyToClipboard(textToCopy) {\n  // https://stackoverflow.com/questions/51805395/navigator-clipboard-is-undefined\n  // navigator clipboard api needs a secure context (https)\n  // return a promise\n  if (navigator.clipboard && window.isSecureContext) {\n    // navigator clipboard api method'\n    return navigator.clipboard.writeText(textToCopy)\n  } else {\n    // text area method\n    let textArea = document.createElement(\"textarea\")\n    textArea.value = textToCopy\n    // make the textarea out of viewport\n    textArea.style.position = \"fixed\"\n    textArea.style.left = \"-999999px\"\n    textArea.style.top = \"-999999px\"\n    document.body.appendChild(textArea)\n    textArea.focus()\n    textArea.select()\n    return new Promise((res, rej) => {\n        // here the magic happens\n        document.execCommand('copy') ? res() : rej()\n        textArea.remove()\n    })\n  }\n}\n\nexport function setCookie(cname, cvalue, exdays) {\n  const d = new Date()\n  d.setTime(d.getTime() + (exdays*24*60*60*1000))\n  const expires = \"expires=\"+ d.toUTCString()\n  document.cookie = cname + \"=\" + cvalue + \";\" + expires + \";path=/\"\n}\n  \nexport function getCookie(cname) {\n  const name = cname + \"=\"\n  const decodedCookie = decodeURIComponent(document.cookie)\n  const ca = decodedCookie.split(';')\n  for(let i = 0; i <ca.length; i++) {\n    let c = ca[i]\n    while (c.charAt(0) == ' ') {\n      c = c.substring(1)\n    }\n    if (c.indexOf(name) == 0) {\n      return c.substring(name.length, c.length)\n    }\n  }\n  return \"\"\n}\n\nexport function getCitation(currentTaxon, forImageDownload) {\n  if (forImageDownload) {\n    return `<i>${currentTaxon.shortName.replace(/\\s/g, '</i> <i>')}</i> in <i>BSBI</i> <i>Online</i> <i>Atlas</i> <i>2020</i>, eds P.A. Stroh, T. A. Humphrey, R.J. Burkmar, O.L. Pescott, D.B. Roy, & K.J. Walker. ${location.origin}/atlas/${currentTaxon.identifier} [Accessed ${new Date().toLocaleDateString('en-GB')}]`\n  } else {\n    return `<i>${currentTaxon.shortName}</i> in <i>BSBI Online Plant Atlas 2020</i>, eds P.A. Stroh, T. A. Humphrey, R.J. Burkmar, O.L. Pescott, D.B. Roy, & K.J. Walker. ${location.origin}/atlas/${currentTaxon.identifier} [Accessed ${new Date().toLocaleDateString('en-GB')}]`\n  }\n}","import { bsbiDataAccess } from './dataAccessAtlas'\nimport { setCookie, getCookie, getCitation} from './utils'\n\nconst $ = jQuery // eslint-disable-line no-undef\nconst ds = drupalSettings // eslint-disable-line no-undef\n\nlet currentTaxon \nlet gridStyle = getCookie('gridstyle') ? getCookie('gridstyle') : 'solid'\nlet backdrop = getCookie('backdrop') ? getCookie('backdrop') : 'colour_elevation'\nlet slippyMap, staticMap\nlet mapType = 'allclass'\nlet insetType = getCookie('inset') ? getCookie('inset') : 'BI4'\nlet boundaryType = getCookie('boundaries') ? getCookie('boundaries') : 'none'\nlet showStatus = false\nlet displayedMapType = 'static'\nlet resolution = 'hectad'\nlet atlasRangeIndex = 5\nlet atlasTrendIndex = 2\nconst slippyLegendOpts = {\n  display: true,\n  scale: 0.8,\n  x: 10,\n  y: 0,\n  data: null\n}\nconst svgLegendOpts = {\n  display: true,\n  scale: 1,\n  x: 10,\n  y: 5,\n  data: null\n}\nconst periods = [\n  {\n    min: '',\n    max: 1929,\n    access: 'status_29',\n    caption: '1929 and before'\n  },\n  {\n    min: 1930,\n    max: 1969,\n    access: 'status_30_69',\n    caption: '1930–1969'\n  },\n  {\n    min: 1970,\n    max: 1986,\n    access: 'status_70_86',\n    caption: '1970–1986'\n  },\n  {\n    min: 1987,\n    max: 1999,\n    access: 'status_87_99',\n    caption: '1987–1999'\n  },\n  {\n    min: 2000,\n    max: 2019,\n    access: 'status_00_19',\n    caption: '2000–2019'\n  }\n]\nconst trends = [\n  {\n    lower: '1930–69',\n    upper: '2000–19',\n    access: 'change_1930_1969_vs_2000_2019',\n    caption: '1930–69 vs 2000–19'\n  },\n  {\n    lower: '1987–99',\n    upper: '2000–19',\n    access: 'change_1987_1999_vs_2000_2019',\n    caption: '1987–99 vs 2000–19'\n  }\n]\n\nfunction mapControlRow(selector, classname) {\n  const $div =  $('<div>').appendTo($(selector))\n  $div.addClass('atlas-map-control-row')\n  if (classname) {\n    $div.addClass(classname)\n  }\n  return $div\n}\n\nexport function setControlState() {\n\n  // map display\n  if (displayedMapType === \"static\") {\n    $('#slippyAtlasMain').hide()\n    $('#staticAtlasMain').show()\n  } else {\n    $('#staticAtlasMain').hide()\n    $('#slippyAtlasMain').show()\n  }\n\n  // save map image button\n  if (displayedMapType === 'static') {\n    $('.atlas-save-map-image').show()\n  } else {\n    $('.atlas-save-map-image').hide()\n  }\n\n  // download map data button\n  $('.atlas-download-map-data').show()\n  if (mapType === 'allclass' && resolution === 'hectad') {\n    $('.atlas-download-map-data input, .atlas-download-map-data button').attr('disabled', false)\n  } else {\n    $('.atlas-download-map-data input, .atlas-download-map-data button').attr('disabled', true)\n  }\n\n  // backdrop selector\n  if (displayedMapType === \"static\") {\n    $('.atlas-backdrop-selector').show()\n  } else {\n    $('.atlas-backdrop-selector').hide()\n  }\n\n  // inset control\n  if (displayedMapType === \"static\") {\n    $('.atlas-inset-control').show()\n  } else {\n    $('.atlas-inset-control').hide()\n  }\n\n  // grid type control\n  if (displayedMapType === \"static\") {\n    $('.atlas-grid-type-control').show()\n  } else {\n    $('.atlas-grid-type-control').hide()\n  }\n\n  // boundary type control\n  // if (displayedMapType === \"static\") {\n  //   $('.atlas-boundaries-control').show()\n  // } else {\n  //   $('.atlas-boundaries-control').hide()\n  // }\n\n  // period slider visibility\n  if (mapType === 'status') {\n    $('.atlas-period-slider-control').show()\n  } else {\n    $('.atlas-period-slider-control').hide()\n  }\n\n  // trend slider control\n  if (mapType === 'trends') {\n    $('.atlas-trend-slider-control').show()\n  } else {\n    $('.atlas-trend-slider-control').hide()\n  }\n\n  // show status checkbox\n  if (mapType === 'allclass' || mapType === 'slippy') {\n    $('.atlas-status-checkbox-control').show()\n  } else {\n    $('.atlas-status-checkbox-control').hide()\n  }\n\n  // show opacity slider\n  if (displayedMapType === 'slippy') {\n    $('.atlas-opacity-slider-control').show()\n  } else {\n    $('.atlas-opacity-slider-control').hide()\n  }\n\n  // status checkbox enabled and checked value\n  const disableStatus = bsbiDataAccess.taxaNoStatusList.indexOf(currentTaxon.identifier) > -1 || currentTaxon.isHybrid\n  const isHybrid = currentTaxon.hybridMapping\n\n  if (disableStatus || isHybrid) {\n    showStatus = false\n    bsbiDataAccess.showStatus = false\n    $('.atlas-status-checkbox-control span').text('No status info for this taxon')\n    $('.atlas-status-checkbox-control span').css('color', 'silver')\n  } else {\n    $('.atlas-status-checkbox-control span').text('Show status')\n    $('.atlas-status-checkbox-control span').css('color', 'black')\n  }\n  if (disableStatus || isHybrid || (displayedMapType === 'slippy' && mapType === 'allclass' && resolution !== 'hectad')) {\n    // Uncheck and disable status checkbutton if not hectad resolution or no status info\n    $('.atlas-status-checkbox').prop('checked', false)\n    $('.atlas-status-checkbox').attr('disabled', true)\n  } else {\n    // Display and set checked status to current value of showStatus global\n    $('.atlas-status-checkbox').attr('disabled', false)\n    $('.atlas-status-checkbox').prop('checked', showStatus)\n  }\n\n  // atlas resolution control visibility\n  if (displayedMapType === \"slippy\" && mapType === 'allclass') {\n    $('.atlas-resolution-control').show()\n  } else {\n    $('.atlas-resolution-control').hide()\n  }\n\n  // atlas resolution control value and global variables\n  if (displayedMapType === \"slippy\" && mapType === 'allclass') {\n    // Reset resolution if currently set to a value that is not\n    // appropriate for the taxon\n    // if (resolution === 'tetrad' && !currentTaxon.tetrad) {\n    //   resolution = 'hectad'\n    // }\n    bsbiDataAccess.resolution = resolution\n\n    // Ensure right option is selected\n    $('.bsbi-resolution-' + resolution).prop('checked', true)\n\n    // Enable/disable tetrad option as appropriate\n    // if (currentTaxon.tetrad) {\n    //   $('.bsbi-resolution-tetrad').attr('disabled', false)\n    // } else {\n    //   $('.bsbi-resolution-tetrad').attr('disabled', true)\n    // }\n  } else {\n    bsbiDataAccess.resolution = 'hectad'\n  }\n\n  // Enable/disable the hybrid map type option as appropriate\n  const $hybridopts = $('.atlas-map-type-selector option[value=\"hybrid\"]') \n  if (isHybrid) {\n    $hybridopts.show()\n  } else {\n    $hybridopts.hide()\n    // Select another option if currently selected\n    if (mapType === 'hybrid') {\n      $hybridopts.prop('selected', false)\n      $('.atlas-map-type-selector option[value=\"allclass\"]').prop('selected', true)\n      mapType='allclass'\n    }\n  }\n  $('.atlas-map-type-selector').selectpicker('refresh')\n}\n\nfunction gridStyleSelector($parent) {\n\n  const gridStyles = [\n    {\n      caption: 'Solid grid lines',\n      val: 'solid'\n    },\n    {\n      caption: 'Dashed grid lines',\n      val: 'dashed'\n    },\n    {\n      caption: 'No grid lines',\n      val: 'none'\n    }\n  ]\n\n  // Main type selector\n  const $sel = $('<select>').appendTo($parent)\n  $sel.addClass('selectpicker')\n  $sel.addClass('atlas-grid-type-control')\n  $sel.attr('data-width', '100%')\n  $sel.on('changed.bs.select', function () {\n\n    gridStyle = $(this).val()\n    setCookie('gridstyle', gridStyle, 30)\n    staticMap.setGridLineStyle(gridStyle)\n  })\n\n  gridStyles.forEach(function(s){\n    const $opt = s.selected  ? $('<option>') : $('<option>')\n    $opt.attr('value', s.val)\n    $opt.html(s.caption).appendTo($sel)\n  })\n \n  $sel.val(gridStyle)\n\n  // This seems to be necessary if interface regenerated,\n  // e.g. changing from tabbed to non-tabbed display.\n  $sel.selectpicker()\n}\n\n// function gridStyleRadios($parent, i) {\n//   // Overall control container\n//   const $container = $('<div>').appendTo($parent)\n\n//   function makeRadio(label, val, checked) {\n//     //$('<div class=\"radio\"><label><input type=\"radio\" name=\"atlas-grid-type\" value=\"'+ val + '\" ' + checked + '>' + label + '</label></div>').appendTo($container)\n  \n//     const $div = $('<div>').appendTo($container)\n//     $div.attr('class', 'radio')\n//     const $label = $('<label>').appendTo($div)\n//     $label.css('padding-left', '0')\n//     const $radio = $('<input>').appendTo($label)\n//     const $span = $('<span>').appendTo($label)\n//     $span.text(label)\n//     $span.css('padding-left', '20px')\n//     $radio.attr('type', 'radio')\n//     $radio.attr('name', 'atlas-grid-type-' + i)\n//     $radio.attr('class', 'atlas-grid-type-' + val)\n//     $radio.attr('value', val)\n//     $radio.css('margin-left', 0)\n//     if (checked) $radio.prop('checked', true)\n\n//     $radio.change(function () {\n//       gridStyle = $(this).val()\n//       setCookie('gridstyle', gridStyle, 30)\n//       staticMap.setGridLineStyle(gridStyle)\n//       // Update controls mirrored in other blocks\n//       $('.atlas-grid-type-' + val).prop(\"checked\", true)\n//     })\n//   }\n//   makeRadio('Solid grid lines', 'solid', gridStyle === 'solid' ? 'checked' : '')\n//   makeRadio('Dashed grid lines', 'dashed', gridStyle === 'dashed' ? 'checked' : '')\n//   makeRadio('No grid lines', 'none', gridStyle === 'none' ? 'checked' : '')\n// }\n\nfunction boundarySelector($parent) {\n\n  const boundaries = [\n    {\n      caption: 'Country boundaries',\n      val: 'country'\n    },\n    {\n      caption: 'Vice county boundaries',\n      val: 'vc'\n    },\n    {\n      caption: 'No boundaries',\n      val: 'none'\n    }\n  ]\n\n  // Main type selector\n  const $sel = $('<select>').appendTo($parent)\n  $sel.addClass('selectpicker')\n  $sel.addClass('atlas-boundaries-control')\n  $sel.attr('data-width', '100%')\n  $sel.on('changed.bs.select', function () {\n\n    boundaryType = $(this).val()\n    setCookie('boundaries', boundaryType, 30)\n\n    if (boundaryType === 'none') {\n      staticMap.setVcLineStyle('none')\n      staticMap.setCountryLineStyle('none')\n      staticMap.setBoundaryColour('#7C7CD3')\n      slippyMap.setShowVcs(false)\n      slippyMap.setShowCountries(false)\n    } else if (boundaryType === 'vc') {\n      staticMap.setVcLineStyle('')\n      staticMap.setCountryLineStyle('none')\n      staticMap.setBoundaryColour('white')\n      slippyMap.setShowVcs(true)\n      slippyMap.setShowCountries(false)\n    } else if (boundaryType === 'country') {\n      staticMap.setVcLineStyle('none')\n      staticMap.setCountryLineStyle('')\n      staticMap.setBoundaryColour('white')\n      slippyMap.setShowVcs(false)\n      slippyMap.setShowCountries(true)\n    }\n  })\n\n  boundaries.forEach(function(b){\n    const $opt = b.selected  ? $('<option>') : $('<option>')\n    $opt.attr('value', b.val)\n    $opt.html(b.caption).appendTo($sel)\n  })\n \n  $sel.val(boundaryType)\n\n  // This seems to be necessary if interface regenerated,\n  // e.g. changing from tabbed to non-tabbed display.\n  $sel.selectpicker()\n}\n\nfunction mapInterfaceToggle($parent) {\n\n  const $container = $('<div style=\"display: flex\">').appendTo($parent)\n\n  // Buttons\n  const $bgrp = $('<div class=\"btn-group\" data-toggle=\"buttons\">').appendTo($container)\n\n  const $staticLabel = $('<label class=\"btn btn-primary active\">').appendTo($bgrp)\n  $('<input type=\"radio\" name=\"mapType\" value=\"static\" checked>').appendTo($staticLabel)\n  $staticLabel.append(\"Overview\")\n\n  const $slippyLabel = $('<label class=\"btn btn-primary\">').appendTo($bgrp)\n  $('<input type=\"radio\" name=\"mapType\" value=\"slippy\">').appendTo($slippyLabel)\n  $slippyLabel.append(\"Zoomable\")\n\n  // Busy indicator\n  const $loader = $('<div id=\"atlas-loader\" style=\"display: none\">').appendTo($container) \n  $('<div class=\"atlas-loader\">').appendTo($loader)\n\n  $('input[type=radio][name=\"mapType\"]').change(function() {\n    displayedMapType = $(this).val()\n    bsbiDataAccess.displayedMapType = displayedMapType\n\n    if (displayedMapType === \"slippy\") {\n      // Get current width of static map\n      const $svg = $('#staticAtlasMain svg')\n      const w = $svg.width()\n      const h = $svg.height()\n      slippyMap.setSize(w, h)\n    }\n    setControlState()\n    changeMap()\n\n    if (displayedMapType === \"slippy\") {\n      slippyMap.invalidateSize()\n    }\n  })\n}\n\nfunction mapTypeSelector($parent) {\n\n  // Main type selector\n  const $sel = $('<select>').appendTo($parent)\n  $sel.addClass('selectpicker')\n  $sel.addClass('atlas-map-type-selector')\n  $sel.attr('data-width', '100%')\n  $sel.on('changed.bs.select', function () {\n    mapType = $(this).val()\n    setControlState()\n    changeMap()\n  })\n  const types = [\n    {\n      caption: 'Distribution overview',\n      val: 'allclass'\n    },\n    {\n      caption: 'Distribution by year range',\n      val: 'status'\n    },\n    {\n      caption: 'Change maps',\n      val: 'trends'\n    },\n    {\n      caption: 'Tetrad frequency',\n      val: 'tetrad'\n    },\n    {\n      caption: 'Map hybrid with parents',\n      val: 'hybrid'\n    },\n  ]\n  types.forEach(function(t){\n    const $opt = $('<option>')\n    $opt.attr('value', t.val)\n    $opt.html(t.caption).appendTo($sel)\n  })\n\n  // This seems to be necessary if interface regenerated,\n  // e.g. changing from tabbed to non-tabbed display.\n  $sel.selectpicker()\n}\n\nfunction backdropSelector($parent) {\n\n  const rasterRoot = ds.bsbi_atlas.dataRoot + 'rasters/'\n\n  // Backdrops\n  const backdrops = [\n    {\n      caption: 'No backdrop',\n      val: 'none'\n    },\n    {\n      caption: 'Colour elevation',\n      val: 'colour_elevation'\n    },\n    {\n      caption: 'Grey elevation',\n      val: 'grey_elevation_300'\n    },\n  ]\n\n  // Main type selector\n  const $sel = $('<select>').appendTo($parent)\n  $sel.addClass('selectpicker')\n  //$sel.addClass('atlas-backdrop-selector')\n  $sel.attr('data-width', '100%')\n  $sel.on('changed.bs.select', function () {\n    // Remove all backdrops\n    backdrops.forEach(function(b){\n      if (b.val !== 'none') {\n        staticMap.basemapImage(b.val, false, rasterRoot + b.val + '.png', rasterRoot + b.val + '.pgw')\n      }\n    })\n    // Display selected backdrop\n    backdrop = $(this).val()\n    setCookie('backdrop', backdrop, 30)\n    if (backdrop !== 'none') {\n      staticMap.basemapImage(backdrop, true, rasterRoot + backdrop + '.png', rasterRoot + backdrop + '.pgw')\n    }\n  })\n  backdrops.forEach(function(b){\n    const $opt = $('<option>')\n    $opt.attr('value', b.val)\n    $opt.html(b.caption).appendTo($sel)\n  })\n  $sel.val(backdrop)\n  if (backdrop !== 'none') {\n    staticMap.basemapImage(backdrop, true, rasterRoot + `${backdrop}.png`, rasterRoot + `${backdrop}.pgw`)\n  }\n\n  // This seems to be necessary if interface regenerated,\n  // e.g. changing from tabbed to non-tabbed display.\n  $sel.selectpicker()\n}\n\nfunction mapImageButton($parent, i) {\n\n  let imageType = 'png'\n\n  // Overall control container\n  const $container = $('<div>').appendTo($parent)\n  $container.addClass('atlas-save-map-image')\n  $container.hide()\n\n  const $svg = $('<svg>').appendTo($container)\n  const $t = $('<text>').appendTo($svg)\n  $t.attr('x', '10')\n  $t.attr('y', '20')\n  $('<br>').appendTo($container)\n\n  const $button = $('<button>').appendTo($container)\n  $button.addClass('btn btn-default')\n  $button.text('Download image')\n  $button.on('click', function(){\n    const info = {\n      text: getCitation(currentTaxon, true),\n      margin: 10,\n      fontSize: 10,\n      //img: `${ds.bsbi_atlas.dataRoot}combined-logos.png`\n    }\n    staticMap.saveMap(imageType === 'svg', info, 'atlas-image')\n  })\n\n  makeRadio('PNG', 'png', true)\n  makeRadio('SVG', 'svg', false)\n\n  function makeRadio(label, val, checked) {\n\n    const $div = $('<div>').appendTo($container)\n    $div.css('display', 'inline-block')\n    $div.css('margin-left', '0.5em')\n    $div.attr('class', 'radio')\n    const $label = $('<label>').appendTo($div)\n    $label.css('padding-left', '0')\n    const $radio = $('<input>').appendTo($label)\n    const $span = $('<span>').appendTo($label)\n    $span.text(label)\n    $span.css('padding-left', '20px')\n    $radio.attr('type', 'radio')\n    $radio.attr('name', 'img-download-type-' + i)\n    $radio.attr('class', 'img-download-type-' + val)\n    $radio.attr('value', val)\n    $radio.css('margin-left', 0)\n    if (checked) $radio.prop('checked', true)\n\n    $radio.change(function () {\n      // Update controls mirrored in other blocks\n      $('.img-download-type-' + val).prop(\"checked\", true)\n      imageType = val\n    })\n  }\n}\n\nfunction mapDownloadButton($parent, i) {\n\n  let downloadType = 'csv'\n\n  // Overall control container\n  const $container = $('<div>').appendTo($parent)\n  $container.addClass('atlas-download-map-data')\n  $container.hide()\n\n  const $button = $('<button>').appendTo($container)\n  $button.addClass('btn btn-default')\n  $button.text('Download data')\n  $button.on('click', function(){\n    let displayedMap\n    if (displayedMapType === 'static') {\n      displayedMap = staticMap\n    } else {\n      displayedMap = slippyMap\n    }\n    displayedMap.downloadData(downloadType === 'geojson')\n  })\n\n  makeRadio('CSV', 'csv', true)\n  makeRadio('GJson', 'geojson', false)\n\n  function makeRadio(label, val, checked) {\n\n    const $div = $('<div>').appendTo($container)\n    $div.css('display', 'inline-block')\n    $div.css('margin-left', '0.5em')\n    $div.attr('class', 'radio')\n    const $label = $('<label>').appendTo($div)\n    $label.css('padding-left', '0')\n    const $radio = $('<input>').appendTo($label)\n    const $span = $('<span>').appendTo($label)\n    $span.text(label)\n    $span.css('padding-left', '20px')\n    $radio.attr('type', 'radio')\n    $radio.attr('name', 'download-type-' + i)\n    $radio.attr('class', 'download-type-' + val)\n    $radio.attr('value', val)\n    $radio.css('margin-left', 0)\n    if (checked) $radio.prop('checked', true)\n\n    $radio.change(function () {\n      // Update controls mirrored in other blocks\n      $('.download-type-' + val).prop(\"checked\", true)\n      downloadType = val\n    })\n  }\n}\n\nfunction opacitySlider($parent) {\n\n  const initOpacity = 70\n  $('#atlas-leaflet-svg').css('opacity', initOpacity/100)\n  \n  // Overall control container\n  const $container = $('<div>').appendTo($parent)\n  $container.addClass('atlas-opacity-slider-control')\n  $container.hide()\n\n  // Label\n  const $sliderLabel = $('<div>').appendTo($container)\n  $sliderLabel.addClass('atlas-opacity-slider-label')\n  $sliderLabel.text('Opacity:')\n\n  // Slider\n  const $sliderContainer = $('<div>').appendTo($container)\n  $sliderContainer.addClass('slidecontainer')\n  $sliderContainer.addClass('atlas-opacity-slider-slider')\n  const $slider = $('<input>').appendTo($sliderContainer)\n  $slider.addClass('slider')\n  $slider.attr('type', 'range').attr('min', '1').attr('max', '100').attr('value', initOpacity).attr('id', 'atlas-opacity-slider')\n  $slider.change(function() {\n    $('#atlas-leaflet-svg').css('opacity', $(this).val()/100)\n  })\n}\n\nfunction statusCheckbox($parent) {\n  // Overall control container\n  const $container = $('<div>').appendTo($parent)\n  $container.addClass('atlas-status-checkbox-control')\n\n  // Status on/off toggle\n  const $checDiv = $('<div class=\"checkbox\">').appendTo($container)\n  //$checDiv.css('margin-top', '4.3em')\n\n  $('<label><input type=\"checkbox\" class=\"atlas-status-checkbox\"/><span>Show status</span></label>').appendTo($checDiv)\n\n  $('.atlas-status-checkbox').change(function() {\n    showStatus = $(this).is(':checked')\n    bsbiDataAccess.showStatus = showStatus\n    changeMap()\n  })\n}\n\nfunction statusControl($parent) {\n  \n  // Overall control container\n  const $container = $('<div>').appendTo($parent)\n  $container.addClass('atlas-period-slider-control')\n  $container.hide()\n\n  // Period display\n  // const $indicator = $('<div>').appendTo($container)\n  // $indicator.css('font-size', '1.5em')\n  // $indicator.css('margin-bottom', '0.2em')\n  // $indicator.text(periods[periods.length - 1].caption)\n\n  // Slider\n  const $sliderContainer = $('<div>').appendTo($container)\n  $sliderContainer.addClass('slidecontainer')\n  const $slider = $('<input>').appendTo($sliderContainer)\n  $slider.addClass('slider')\n  $slider.attr('type', 'range').attr('min', '1').attr('max', periods.length).attr('id', 'atlas-range-select')\n  $slider.change(function() {\n    atlasRangeIndex = $(this).val()\n    changeMap()\n  })\n\n  const $scaleContainer = $('<div>').appendTo($sliderContainer)\n  $scaleContainer.addClass('atlas-range-tick-container')\n  $scaleContainer.css('margin-bottom', '4.3em')\n  periods.forEach(function(p, i){\n    const $tick = $('<span>').appendTo($scaleContainer)\n    $tick.addClass('atlas-range-tick')\n    const percent = i/(periods.length - 1)*100\n    $tick.css('left',  percent.toString() + '%')\n    $tick.text('|')\n    $tick.append('<br>')\n    const $tickText = $('<span>').appendTo($tick)\n    $tickText.addClass('atlas-range-tick-text')\n    $tickText.html((p.min ? p.min : 'pre') + '<br>' + (p.max === 1929 ? 1930 : p.max))\n    //$tickText.html(p.min + '<br>' + p.max)\n  })\n\n  // // Status on/off toggle\n  // const $checDiv = $('<div class=\"checkbox\">').appendTo($container)\n  // $checDiv.css('margin-top', '4.3em')\n\n  // $('<label><input type=\"checkbox\" id=\"atlas-status-checkbox\">Show status</label>').appendTo($checDiv)\n\n  // $('#atlas-status-checkbox').change(function() {\n  //   showStatus = $(this).is(':checked')\n  //   bsbiDataAccess.showStatus = showStatus\n  //   changeMap()\n  // })\n}\n\nfunction resolutionControl($parent, i) {\n  // Overall control container\n  const $container = $('<div>').appendTo($parent)\n\n  function makeRadio(label, val, checked) {\n    const $div = $('<div>').appendTo($container)\n    $div.attr('class', 'radio')\n    const $radio = $('<input>').appendTo($div)\n    $radio.attr('type', 'radio')\n    $radio.attr('name', 'bsbi-resolution-' + i)\n    $radio.attr('class', 'bsbi-resolution-' + val)\n    $radio.attr('value', val)\n    $radio.css('margin-left', 0)\n    if (checked) $radio.prop('checked', true)\n    const $label = $('<label>').appendTo($div)\n    $label.attr('for', 'bsbi-resolution-' + val)\n    $label.text(label)\n\n    $radio.change(function () {\n\n      resolution = $(this).val()\n  \n      // Update controls mirrored in other blocks\n      $('.bsbi-resolution-' + resolution).prop(\"checked\", true)\n      setControlState()\n      changeMap()\n    })\n  }\n  makeRadio('Hectads', 'hectad', true)\n  makeRadio('Tetrads', 'tetrad', false)\n  //makeRadio('Monads', 'monad', false)\n}\n\nfunction trendControl($parent) {\n  // Overall control container\n  const $container = $('<div>').appendTo($parent)\n  $container.addClass('atlas-trend-slider-control')\n  $container.hide()\n\n  // Trend display\n  // const $indicator = $('<div>').appendTo($container)\n  // $indicator.css('font-size', '1.5em')\n  // $indicator.css('margin-bottom', '0.2em')\n  // $indicator.text(trends[trends.length - 1].caption)\n\n  // Slider\n  const $sliderContainer = $('<div>').appendTo($container)\n  $sliderContainer.addClass('slidecontainer')\n  $sliderContainer.addClass('atlas-trend-select-container')\n  const $slider = $('<input>').appendTo($sliderContainer)\n  $slider.addClass('slider')\n  $slider.attr('type', 'range').attr('min', '1').attr('max', trends.length).addClass('atlas-trend-select')\n  $slider.change(function() {\n    atlasTrendIndex = $(this).val()\n    changeMap()\n  })\n\n  const $scaleContainer = $('<div>').appendTo($sliderContainer)\n  $scaleContainer.addClass('atlas-trend-tick-container')\n  trends.forEach(function(p, i){\n    const $tick = $('<span>').appendTo($scaleContainer)\n    $tick.addClass('atlas-trend-tick')\n    const percent = i/(trends.length - 1)*100\n    $tick.css('left',  percent.toString() + '%')\n    $tick.text('|')\n    $tick.append('<br>')\n    const $tickText = $('<span>').appendTo($tick)\n    $tickText.addClass('atlas-trend-tick-text')\n    $tickText.addClass('atlas-trend-tick-text-' + i)\n    $tickText.html(p.lower + '<br>v.<br>' + p.upper)\n  })\n\n  $container.css('margin-bottom', '5.3em')\n\n}\n\nfunction insetSelector($parent) {\n\n  const inserts = [\n    {\n      caption: 'No insets',\n      val: 'BI1'\n    },\n    {\n      caption: 'Channel Isles inset',\n      val: 'BI2'\n    },\n    {\n      caption: 'Northern and Channel Isles inset',\n      val: 'BI4'\n    },\n  ]\n\n  // Main type selector\n  const $sel = $('<select>').appendTo($parent)\n  $sel.addClass('selectpicker')\n  $sel.addClass('atlas-inset-control')\n  \n  //$sel.addClass('atlas-backdrop-selector')\n  $sel.attr('data-width', '100%')\n  $sel.on('changed.bs.select', function () {\n\n    insetType = $(this).val()\n    staticMap.setTransform(insetType)\n    setCookie('inset', insetType, 30)\n    changeMap()\n  })\n\n  inserts.forEach(function(i){\n    const $opt = i.selected  ? $('<option>') : $('<option>')\n    $opt.attr('value', i.val)\n    $opt.html(i.caption).appendTo($sel)\n  })\n\n  $sel.val(insetType)\n\n  // This seems to be necessary if interface regenerated,\n  // e.g. changing from tabbed to non-tabbed display.\n  $sel.selectpicker()\n}\n\nfunction insetRadios($parent, i) { \n  \n  // Overall control container\n  const $container = $('<div>').appendTo($parent)\n  //$container.attr('id', 'atlas-inset-control')\n\n  function makeRadio(label, val, checked) {\n    const $div = $('<div>').appendTo($container)\n    $div.attr('class', 'radio')\n    const $label = $('<label>').appendTo($div)\n    $label.css('padding-left', '0')\n    const $radio = $('<input>').appendTo($label)\n    const $span = $('<span>').appendTo($label)\n    $span.text(label)\n    $span.css('padding-left', '20px')\n    $radio.attr('type', 'radio')\n    $radio.attr('name', 'bsbi-inset-type-' + i)\n    $radio.attr('class', 'bsbi-inset-type-' + val)\n    $radio.attr('value', val)\n    $radio.css('margin-left', 0)\n    if (checked) $radio.prop('checked', true)\n\n    $radio.change(function () {\n      insetType = $(this).val()\n\n      // Update controls mirrored in other blocks\n      $('.bsbi-inset-type-' + insetType).prop(\"checked\", true)\n\n      staticMap.setTransform(insetType)\n      setCookie('inset', insetType, 30)\n      changeMap()\n    })\n  }\n  const selectedInset = getCookie('inset') ? getCookie('inset') : insetType\n  makeRadio('No insets', 'BI1', selectedInset === 'BI1' ? 'checked' : '')\n  makeRadio('Channel Isles inset', 'BI2', selectedInset === 'BI2' ? 'checked' : '')\n  makeRadio('Northern and Channel Isles inset', 'BI4', selectedInset === 'BI4' ? 'checked' : '')\n}\n\nexport function mapSetCurrentTaxon(taxon) {\n  currentTaxon = taxon\n}\n\nexport function createMaps(selector) {\n\n  // Modify standard UK opts to remove any without CI\n  const transOptsSel =  JSON.parse(JSON.stringify(brcatlas.namedTransOpts))\n  delete transOptsSel.BI3 // Remove the options without CI\n\n  // Modify insets to go further west in order\n  // to give more room for legends.\n  transOptsSel.BI4.bounds.xmin = -240000,  //Northern Isles\n  transOptsSel.BI1.bounds.xmin = -230000,  //No insets\n  transOptsSel.BI2.bounds.xmin = -230000,  //CI inset\n\n  // Init\n  bsbiDataAccess.bsbiDataRoot = ds.bsbi_atlas.dataRoot + 'bsbi/20220606/'\n  bsbiDataAccess.showStatus = false\n\n  // Data access \n  const mapTypesSel = {\n    'status_29': bsbiDataAccess.status_29,\n    'status_30_69': bsbiDataAccess.status_30_69,\n    'status_70_86': bsbiDataAccess.status_70_86,\n    'status_87_99': bsbiDataAccess.status_87_99,\n    'status_00_19': bsbiDataAccess.status_00_19,\n    'Tetrad frequency': bsbiDataAccess.bsbiHectadDateTetFreq,\n    'change_1987_1999_vs_2000_2019': bsbiDataAccess.change_1987_1999_vs_2000_2019,\n    'change_1930_1969_vs_2000_2019': bsbiDataAccess.change_1930_1969_vs_2000_2019,\n    'distAllClasses': bsbiDataAccess.distAllClasses,\n    'hybrid': bsbiDataAccess.hybrid\n  }\n\n  // Basemaps\n  const basemapConfigs = [\n    {\n      name: 'Open Street Map',\n      type: 'tileLayer',\n      selected: true,\n      url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n      opts: {\n        maxZoom: 19,\n        attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n      }\n    },\n    {\n      name: 'Stamen Black & White',\n      type: 'tileLayer',\n      selected: false,\n      url: 'https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.{ext}',\n      opts: {\n        attribution: 'Map tiles by <a href=\"http://stamen.com\">Stamen Design</a>, <a href=\"http://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a> &mdash; Map data &copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors',\n        subdomains: 'abcd',\n        minZoom: 0,\n        maxZoom: 20,\n        ext: 'png'\n      }\n    },\n    {\n      name: 'Open Topo Map',\n      type: 'tileLayer',\n      selected: false,\n      url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',\n      opts: {\n        maxZoom: 17,\n        attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors, <a href=\"http://viewfinderpanoramas.org\">SRTM</a> | Map style: &copy; <a href=\"https://opentopomap.org\">OpenTopoMap</a> (<a href=\"https://creativecommons.org/licenses/by-sa/3.0/\">CC-BY-SA</a>)'\n      }\n    },\n    {\n      name: 'GEBCO 2020 Elevation',\n      type: 'wms',\n      selected: false,\n      url: 'https://www.gebco.net/data_and_products/gebco_web_services/2020/mapserv?',\n      opts: {\n        layers: 'GEBCO_2020_Grid_2',\n        maxZoom: 17,\n        attribution: 'Imagery reproduced from the GEBCO_2020 Grid, GEBCO Compilation Group (2020) GEBCO 2020 Grid (doi:10.5285/a29c5465-b138-234d-e053-6c86abc040b9)'\n      }\n    },\n    {\n      name: 'Copernicus elevation aspect',\n      type: 'wms',\n      selected: false,\n      url: 'https://copernicus.discomap.eea.europa.eu/arcgis/services/Elevation/Aspect/MapServer/WMSServer?',\n      opts: {\n        layers: 'image',\n        maxZoom: 17,\n        attribution: '&copy; European Commission'\n      }\n    }\n  ]\n\n  // Map height\n  const height = 650\n  // Create the static map\n  staticMap = brcatlas.svgMap({\n    selector: selector,\n    mapid: \"staticAtlasMain\",\n    captionId: \"dotCaption\",\n    height: height,\n    expand: true,\n    legendOpts: svgLegendOpts,\n    transOptsKey: getCookie('inset') ? getCookie('inset') : insetType,\n    transOptsSel: transOptsSel,\n    mapTypesKey: 'status_10_19',\n    mapTypesSel: mapTypesSel,\n    mapTypesControl: false,\n    transOptsControl: false,\n    seaFill: 'white',\n    gridLineColour: '#7C7CD3',\n    gridLineStyle: gridStyle,\n    boundaryColour: '#7C7CD3',\n    vcColour: '#7C7CD3',\n    vcLineStyle: boundaryType === 'vc' ? '' : 'none',\n    countryColour: '#7C7CD3',\n    countryLineStyle: boundaryType === 'country' ? '' : 'none'\n  })\n\n  const rasterRoot = ds.bsbi_atlas.dataRoot + 'rasters/'\n  //staticMap.basemapImage('colour_elevation', true, rasterRoot + 'colour_elevation.png', rasterRoot + 'colour_elevation.pgw')\n\n  // Callbacks for slippy maps\n  function startLoad() {\n    document.getElementById('atlas-loader').style.display = 'inline-block'\n    //develStartMapTiming(\"download\")\n  }\n  function endLoad() {\n    document.getElementById('atlas-loader').style.display = 'none'\n    //develStopMapTiming(\"download\")\n  }\n  function startDraw() {\n    document.getElementById('atlas-loader').style.display = 'inline-block'\n    //develStartMapTiming(\"display\")\n  }\n  function endDraw() {\n    document.getElementById('atlas-loader').style.display = 'none'\n    //develStopMapTiming(\"display\")\n  }\n\n  // Create the slippy map\n  slippyMap = brcatlas.leafletMap({\n    selector: selector,\n    mapid: 'slippyAtlasMain',\n    height: height,\n    width: staticMap.getMapWidth(),\n    captionId: \"dotCaption\",\n    mapTypesKey: 'status_10_19',\n    mapTypesSel: mapTypesSel,\n    legendOpts: slippyLegendOpts,\n    basemapConfigs: basemapConfigs,\n    callbacks: [startDraw, endDraw, startLoad, endLoad],\n    showVcs: boundaryType === 'vc',\n    showCountries: boundaryType === 'country'\n  })\n  $('#slippyAtlasMain').hide()\n}\n\nexport function changeMap(retPromise) {\n\n  let displayedMap\n  if (displayedMapType === 'static') {\n    displayedMap = staticMap\n  } else {\n    displayedMap = slippyMap\n  }\n\n  if (mapType === 'status') {\n    const access = periods[atlasRangeIndex-1].access\n    displayedMap.setMapType(access)\n  } else if (mapType === 'allclass') {\n    displayedMap.setMapType('distAllClasses')\n  } else if (mapType === 'trends') {\n    const access = trends[atlasTrendIndex-1].access\n    displayedMap.setMapType(access)\n  } else if (mapType === 'tetrad') {\n    displayedMap.setMapType('Tetrad frequency')\n  } else if (mapType === 'hybrid') {\n    displayedMap.setMapType('hybrid')\n  }\n\n  // To try to keep the legend around the same apparent size when\n  // actual map size changes due to inset change, we set a scale\n  // factor to apply to the legend depending on what inset value\n  // is specified.\n  svgLegendOpts.scale=0.9\n  if (insetType == 'BI1') {\n    svgLegendOpts.scale = svgLegendOpts.scale * 0.77\n  }\n  if (insetType == 'BI2') {\n    svgLegendOpts.scale = svgLegendOpts.scale * 0.85\n  }\n  staticMap.setLegendOpts(svgLegendOpts)\n\n  if (currentTaxon.identifier) {\n    displayedMap.setIdentfier(currentTaxon.identifier)\n\n    if (retPromise) {\n      return displayedMap.redrawMap()\n    } else {\n      displayedMap.redrawMap().catch(e => {\n        console.warn(`Unable to generate map for ${currentTaxon.shortName} (${currentTaxon.identifier}). Error message:`, e)\n        displayedMap.clearMap()\n      })\n    }\n  }\n\n  // Initialise dot caption\n  $('#dotCaption').html(bsbiDataAccess.dotCaption)\n}\n\nexport function createMapControls(selector) {\n\n  mapInterfaceToggle(mapControlRow(selector))\n  mapTypeSelector(mapControlRow(selector))\n  statusControl(mapControlRow(selector))\n  statusCheckbox(mapControlRow(selector))\n  trendControl(mapControlRow(selector))\n  backdropSelector(mapControlRow(selector, 'atlas-backdrop-selector'))\n  insetSelector(mapControlRow(selector))\n  gridStyleSelector(mapControlRow(selector))\n  boundarySelector(mapControlRow(selector))\n\n  opacitySlider(mapControlRow(selector))\n\n  $(selector).each(function(i) {\n    // We loop through the selection so that we can use the\n    // index value to differentiate the equivalent controls\n    // from different blocks. This is vital for radio controls\n    // otherwise value can only be selected in one block and\n    // therefore initialisation may be wrong.\n    let sel = 'bsbi-atlas-map-controls-' + i\n    const $div = $('<div>').appendTo($(this))\n    $div.addClass(sel)\n    sel = '.' + sel\n    // Potentially we can also use this to ensure that selection\n    // in one block is mirrored in the other. This is only important\n    // if user might switch between blocks during use - but this\n    // is very unlikely. (But nevertheless has been implemented\n    // for the radio buttons below.)\n    //insetRadios(mapControlRow(sel,'atlas-inset-control'), i)\n    //gridStyleRadios(mapControlRow(sel, 'atlas-grid-type-control'), i)\n    resolutionControl(mapControlRow(sel, 'atlas-resolution-control'), i)\n    mapImageButton(mapControlRow(sel, 'atlas-image-button'), i)\n    mapDownloadButton(mapControlRow(sel, 'atlas-download-button'), i)\n  })\n}\n\nexport function updateBsbiDataAccess(key, value) {\n  bsbiDataAccess[key]=value\n}\n\nexport function getStaticMap() {\n  return staticMap\n}\n\n// export function setMapType(type) {\n//   mapType = type\n// }","let t1\nconst $ = jQuery // eslint-disable-line no-undef\nimport { bsbiDataAccess } from './dataAccessAtlas'\n\nexport function develTrendSummary(selector, changeSwatchColour) {\n  // Colours\n  const $colours = $('<div style=\"margin-top: 1em\">').appendTo($(selector))\n\n  // No trend swatch base colour\n  const $divTrendSwatch = $('<div>').appendTo($colours)\n  $('<input type=\"text\" style=\"width: 120px\" id=\"trendSwatchColour\">').appendTo($divTrendSwatch)\n  $('<label for=\"trendSwatchColour\" style=\"margin-left: 1em\">Trend summary colour</label>').appendTo($divTrendSwatch)\n  const trendSwatchColour = new JSColor('#trendSwatchColour', {onChange: colourChange})\n  trendSwatchColour.fromString('rgb(0,255,255)')\n\n  function colourChange() {\n    changeSwatchColour(trendSwatchColour.toRGBString())\n  }\n}\n\nexport function develChangeMapColours(selector, changeMap) {\n\n  // Colours\n  const $colours = $('<div style=\"margin-top: 1em\">').appendTo($(selector))\n\n  // No change colour\n  const $divNoChange = $('<div>').appendTo($colours)\n  $('<input type=\"text\" style=\"width: 120px\" id=\"noChangeColour\">').appendTo($divNoChange)\n  $('<label for=\"noChangeColour\" style=\"margin-left: 1em\">Change map - no change colour</label>').appendTo($divNoChange)\n  const noChangeColour = new JSColor('#noChangeColour', {onChange: colourChange})\n  noChangeColour.fromString(bsbiDataAccess.changeColours[0])\n\n  // Gain colour\n  const $divGain = $('<div>').appendTo($colours)\n  $('<input type=\"text\" style=\"width: 120px\" id=\"gainColour\">').appendTo($divGain)\n  $('<label for=\"gainColour\" style=\"margin-left: 1em\">Change map - gain colour</label>').appendTo($divGain)\n  const gainColour = new JSColor('#gainColour', {onChange: colourChange})\n  gainColour.fromString(bsbiDataAccess.changeColours[1])\n\n  // Loss colour\n  const $divLoss = $('<div>').appendTo($colours)\n  $('<input type=\"text\" style=\"width: 120px\" id=\"lossColour\">').appendTo($divLoss)\n  $('<label for=\"lossColour\" style=\"margin-left: 1em\">Change map - loss colour</label>').appendTo($divLoss)\n  const lossColour = new JSColor('#lossColour', {onChange: colourChange})\n  lossColour.fromString(bsbiDataAccess.changeColours[2])\n\n  function colourChange() {\n    bsbiDataAccess.changeColours[0]=noChangeColour.toHEXString()\n    bsbiDataAccess.changeColours[1]=gainColour.toHEXString()\n    bsbiDataAccess.changeColours[2]=lossColour.toHEXString()\n    changeMap()\n  }\n}\n\nexport function develMainMapStyles(selector, changeMap) {\n\n  if ($(selector).length === 0) return\n\n  const labels = {\n    '2000_19': '2000 - 2019',\n    '1987_99': '1987 - 1999',\n    '1970_86': '1970 - 1986',\n    '1930_69': '1930 - 1969',\n    'pre_1930': 'to 1929'\n  }\n\n  const pickers = {\n    x: {\n      '2000_19': null,\n      '1987_99': null,\n      '1970_86': null,\n      '1930_69': null,\n      'pre_1930': null\n    },\n    n: {\n      '2000_19': null,\n      '1987_99': null,\n      '1970_86': null,\n      '1930_69': null,\n      'pre_1930': null\n    },\n    a: {\n      '2000_19': null,\n      '1987_99': null,\n      '1970_86': null,\n      '1930_69': null,\n      'pre_1930': null\n    }\n  }\n\n  const checkboxes = {\n    x: {\n      '2000_19': null,\n      '1987_99': null,\n      '1970_86': null,\n      '1930_69': null,\n      'pre_1930': null\n    },\n    n: {\n      '2000_19': null,\n      '1987_99': null,\n      '1970_86': null,\n      '1930_69': null,\n      'pre_1930': null\n    },\n    a: {\n      '2000_19': null,\n      '1987_99': null,\n      '1970_86': null,\n      '1930_69': null,\n      'pre_1930': null\n    }\n  }\n\n  const colorbrewer = {\n    'sequential single hue Greys': ['#f7f7f7','#cccccc','#969696','#636363','#252525'],\n    'sequential single hue Greens': ['#edf8e9','#bae4b3','#74c476','#31a354','#006d2c'],\n    'sequential single hue Blues': ['#eff3ff','#bdd7e7','#6baed6','#3182bd','#08519c'],\n    'sequential single hue Oranges': ['#feedde','#fdbe85','#fd8d3c','#e6550d','#a63603'],\n    'sequential single hue Purples': ['#f2f0f7','#cbc9e2','#9e9ac8','#756bb1','#54278f'],\n    'sequential single hue Reds': ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15'],\n    'sequential multi-hue BuGn': ['#edf8fb','#b2e2e2','#66c2a4','#2ca25f','#006d2c'],\n    'sequential multi-hue BuPu': ['#edf8fb','#b3cde3','#8c96c6','#8856a7','#810f7c'],\n    'sequential multi-hue GnBu': ['#f0f9e8','#bae4bc','#7bccc4','#43a2ca','#0868ac'],\n    'sequential multi-hue OrRd': ['#fef0d9','#fdcc8a','#fc8d59','#e34a33','#b30000'],\n    'sequential multi-hue PuBu': ['#f1eef6','#bdc9e1','#74a9cf','#2b8cbe','#045a8d'],\n    'sequential multi-hue PuBuGn': ['#f6eff7','#bdc9e1','#67a9cf','#1c9099','#016c59'],\n    'sequential multi-hue PuRd': ['#f1eef6','#d7b5d8','#df65b0','#dd1c77','#980043'],\n    'sequential multi-hue RdPu': ['#feebe2','#fbb4b9','#f768a1','#c51b8a','#7a0177'],\n    'sequential multi-hue YlGn': ['#ffffcc','#c2e699','#78c679','#31a354','#006837'],\n    'sequential multi-hue YlGnBu': ['#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494'],\n    'sequential multi-hue YlOrBr': ['#ffffd4','#fed98e','#fe9929','#d95f0e','#993404'],\n    'sequential multi-hue YlOrRd': ['#ffffb2','#fecc5c','#fd8d3c','#f03b20','#bd0026'],\n    'diverging BrBG': ['#a6611a','#dfc27d','#f5f5f5','#80cdc1','#018571'],\n    'diverging PiYG': ['#d01c8b','#f1b6da','#f7f7f7','#b8e186','#4dac26'],\n    'diverging PRGn': ['#7b3294','#c2a5cf','#f7f7f7','#a6dba0','#008837'],\n    'diverging PuOr': ['#e66101','#fdb863','#f7f7f7','#b2abd2','#5e3c99'],\n    'diverging RdBu': ['#ca0020','#f4a582','#f7f7f7','#92c5de','#0571b0'],\n    'diverging RdGy': ['#ca0020','#f4a582','#ffffff','#bababa','#404040'],\n    'diverging RdYlBu': ['#d7191c','#fdae61','#ffffbf','#abd9e9','#2c7bb6'],\n    'diverging RdYlGn': ['#d7191c','#fdae61','#ffffbf','#a6d96a','#1a9641'],\n    'diverging Spectral': ['#d7191c','#fdae61','#ffffbf','#abdda4','#2b83ba']\n  }\n\n  let colStroke\n\n  // Colours\n  const $colours = $('<div style=\"margin-top: 1em\">').appendTo($(selector))\n\n\n  const $div0 =  $('<div style=\"display: flex\">').appendTo($colours)\n  const $div1 =  $('<div style=\"flex: 1\">').appendTo($div0)\n  const $div2 =  $('<div style=\"flex: 1\">').appendTo($div0)\n  const $div3 =  $('<div style=\"flex: 1\">').appendTo($div0)\n\n  $('<h4>').appendTo($div1).text('Without status')\n  makeColourPicker('x', '2000_19', $div1)\n  makeColourPicker('x', '1987_99', $div1)\n  makeColourPicker('x', '1970_86', $div1)\n  makeColourPicker('x', '1930_69', $div1)\n  makeColourPicker('x', 'pre_1930', $div1)\n\n  $('<h4>').appendTo($div2).text('Native status')\n  makeColourPicker('n', '2000_19', $div2)\n  makeColourPicker('n', '1987_99', $div2)\n  makeColourPicker('n', '1970_86', $div2)\n  makeColourPicker('n', '1930_69', $div2)\n  makeColourPicker('n', 'pre_1930', $div2)\n\n  $('<h4>').appendTo($div3).text('Alien status')\n  makeColourPicker('a', '2000_19', $div3)\n  makeColourPicker('a', '1987_99', $div3)\n  makeColourPicker('a', '1970_86', $div3)\n  makeColourPicker('a', '1930_69', $div3)\n  makeColourPicker('a', 'pre_1930', $div3)\n\n  $('<h4>').appendTo($colours).text('Borders')\n  makeStrokeColourPicker($colours)\n\n  $('<h4>').appendTo($colours).text('Init colours from Colourbrewer')\n  const $sel =  $('<select>').appendTo($colours)\n  Object.keys(colorbrewer).forEach(cs => {\n    $('<option>').text(cs).appendTo($sel)\n  })\n\n  const $cb = $(`<input type=\"checkbox\" id=\"reverse-colours\" style=\"margin:0.5em\">`).appendTo($colours)\n  $(`<label for=\"reverse-colours\">reverse</label>`).appendTo($colours)\n\n  const $butNoStatus = $('<button style=\"margin-left: 0.5em\">').text('Without status').appendTo($colours)\n  const $butNative = $('<button style=\"margin-left: 0.5em\">').text('Native').appendTo($colours)\n  const $butAlien = $('<button style=\"margin-left: 0.5em\">').text('Alien').appendTo($colours)\n\n  $butNoStatus.click(function() {initColours('x', $sel.find(\":selected\").text(), $cb.is(':checked'))})\n  $butNative.click(function() {initColours('n', $sel.find(\":selected\").text(), $cb.is(':checked'))})\n  $butAlien.click(function() {initColours('a', $sel.find(\":selected\").text(), $cb.is(':checked'))})\n  \n  function makeColourPicker(status, period, $container) {\n\n    const $div = $('<div>').appendTo($container)\n    $(`<input type=\"text\" style=\"width: 120px\" id=\"colour${period}_${status}\">`).appendTo($div)\n    const $cb = $(`<input type=\"checkbox\" id=\"stroke${period}_${status}\" style=\"margin-left: 1em\">`).appendTo($div)\n    $(`<label for=\"colour${period}_${status}\" style=\"margin-left: 1em\">${period.replace('_', '-')}</label>`).appendTo($div)\n    const col = new JSColor(`#colour${period}_${status}`)\n\n    col.option({onChange: function() {colourChange(col, $cb, status, period)}})\n    $cb.change(function() {colourChange(col, $cb, status, period)})\n\n    col.fromString(bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses][status][labels[period]])\n    $cb.prop('checked', bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses][status][labels[period]] !== '')\n\n    pickers[status][labels[period]]=col\n    checkboxes[status][labels[period]]=$cb\n  }\n\n  function makeStrokeColourPicker($container) {\n\n    const $div = $('<div>').appendTo($container)\n    $(`<input type=\"text\" style=\"width: 120px\" id=\"colour_stroke\">`).appendTo($div)\n    $(`<label for=\"colour_stroke\" style=\"margin-left: 1em\">Border colour</label>`).appendTo($div)\n    colStroke = new JSColor(`#colour_stroke`)\n    colStroke.fromString('#000000')\n\n    const status = ['x','n','a']\n    const period =  ['2000_19','1987_99','1970_86','1930_69','pre_1930']\n\n    colStroke.option({onChange: function() {\n      status.forEach(s => {\n        period.forEach(p => {\n          const $cb = checkboxes[s][labels[p]]\n          bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses][s][labels[p]] = $cb.is(':checked') ? colStroke.toHEXString() : null\n        })\n      })\n      changeMap()\n    }})\n  }\n\n  function colourChange(col, $cb, status, period) {\n\n    //console.log('checkbox', $cb.is(':checked'))\n    //console.log('colour', col.toHEXString())\n    //console.log('period', period)\n\n    bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses][status][labels[period]] = col.toHEXString()\n    bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses][status][labels[period]] = $cb.is(':checked') ? colStroke.toHEXString() : null\n\n    // The 'prior 1970' style always matches '1930 - 1969' style\n    if (period === '1930_69') {\n      bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses][status]['prior 1970'] = col.toHEXString()\n      bsbiDataAccess.periodStroke[bsbiDataAccess.periodClasses][status]['prior 1970'] = $cb.is(':checked') ? colStroke.toHEXString() : null\n    }\n\n    changeMap()\n  }\n\n  function initColours(status, key, reverse) {\n    console.log('init', status, key)\n    const colours = colorbrewer[key]\n  \n    let periods = ['2000_19', '1987_99', '1970_86', '1930_69', 'pre_1930'].reverse()\n    if (reverse) {\n      periods.reverse()\n    }\n    periods[bsbiDataAccess.periodClasses].forEach((period,i) => {\n      bsbiDataAccess.periodColours[bsbiDataAccess.periodClasses][status][labels[period]] = colours[i]\n      pickers[status][labels[period]].fromString(colours[i])\n    })\n    changeMap()\n  }\n}\n\nexport function develTabsOnOff(selector, changeMap, mainAtlasContent) {\n  // Tabs on/off\n  const $bgrp = $('<div class=\"btn-group\" data-toggle=\"buttons\">').appendTo($(selector))\n  const $onLabel = $('<label class=\"btn btn-primary\">').appendTo($bgrp)\n  $('<input type=\"radio\" name=\"tabsToggle\" value=\"on\">').appendTo($onLabel)\n  $onLabel.append(\"Show tabs\")\n  const $offLabel = $('<label class=\"btn btn-primary active\">').appendTo($bgrp)\n  $('<input type=\"radio\" name=\"tabsToggle\" value=\"off\" checked>').appendTo($offLabel)\n  $offLabel.append(\"No tabs\")\n\n  $('input[type=radio][name=\"tabsToggle\"]').change(function() {\n    mainAtlasContent($(this).val() === \"on\")\n    changeMap()\n  })\n}\n\nexport function develMappingPerformance($parent, changeMap, bsbiDataAccess) {\n\n  const $container = $('<div id=\"slippy-dev\" style=\"padding: 0.5em; background-color: yellow\">').appendTo($parent)\n\n  const $title = $('<div>').appendTo($container)\n  $title.html('<b>Testing tetrad styles &amp; performance</b>')\n  \n  const $radios = $('<div style=\"margin-top: 0.5em\">').appendTo($container)\n  $('<input type=\"radio\" name=\"symboltype\" value=\"circle\" id=\"symb-poly-circle\">').appendTo($radios)\n  $('<label for=\"symb-poly-circle\" style=\"font-weight: 500\">').html('&nbsp;Polygon circles').appendTo($radios)\n  \n  $('<br/><input type=\"radio\" name=\"symboltype\" value=\"square\" id=\"symb-poly-square\">').appendTo($radios)\n  $('<label for=\"symb-poly-square\" style=\"font-weight: 500\">').html('&nbsp;Polygon squares').appendTo($radios)\n\n  $('<br/><input type=\"radio\" name=\"symboltype\" value=\"circlerad\" id=\"symb-circle\">').appendTo($radios)\n  $('<label for=\"symb-circle\" style=\"font-weight: 500\">').html('&nbsp;SVG Circles').appendTo($radios)\n\n  $('#symb-poly-circle').prop( \"checked\", true )\n\n  $('input[name=\"symboltype\"]').on(\"change\", function() {\n    bsbiDataAccess.devel.symboltype=$('input[name=\"symboltype\"]:checked').val()\n    changeMap()\n  })\n\n  $('<div id=\"dev-download-time\">').appendTo($container)\n  $('<div id=\"dev-display-time\">').appendTo($container)\n}\n\nexport function develStartMapTiming(id) {\n  t1 = Math.floor(Date.now() / 100)\n  document.getElementById(`dev-${id}-time`).innerHTML= `${id} data...`\n}\n\nexport function develStopMapTiming(id) {\n  const t2 = Math.floor(Date.now() / 100)\n  document.getElementById(`dev-${id}-time`).innerHTML= `${id} took <b>${String((t2-t1)/10)}</b> seconds`\n}","const $ = jQuery // eslint-disable-line no-undef\n\nexport function updateTrendSummary(id, d, rgbColourString) {\n\n  const baseColour = rgbColourString.substring(0,rgbColourString.length-1).replace('rgb', 'rgba')\n\n  $(`#${id}_decline_strong`).css('background-color', `${baseColour},${Number(d.declineStrong)/100})`)\n  $(`#${id}_decline_mod`).css('background-color', `${baseColour},${Number(d.declineMod)/100})`)\n  $(`#${id}_stable`).css('background-color', `${baseColour},${Number(d.stable)/100})`)\n  $(`#${id}_increase_mod`).css('background-color', `${baseColour},${Number(d.increaseMod)/100})`)\n  $(`#${id}_increase_strong`).css('background-color', `${baseColour},${Number(d.increaseStrong)/100})`)\n}\n\nexport function trendSummary(id) {\n\n  const $divParent = $('<div>')\n  $divParent.attr('id', id)\n\n  // Graphic\n  const maxWidth = '160px'\n  const $tg = $('<div>').appendTo($divParent)\n  $tg.css('display', 'flex')\n  $tg.css('font-weight', 'bold')\n  $tg.css('max-width', maxWidth)\n\n  tgSwatch('--', 'Strong decline', `${id}_decline_strong`)\n  tgSwatch('-', 'Moderate decline', `${id}_decline_mod`)\n  tgSwatch('0', 'Stable', `${id}_stable`)\n  tgSwatch('+', 'Moderate decline', `${id}_increase_mod`)\n  tgSwatch('++', 'Strong decline', `${id}_increase_strong`)\n\n  const $tgt = $('<div>').appendTo($divParent)\n  $tgt.css('display', 'flex')\n  $tgt.css('font-size', '0.8em')\n  $tgt.css('margin-bottom', '1em')\n  $tgt.css('max-width', maxWidth)\n\n  const $tgt1 = $('<div>').appendTo($tgt)\n  $tgt1.css('flex', '2')\n  $tgt1.css('text-align', 'center')\n  $tgt1.text('decrease <<')\n\n  const $tgt2 = $('<div>').appendTo($tgt)\n  $tgt2.css('flex', '1')\n\n  const $tgt3 = $('<div>').appendTo($tgt)\n  $tgt3.css('flex', '2')\n  $tgt3.css('text-align', 'center')\n  $tgt3.text(' >> increase')\n\n  return $divParent\n\n  function tgSwatch(text, tip, id) {\n    const $tgs = $('<div>').appendTo($tg)\n    $tgs.attr('id', id)\n    $tgs.css('flex', '1')\n    $tgs.css('height', '30px')\n    $tgs.css('text-align', 'center')\n    $tgs.css('line-height', '30px')\n    $tgs.css('vertical-align', 'middle')\n    $tgs.css('border-left', '1px solid silver')\n    $tgs.css('border-top', '1px solid silver')\n    $tgs.css('border-bottom', '1px solid silver')\n    if (text === '++') {\n      $tgs.css('border-right', '1px solid silver')\n    }\n    $tgs.text(text)\n    $tgs.prop('title', tip)\n  }\n}\n\nexport function updateTrendSummary2(id, d, rgbColourString) {\n\n  setColour(`${id}_decline_strong`, d.declineStrong)\n  setColour(`${id}_decline_mod`, d.declineMod)\n  setColour(`${id}_stable`, d.stable)\n  setColour(`${id}_increase_mod`, d.increaseMod)\n  setColour(`${id}_increase_strong`, d.increaseStrong)\n\n  function setColour(id, val) {\n\n    const baseColour = rgbColourString.substring(0,rgbColourString.length-1).replace('rgb', 'rgba')\n    const grey = 220 - Math.floor((val/100) * 220)\n\n    d3.select(`#${id}`).attr('fill', `${baseColour},${Number(val)/100})`)\n    d3.select(`#${id}-path`).attr('fill', `rgb(${grey},${grey},${grey})`)\n  }\n\n}\n\nexport function trendSummary2(id) {\n\n  const svgArrow = `M 2250 7256 l 0 -2813 l -61 -7 c -34 -3 -526 -6 -1093 -6 l -1031 -1 l 66 -62 c 36 -34 756 -714 1600 -1512 c 844 -797 1820 -1719 2169 -2049 c 349 -329 667 -630 705 -668 l 70 -68 l 230 217 c 1454 1373 3719 3512 4012 3790 l 373 353 l -1090 0 l -1090 0 l 0 2820 l 0 2820 l -2430 0 l -2430 0 l 0 -2814 z`\n  const svgSquare = `M 5 3968 c -3 -7 -4 -897 -3 -1978 l 3 -1965 l 2080 0 l 2080 0 l 0 1975 l 0 1975 l -2078 3 c -1657 2 -2079 0 -2082 -10 z`\n  const ss = 25\n  const sr = 22\n\n  const swatches = [\n    {\n      svg: svgArrow,\n      scale: 0.6,\n      rot: 180,\n      text: `Strong decline`,\n      id: `${id}_decline_strong`,\n      da: [ss * 4]\n    },\n    {\n      svg: svgArrow,\n      scale: 0.4,\n      rot: 180,\n      text: `Moderate decline`,\n      id: `${id}_decline_mod`,\n      da: [ss*3, ss]\n    },\n    {\n      svg: svgSquare,\n      scale: 0.2,\n      rot: 45,\n      text: 'Stable',\n      id: `${id}_stable`,\n      da: [ss*3, ss]\n    },\n    {\n      svg: svgArrow,\n      scale: 0.4,\n      rot: 0,\n      text: `Moderate increase`,\n      id: `${id}_increase_mod`,\n      da: [ss*3, ss]\n    },\n    {\n      svg: svgArrow,\n      scale: 0.6,\n      rot: 0,\n      text: `Strong increase`,\n      id: `${id}_increase_strong`,\n      da: [ss*3, ss]\n    }\n  ]\n  \n  // Graphic\n  const divParent = d3.select(`#${id}`)\n  const svg = divParent.append('svg')\n    .attr('width', ss * 5)\n    .attr('height', ss)\n    .style('overflow', 'visible')\n\n  // Swatches\n  swatches.forEach((s,i) => {\n    // const indicator = svg.append('rect')\n    //   .attr('id', s.id)\n    //   .attr('width', ss)\n    //   .attr('height', ss)\n    //   .attr('x', i * ss)\n    //   .attr('stroke', 'grey')\n    //   .attr('fill', 'white')\n    //   .style('stroke-dasharray', s.da.toString())\n\n    const indicator = svg.append('circle')\n      .attr('id', s.id)\n      .attr('r', sr/2)\n      .attr('cx', i * ss + ss/2)\n      .attr('cy', ss/2)\n      .attr('stroke', 'grey')\n      .attr('fill', 'white')\n      .attr('clip-path', 'circle()')\n\n    indicator.append('title').text(s.text)\n\n    if (s.svg) {\n      const path = svg.append('path').attr('d', s.svg).style('visibility', 'hidden')\n      const svgbbox = path.node().getBBox()\n      path.remove()\n\n      // Note the order of the transformations is right to left\n      // in the translate clause\n      const iScale = (ss / svgbbox.width) * s.scale\n      const xAdj = i * ss + (ss - svgbbox.width * iScale)/2\n      const yAdj = (ss - svgbbox.height * iScale)/2\n      const xRot = ss/2 + i*ss\n      const yRot = ss/2\n\n      const symbol = svg.append('path')\n        .attr('id', `${s.id}-path`)\n        .attr('d', s.svg)\n        .attr('transform', `\n          rotate(${s.rot}, ${xRot}, ${yRot})\n          translate(${xAdj} ${yAdj}) \n          scale(${iScale})\n        `)\n\n        symbol.append('title').text(s.text)\n    }\n  })\n}\n\nexport async function trendSave(id, filename) {\n\n  const svg = d3.select(`#${id} svg`)\n  return new Promise((resolve) => {\n    const blob1 =  serialize(svg)\n    if(filename) {\n      download(blob1, filename)\n    }\n    resolve(blob1)\n  })\n\n  function download(data, filename) {\n    const dataUrl = URL.createObjectURL(data)\n    const file = `${filename}.svg`\n    downloadLink(dataUrl, file)\n  }\n\n  function serialize(svg) {\n    const xmlns = \"http://www.w3.org/2000/xmlns/\"\n    const xlinkns = \"http://www.w3.org/1999/xlink\"\n    const svgns = \"http://www.w3.org/2000/svg\"\n  \n    const domSvg = svg.node()\n    const cloneSvg = domSvg.cloneNode(true)\n    const d3Clone = d3.select(cloneSvg)\n    // Explicitly change text in clone to required font\n    d3Clone.selectAll('text').style('font-family','Arial, Helvetica, sans-serif')\n  \n    cloneSvg.setAttributeNS(xmlns, \"xmlns\", svgns)\n    cloneSvg.setAttributeNS(xmlns, \"xmlns:xlink\", xlinkns)\n    const serializer = new window.XMLSerializer\n    const string = serializer.serializeToString(cloneSvg)\n    return new Blob([string], {type: \"image/svg+xml\"})\n  }\n\n  function downloadLink(dataUrl, file) {\n\n    // Create a link element\n    const link = document.createElement(\"a\")\n    // Set link's href to point to the data URL\n    link.href = dataUrl\n    link.download = file\n\n    // Append link to the body\n    document.body.appendChild(link)\n\n    // Dispatch click event on the link\n    // This is necessary as link.click() does not work on the latest firefox\n    link.dispatchEvent(\n      new MouseEvent('click', { \n        bubbles: true, \n        cancelable: true, \n        view: window \n      })\n    )\n    // Remove link from body\n    document.body.removeChild(link)\n  }\n}\n","import { createMaps, getStaticMap, changeMap, mapSetCurrentTaxon } from './mapping'\nimport { bsbiDataAccess } from './dataAccessAtlas'\nimport { apparency, phenology, altLat } from './ecology'\nimport { updateTrendSummary2, trendSummary2, trendSave } from './trendSummary'\nimport { pcache } from './gen'\nimport { getCookie } from './utils'\n\nconst $ = jQuery // eslint-disable-line no-undef\nconst ds = drupalSettings // eslint-disable-line no-undef\n\nconst currentTaxon = {\n  identifier: '',\n  name: null,\n  shortName: null,\n  tetrad: null,\n}\nlet phen1, phen2, altlat\nlet browsedFileData\nlet bCancelled = false\nlet aNoStatus, aIsHybrid\n\nexport function downloadPage() {\n\n  $('#bsbi-atlas-download')\n    .css('display', 'flex')\n  $('<div>').appendTo($('#bsbi-atlas-download'))\n    .attr('id', 'bsbi-atlas-download-left')\n    .css('flex', 1)\n  $('<div>').appendTo($('#bsbi-atlas-download'))\n    .attr('id', 'bsbi-atlas-download-right')\n    .css('flex', 1)\n    .css('margin-left', '1em')\n\n  taxonSelectors()\n  downloadButton()\n \n  $('<hr/>').appendTo($('#bsbi-atlas-download-left'))\n\n  const $instructions = $('<p>').appendTo($('#bsbi-atlas-download-left'))\n  $instructions.html(`\n    For batch downloads, first select a CSV file from your computer\n    that has two columns: <i>taxonId</i> which has the ddbid for each \n    taxon and <i>taxon</i> which specifies a taxon name. \n    The taxon name is only used to name the file and\n    doesn't have to be exactly the same as \n    the name used elsewhere on the site. The ddbid will also be used \n    in the filename in case of any ambiguity.\n  `)\n  fileUploadButton()\n  downloadBatchButton()\n  cancelDownloadBatchButton()\n\n  $('<hr/>').appendTo($('#bsbi-atlas-download-left'))\n\n  makeCheckbox('map', 'Map')\n  makeCheckbox('apparency', 'Apparency')\n  makeCheckbox('phenology', 'Phenology')\n  makeCheckbox('altlat', 'Alt/Lat')\n  makeCheckbox('trend', 'Trends')\n\n  mapping()\n  apparencyChart()\n  phenologyChart()\n  altlatChart()\n  trendIndicators()\n}\n\nfunction taxonToFile(taxon, id) {\n  let filename = `${taxon}_${id}_`\n  filename = filename.replace(/ /g, '_')\n  filename = filename.replace(/\\s+/g, '')\n  filename = filename.replace(/\\./g, '_')\n  filename = filename.replace(/_+/g, '_')\n\n  return filename\n}\n\nasync function downloadTaxa() {\n\n  const data = await d3.csv(browsedFileData)\n  bCancelled = false\n\n  for (let i=0; i<data.length; i++) {\n\n    if (bCancelled) {\n      break\n    }\n    // Taxon\n    const t = data[i]\n    const filename = taxonToFile(t.taxon, t.taxonId)\n\n    // For reporting errors\n    let eMapping, eApparency, ePhenology, eAltlat, eTrends\n\n    // Ensure that status is set correctly for mapping\n    const isHybrid = aIsHybrid.indexOf(t.taxonId) > -1\n    const noStatus = aNoStatus.indexOf(t.taxonId) > -1\n    bsbiDataAccess.showStatus = !isHybrid && !noStatus\n\n    // Map\n    const p1 = mappingUpdate(t.taxonId, filename).catch(e => eMapping = e)\n    const p2 = apparencyUpdate(t.taxonId, filename).catch(e => eApparency = e)\n    const p3 = phenologyUpdate(t.taxonId, filename).catch(e => ePhenology = e)\n    const p4 = altlatUpdate(t.taxonId, filename).catch(e => eAltlat = e)\n    const p5 = trendsUpdate(t.taxonId, filename).catch(e => eTrends = e)\n\n    await Promise.all([p1, p2, p3, p4, p5]).then(() => {\n\n      if (eMapping || eApparency  || ePhenology || eAltlat) {\n        let html=(`<b>Problems for ${t.taxon} (${t.taxonId})</b>`)\n        html += '<ul>'\n        if (eMapping) {\n          html += '<li>Map failed</li>'\n        }\n        if (eApparency) {\n          html += '<li>Apparency chart failed</li>'\n        }\n        if (ePhenology) {\n          //console.log(ePhenology)\n          html += '<li>Phenology chart failed</li>'\n        }\n        if (eAltlat) {\n          html += '<li>Altlat chart failed</li>'\n        }\n        // Doesn't report missing trends since there are lots of these\n\n        $('<div>').appendTo($('#bsbi-atlas-download-right')).html(html)\n      }\n    })\n  }\n}\n\nfunction fileUploadButton() {\n\n  const $file = $('<input>').appendTo($('#bsbi-atlas-download-left'))\n  $file.attr('type', 'file')\n  $file.attr('accept', '.csv')\n  $file.attr('id', 'bsbi-atlas-batch-file')\n  $file.css('margin-bottom', '1em')\n  $file.on('change', function(){\n    fileOpened(event)\n  })\n}\n\nfunction fileOpened(event) {\n  const reader = new FileReader()\n  reader.addEventListener('load', (event) => {\n    browsedFileData = event.target.result\n    //console.log('browsedFileData', browsedFileData)\n  })\n  reader.readAsDataURL(event.target.files[0])\n}\n\nfunction downloadBatchButton() {\n  const $button = $('<button>').appendTo($('#bsbi-atlas-download-left'))\n  $button.addClass('btn btn-default')\n  $button.text('Download batch')\n  $button.on('click', function(){\n    clearCharts()\n    downloadTaxa()\n  })\n}\n\nfunction cancelDownloadBatchButton() {\n  const $button = $('<button>').appendTo($('#bsbi-atlas-download-left'))\n  $button.addClass('btn btn-default')\n  $button.css('margin-left', '1em')\n  $button.text('Cancel')\n  $button.on('click', function(){\n    bCancelled = true\n  })\n}\n\nfunction downloadButton() {\n  const $button = $('<button>').appendTo($('#bsbi-atlas-download-left'))\n  $button.addClass('btn btn-default')\n  $button.text('Download selected')\n\n  $button.on('click', function(){\n    clearCharts()\n    const filename = taxonToFile(currentTaxon.shortName, currentTaxon.identifier)\n    const staticMap = getStaticMap()\n\n    if ($('#download-map').is(':checked')) \n      staticMap.saveMap(true, null, `${filename}map`)\n    if ($('#download-apparency').is(':checked')) \n      phen1.saveImage(true, `${filename}apparency`)\n    if ($('#download-phenology').is(':checked')) \n      phen2.saveImage(true, `${filename}phenology`)\n    if ($('#download-altlat').is(':checked')) \n      altlat.saveImage(true, `${filename}altlat`)\n    if ($('#download-trend').is(':checked')) {\n      console.log('checked')\n      trendSave('bsbi-trend-summary-gb', `${filename}altlat-gb`)\n      trendSave('bsbi-trend-summary-ir', `${filename}altlat-ir`)\n    } else {\n      console.log('not checked')\n    }\n  })\n}\n\nfunction makeCheckbox(id, label ) {\n  const $cb = $(`<input type=\"checkbox\" id=\"download-${id}\" style=\"margin:0.5em\" checked>`).appendTo($('#bsbi-atlas-download-left'))\n  $(`<label for=\"download-${id}\">${label}</label>`).appendTo($('#bsbi-atlas-download-left'))\n}\n\nfunction mapping() {\n  $('<div id=\"bsbiMapDownloadDiv\" style=\"max-width: 500px\">').appendTo($('#bsbi-atlas-download-left'))\n\n  createMaps(\"#bsbiMapDownloadDiv\")\n  const staticMap = getStaticMap()\n\n  // Transorm, grid style and boundary style are all set when map is initialised, but\n  // backdrop is not so do it here.\n  const backdrop = getCookie('backdrop') ? getCookie('backdrop') : 'colour_elevation'\n  const rasterRoot = ds.bsbi_atlas.dataRoot + 'rasters/'\n  if (backdrop !== 'none') {\n    staticMap.basemapImage(backdrop, true, rasterRoot + `${backdrop}.png`, rasterRoot + `${backdrop}.pgw`)\n  }\n\n  // Ensure right map is selected\n  // allclass is the default, status is set on a per taxon basis\n  // Indicated that 4 classes are to be used\n  bsbiDataAccess.periodClasses = 'print'\n}\n\nasync function mappingUpdate(taxonId ,taxon) {\n\n  const staticMap = getStaticMap()\n  if ($('#download-map').is(':checked')) {\n    currentTaxon.identifier = taxonId\n    mapSetCurrentTaxon(currentTaxon)\n    await changeMap(true)\n    if (taxon) {\n      await staticMap.saveMap(true, null, `${taxonToFile(taxon, taxonId)}map`)\n    }\n  }\n  return Promise.resolve()\n}\n\nfunction apparencyChart() {\n  const $apparency = $('<div>').appendTo($('#bsbi-atlas-download-left'))\n  $apparency.attr('id', 'bsbi-apparency-chart').css('max-width', '400px')\n\n  phen1 = brccharts.phen1({\n    selector: '#bsbi-apparency-chart',\n    data: [],\n    taxa: ['taxon'],\n    metrics: [{ prop: 'n', label: 'Apparency', colour: 'green', fill: '#ddffdd' }],\n    width: 400,\n    height: 250,\n    headPad: 35,\n    perRow: 1,\n    expand: true,\n    showTaxonLabel: false,\n    axisLeft: 'off',\n    showLegend: false,\n    interactivity: 'none'\n  })\n}\n\nasync function apparencyUpdate(taxonId ,taxon) {\n  if ($('#download-apparency').is(':checked')) {\n    const apparencyRoot = `${ds.bsbi_atlas.dataRoot}bsbi/apparency/`\n    const file = apparencyRoot + 'all/' + taxonId.replace(/\\./g, \"_\") + '.csv'\n    let data = await d3.csv(file + `?prevent-cache=${pcache}`) //.catch(() => null)\n    // if (!data) {\n    //   // TEMPORARY CODE FOR TESTING so that a file always returned \n    //   const fileDefault = apparencyRoot + 'all/dummy.csv'\n    //   data = await d3.csv(fileDefault + '?prevent-cache=')\n    // }\n    await apparency(phen1, data)\n    if (taxon) {\n      await phen1.saveImage(true, `${taxonToFile(taxon, taxonId)}apparency`)\n    } \n  }\n  return Promise.resolve()\n}\n\nfunction phenologyChart() {\n  const $phenology = $('<div>').appendTo($('#bsbi-atlas-download-left'))\n  $phenology.attr('id', 'bsbi-phenology-chart').css('max-width', '400px')\n\n  phen2 = brccharts.phen2({\n    selector: '#bsbi-phenology-chart',\n    data: [],\n    taxa: ['taxon'],\n    metrics: [],\n    width: 400,\n    height: 25,\n    split: true,\n    headPad: 35,\n    chartPad: 35,\n    perRow: 1,\n    expand: true,\n    showTaxonLabel: false,\n    interactivity: 'none'\n  })\n}\n\nasync function phenologyUpdate(taxonId ,taxon) {\n  if ($('#download-phenology').is(':checked')) {\n    const captionRoot = ds.bsbi_atlas.dataRoot + 'bsbi/captions/'\n    const file = `${captionRoot}${taxonId.replace(/\\./g, \"_\")}.csv`\n    let data = await d3.csv(file + `?prevent-cache=${pcache}`) //.catch(() => null)\n    // if (!data) {\n    //   // TEMPORARY CODE FOR TESTING so that a file always returned \n    //   const fileDefault = phenologyRoot + 'dummy-phenology.csv'\n    //   data = await d3.csv(fileDefault + `?prevent-cache=${pcache}`)\n    // }\n    await phenology(phen2, data, null)\n    if (taxon) {\n      await phen2.saveImage(true, `${taxonToFile(taxon, taxonId)}phenology`)\n    }\n  }\n  return Promise.resolve()\n}\n\nfunction altlatChart() {\n\n  const $altlat = $('<div>').appendTo($('#bsbi-atlas-download-left'))\n  $altlat.attr('id', 'bsbi-altlat-chart').css('max-width', '600px')\n\n  const opts = {\n    selector: '#bsbi-altlat-chart',\n    data: [],\n    ranges:  [\n      {\n        min: 0,\n        max: 0.99999,\n        radius: 8,\n        legend: '<1%'\n      },\n      {\n        min: 1,\n        max: 10,\n        radius: 11,\n        legend: '1-10%'\n      },\n      {\n        min: 10.00001,\n        max: 30,\n        radius: 14,\n        legend: '11-30%'\n      },\n      {\n        min: 30.00001,\n        max: 40,\n        radius: 16,\n        legend: '31-40%'\n      },\n      {\n        min: 40.00001,\n        max: 50,\n        radius: 18,\n        legend: '41-50%'\n      },\n      {\n        min: 50.00001,\n        max: 100,\n        radius: 20,\n        legend: '51-100%'\n      }\n    ],\n    taxa: ['dummy'],\n    width: 600,\n    height: 300,\n    perRow: 1,\n    expand: true,\n    margin: {left: 45, right: 10, top: 20, bottom: 35},\n    showTaxonLabel: false,\n    showLegend: true,\n    axisLabelFontSize: 12,\n    legendFontSize: 10,\n    interactivity: 'toggle'\n  }\n\n  altlat = brccharts.altlat(opts)\n}\n\nasync function altlatUpdate(taxonId ,taxon) {\n  if ($('#download-altlat').is(':checked')) {\n    const altlatRoot = ds.bsbi_atlas.dataRoot + 'bsbi/20220606/altlat/'\n    const altlatfile = `${altlatRoot}${taxonId.replace(/\\./g, \"_\")}.csv?prevent-cache=${pcache}`\n    const altlatdata = await d3.csv(altlatfile)\n    await altLat(altlat, altlatdata)\n    if (taxon) {\n      await altlat.saveImage(true, `${taxonToFile(taxon, taxonId)}altlat`)\n    }\n  }\n  return Promise.resolve()\n}\n\nfunction trendIndicators() {\n\n  const $trendGb = $('<div>').appendTo($('#bsbi-atlas-download-left'))\n  $trendGb.attr('id', 'bsbi-trend-summary-gb').css('max-width', '600px')\n\n  const $trendIr = $('<div>').appendTo($('#bsbi-atlas-download-left'))\n  $trendIr.attr('id', 'bsbi-trend-summary-ir').css('max-width', '600px')\n}\n\nasync function trendsUpdate(taxonId, taxon) {\n\n  $('#bsbi-trend-summary-gb').html('')\n  $('#bsbi-trend-summary-ir').html('')\n\n  const trendRoot = ds.bsbi_atlas.dataRoot + 'bsbi/trends/long/trends-summaries'\n  const trendGb = `${trendRoot}/Britain/${taxonId.replace(/\\./g, \"_\")}.csv?prevent-cache=${pcache}`\n  const trendIr = `${trendRoot}/Ireland/${taxonId.replace(/\\./g, \"_\")}.csv?prevent-cache=${pcache}`\n  \n  const pGb = new Promise((resolve) => {\n    d3.csv(trendGb)\n      .then(function(d) {\n          trendSummary2('bsbi-trend-summary-gb')\n          updateTrendSummary2('bsbi-trend-summary-gb', d[0], 'rgb(0,255,255)')\n      }).catch(function(){\n        //console.log('Error reading trend summary file', trendGb)\n      }).finally(() => {\n        resolve('')\n      })\n  })\n\n  const pIr = new Promise((resolve) => {\n    d3.csv(trendIr)\n      .then(function(d) {\n          trendSummary2('bsbi-trend-summary-ir')\n          updateTrendSummary2('bsbi-trend-summary-ir', d[0], 'rgb(0,255,255)')\n      }).catch(function(){\n        //console.log('Error reading trend summary file', trendIr)\n      }).finally(() => {\n        resolve('')\n      })\n  })\n\n  if (taxon) {\n    await Promise.all([pGb, pIr])\n    await trendSave('bsbi-trend-summary-gb', `${taxonToFile(taxon, taxonId)}altlat-gb`)\n    await trendSave('bsbi-trend-summary-ir', `${taxonToFile(taxon, taxonId)}altlat-gb`)\n  }\n\n  return Promise.all([pGb, pIr])\n}\n\nfunction clearCharts() {\n  if (!$('#download-map').is(':checked')) {\n    const staticMap = getStaticMap()\n    //console.log('clear map')\n    staticMap.clearMap()\n  }\n  if (!$('#download-apparency').is(':checked')) \n    phen1.setChartOpts({data: []})\n  if (!$('#download-phenology').is(':checked')) \n    phen2.setChartOpts({data: []})\n  if (!$('#download-altlat').is(':checked')) \n    altlat.setChartOpts({data: []})\n  if (!$('#download-trend').is(':checked')) {\n    $('#bsbi-trend-summary-gb').html('')\n    $('#bsbi-trend-summary-ir').html('')\n  }\n}\n\nfunction taxonSelectors() {\n\n  // Overall control container\n  const $container = $('<div>').appendTo($('.bsbi-atlas-taxon-selector'))\n  $container.addClass('atlas-taxon-selector-div')\n\n  // Selector\n  const $sel = $('<select>').appendTo($container)\n  $sel.addClass('atlas-taxon-selector-sel')\n\n\n  d3.csv(ds.bsbi_atlas.dataRoot + `bsbi/taxon_list.csv?prevent-cache=${pcache}`).then(function(data) {\n    const taxaList = data\n    taxaList.forEach(function(d) {\n      let name = ''\n      if (d['vernacular']) {\n        name = '<b>' + d['vernacular'] + '</b> '\n      }\n      name = name + d['formattedName']\n\n      const $opt = $('<option>')\n      $opt.attr('data-content', name)\n      $opt.attr('value', d['ddbid'])\n      $opt.attr('data-taxon-name', d['taxonName'])\n      //$opt.attr('data-vernacular', d['vernacular'])\n      $opt.attr('data-is-hybrid', d['hybrid'])\n\n      $opt.html(name).appendTo($sel)\n    })\n\n    $sel.attr('data-size', '10')\n    $sel.attr('data-live-search', 'true')\n    $sel.attr('data-header', 'Start typing the name of a taxon')\n    $sel.attr('title', 'Select a taxon')\n    $sel.selectpicker()\n    $sel.on('changed.bs.select', function () {\n\n      console.log('Identifier:', $(this).val())\n\n      clearCharts()\n\n      currentTaxon.identifier = $(this).val()\n      currentTaxon.name =  $(this).find(\":selected\").attr(\"data-content\")\n      currentTaxon.shortName =  $(this).find(\":selected\").attr(\"data-taxon-name\")\n      currentTaxon.isHybrid = $(this).find(\":selected\").attr(\"data-is-hybrid\") === 't'\n\n      // Ensure that status is set correctly for mapping\n      const isHybrid = $(this).find(\":selected\").attr(\"data-is-hybrid\") === 't'\n      const noStatus = aNoStatus.indexOf($(this).val()) > -1\n      bsbiDataAccess.showStatus = !isHybrid && !noStatus\n\n      mappingUpdate(currentTaxon.identifier)\n      apparencyUpdate(currentTaxon.identifier)\n      phenologyUpdate(currentTaxon.identifier)\n      altlatUpdate(currentTaxon.identifier)\n      trendsUpdate(currentTaxon.identifier)\n    })\n\n    // For batch mapping\n    aIsHybrid = data.map(t => t.hybrid === 't')\n  }).catch(function(){\n    console.log('Error reading taxon CSV')\n  })\n\n  // No status list for batch mapping\n  d3.csv(`${ds.bsbi_atlas.dataRoot}bsbi/no_status.csv?prevent-cache=${pcache}`).then(function(data) {\n    aNoStatus = data.map(d => d['ddb id'])\n  })\n}","import * as d3 from 'd3'\n// import lightGallery from 'lightGallery'\nimport { bsbiDataAccess } from './dataAccessAtlas'\nimport { setBaseMetaTags, addMetaTags } from './metaTags'\nimport { createEcology, changeEcology } from './ecology'\nimport { createGallery } from './gallery'\nimport { copyToClipboard,  getCitation } from './utils'\nimport { mapSetCurrentTaxon, createMaps, changeMap, createMapControls, setControlState, updateBsbiDataAccess} from './mapping'\nimport { develTrendSummary } from './devel'\nimport { downloadPage } from './download'\nimport { updateTrendSummary2, trendSummary2 } from './trendSummary'\nimport { pcache } from './gen'\n\nconst $ = jQuery // eslint-disable-line no-undef\nconst ds = drupalSettings // eslint-disable-line no-undef\n\nlet develSummaryTrendColour = 'rgb(0,255,255)'\n\nexport function main() {\n\n  let taxaList = []\n  const currentTaxon = {\n    identifier: null,\n    name: null,\n    shortName: null,\n    tetrad: null,\n    isHybrid: false,\n    hybridMapping: false\n  }\n  mapSetCurrentTaxon(currentTaxon)\n\n  $(document).ready(function () {\n\n    addEventListener('popstate', event => { \n      //console.log('popstate', event)\n      if (event.state && event.state.identifier) {\n        $('.atlas-taxon-selector-sel').selectpicker('val', event.state.identifier)\n      }\n    })\n\n    if(location.pathname === '/download') {\n      // Download page\n\n      downloadPage()\n\n    } else {\n      // Main atlas page\n\n      // Set meta tags\n      setBaseMetaTags()\n\n      // Initialise main content\n      mainAtlasContent()\n\n      // Devel block\n      //develChangeMapColours('#bsbi-atlas-development', changeMap)\n      //develMainMapStyles('#bsbi-atlas-development', changeMap)\n      develTrendSummary('#bsbi-atlas-development', (colour) => {\n        console.log(colour)\n        develSummaryTrendColour = colour\n        changeCaption()\n      })\n    }\n  })\n\n  function mainAtlasContent() {\n\n    bsbiDataAccess.periodClasses = 'standard'\n\n    const sections = [\n      {\n        group: null,\n        id: 'summary',\n        title: 'Summary',\n        fn: sectionSummary,\n      },\n      {\n        group: null,\n        id: 'conservation',\n        title: 'Conservation status',\n        fn: sectionEmpty,\n      },\n      {\n        group: null,\n        id: 'gallery',\n        title: 'Gallery',\n        fn: sectionGallery,\n      },\n      {\n        group: 'CHARACTERISTICS',\n        id: 'ecology',\n        title: 'Ecology',\n        fn: sectionEcology,\n      },\n      {\n        group: 'EXTERNAL LINKS',\n        id: 'ecoflora',\n        title: 'EcoFlora',\n        fn: ecoFlora,\n        external: true,\n      },\n      {\n        group: 'EXTERNAL LINKS',\n        id: 'worldfloraonline',\n        title: 'World Flora Online',\n        fn: worldFloraOnline,\n        external: true,\n      },\n      // {\n      //   group: 'BIBLIOGRAPHY',\n      //   id: 'references',\n      //   title: 'References',\n      //   fn: sectionEmpty,\n      // },\n    ]\n\n    // Taxon selection controls\n    taxonSelectors()\n\n    // Select summary (map) tab initially\n    const selected = 'summary'\n\n    // Clear current content (including dialog boxes from SVG maps)\n    $('.brc-atlas-map-opts').remove()\n    $('#bsbi-atlas-gui').html(null)\n\n    // Make the section tabs\n    const $ul = $('<ul class=\"nav nav-tabs\"></ul>').appendTo($('#bsbi-atlas-gui'))\n    sections.forEach(function(s){\n      if (!s.external){\n        $ul.append(makeTabButton(s.id, s.title, selected))\n      }\n    })\n\n    // Create the empty content sections\n    const $content = $('<div class=\"tab-content\"></div>').appendTo($('#bsbi-atlas-gui'))\n    sections.forEach(function(s){\n      if (!s.external){\n        $content.append(makeSection(s.id, s.title, selected))\n      }\n    })\n\n    // Create the detailed section content\n    sections.forEach(function(s){\n      if (!s.external){\n        s.fn(s.id)\n      }\n    })\n\n    // Add behaviour for particular sections on display\n    $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function (e) {\n\n      const target = $(e.target).attr(\"href\") // activated tab\n      \n      // Show/hide the map controls appropriately\n      if (target === '#bsbi-atlas-section-summary') {\n        $('.bsbi-atlas-map-controls').show()\n        // Regenerate map (to deal with bad legend display if map hidden when created)\n        changeMap()\n      } else {\n        $('.bsbi-atlas-map-controls').hide()\n      }\n\n      if (target === '#bsbi-atlas-section-ecology') {\n        // Regenerate graphics (to deal with bad legend display if map hidden when created)\n        changeEcologyTab()\n      }\n\n      if (target === '#bsbi-atlas-section-gallery') {\n        createGallery('bsbi-gallery', currentTaxon.identifier)\n      }\n    })\n  }\n\n  function taxonSelectors() {\n\n    // Overall control container\n    const $container = $('<div>').appendTo($('.bsbi-atlas-taxon-selector'))\n    $container.addClass('atlas-taxon-selector-div')\n\n    // Selector\n    const $sel = $('<select>').appendTo($container)\n    $sel.addClass('atlas-taxon-selector-sel')\n\n    // Copy taxon\n    const $link = $('<button>').appendTo($container)\n    $link.addClass('atlas-taxon-selector-link')\n    $link.attr('title', 'Copy link for taxon into clipboard')\n    $link.addClass('btn btn-default')\n    $link.html('&#128279;')\n    $link.css('padding', '6px 6px')\n    $link.on('click', function() {\n      if (currentTaxon.identifier) {\n        copyToClipboard(location.origin + '/atlas/' + currentTaxon.identifier)\n      }\n    })\n\n    d3.csv(`${ds.bsbi_atlas.dataRoot}bsbi/taxon_list.csv?prevent-cache=${pcache}`).then(function(data) {\n\n      taxaList = data\n      taxaList.forEach(function(d) {\n        let name = ''\n        if (d['vernacular']) {\n          name = '<b>' + d['vernacular'] + '</b> '\n        }\n        name = name + d['formattedName']\n\n        // name = name + '<i>' + d['taxonName'] + '</i>'\n        // if (d['qualifier']) {\n        //   name = name + ' <b><i>' + d['qualifier'] + '</i></b>'\n        // }\n        // if (d['authority']) {\n        //   name = name + ' <span style=\"color: grey\">' + d['authority'] + '</span>'\n        // }\n\n        const $opt = $('<option>')\n        $opt.attr('data-content', name)\n        $opt.attr('value', d['ddbid'])\n        //$opt.attr('data-canonical', d['canonical'])\n        $opt.attr('data-taxon-name', d['taxonName'])\n        //$opt.attr('data-qualifier', d['qualifier'])\n        $opt.attr('data-vernacular', d['vernacular'])\n        $opt.attr('data-is-hybrid', d['hybrid'])\n\n        const aParentids = d['hybridParentIds'].split(';')\n        const aParents = d['hybridParents'].split(';')\n        const hybridMapping = (aParents.length === 2 && aParentids.length === 2)\n        $opt.attr('data-hybrid-mapping', hybridMapping)\n\n        //$opt.attr('data-tetrad', d['tetrad'])\n        //$opt.attr('data-monad', d['monad'])\n\n        $opt.html(name).appendTo($sel)\n      })\n\n      $sel.attr('data-size', '10')\n      $sel.attr('data-live-search', 'true')\n      $sel.attr('data-header', 'Start typing the name of a taxon')\n      $sel.attr('title', 'Select a taxon')\n      $sel.selectpicker()\n\n      $sel.on('changed.bs.select', function (e, clickedIndex, newValue, oldValue) {\n\n        //console.log(e, clickedIndex, newValue, oldValue)\n        //console.log('Identifier:', $(this).val())\n\n        // Because more than one selector can be present on page\n        // (one for mobile and one for larger devices), if this rountine\n        // is reached by $sel.selectpicker() then it will be invoked more\n        // once for each picker, so the comparison below ensures that\n        // the code here is only executed once.\n        if (currentTaxon.identifier !== $(this).val()) {\n\n          currentTaxon.identifier = $(this).val()\n          currentTaxon.name =  $(this).find(\":selected\").attr(\"data-content\")\n          currentTaxon.shortName = $(this).find(\":selected\").attr(\"data-taxon-name\")\n          currentTaxon.isHybrid = $(this).find(\":selected\").attr(\"data-is-hybrid\") === 't'\n          currentTaxon.hybridMapping = $(this).find(\":selected\").attr(\"data-hybrid-mapping\") === 'true'\n\n          // If selection was made programatically (browser back or forward\n          // button), don't add to history.\n          if (clickedIndex) {\n            window.history.pushState({identifier: currentTaxon.identifier}, `BSBI Atlas - ${currentTaxon.shortName}`, `/atlas/${currentTaxon.identifier}`)\n          }\n\n          mapSetCurrentTaxon(currentTaxon)\n          setControlState()\n          changeMap()\n          changeCaption() //Also changes taxon name display in sections\n          changeEcologyTab()\n          createGallery('bsbi-gallery', currentTaxon.identifier)\n        }\n      })\n\n      // If identifier passed in URL, set the value and add to history\n      if (ds.bsbi_atlas.identifier) {\n        $sel.selectpicker('val', ds.bsbi_atlas.identifier)\n        window.history.pushState({identifier: ds.bsbi_atlas.identifier}, `BSBI Atlas - ${ds.bsbi_atlas.identifier}`, `/atlas/${currentTaxon.identifier}`)\n      }\n\n      // Get list of hybrid taxa which can be mapped with their parents\n      const hybridTaxa = taxaList.filter(t => t['hybridParentIds'].split(';').length === 2).map(t => {\n\n        const parentIds = t['hybridParentIds'].split(';')\n        const parentNames = t['hybridParents'].split(';')\n\n        return {\n          taxon: t['ddbid'],\n          parent1: parentIds[0],\n          parent2: parentIds[1],\n          //taxonName: t['canonical'],\n          taxonName: t['taxonName'],\n          parent1Name: parentNames[0],\n          parent2Name: parentNames[1],\n        }\n      })\n      updateBsbiDataAccess('taxaHybridList', hybridTaxa)\n\n      // Get list of taxa for which no status exists\n      // (for use elsewhere - might as well be done here)\n      d3.csv(`${ds.bsbi_atlas.dataRoot}bsbi/no_status.csv?prevent-cache=${pcache}`).then(function(data) {\n        updateBsbiDataAccess('taxaNoStatusList',  data.map(function(d) {return d['ddb id']}))\n      })\n    }).catch(function(){\n      console.log('Error reading taxon CSV')\n    })\n  }\n\n  function makeTabButton(id, title, selected) {\n    const $li = $('<li>')\n    if (selected === id) {\n      $li.addClass('active')\n    }\n    const $a = $('<a data-toggle=\"tab\" href=\"#bsbi-atlas-section-' + id + '\">').appendTo($li)\n    $a.text(title)\n    return $li\n  }\n\n  function makeSection(id, title, selected) {\n    const $div = $('<div/>', {\n      id: 'bsbi-atlas-section-' + id\n    })\n\n    $div.addClass('tab-pane')\n    $div.addClass('fade')\n    if (selected === id) {\n      $div.addClass('in')\n      $div.addClass('active')\n    }\n    const $h = $('<p class=\"bsbi-selected-taxon-name\"></p>')\n    $h.css('font-size', '1.3em')\n    $h.css('margin-top', '0.5em')\n    $h.addClass('bsbi-atlas-section-header')\n    $div.append($h)\n\n    return $div\n  }\n\n  function sectionEmpty(id) {\n    const $sect = $('#bsbi-atlas-section-' + id)\n    const $p1 = $('<p>').appendTo($sect)\n    $p1.text('Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.')\n    const $p2 = $('<p>').appendTo($sect)\n    $p2.text('Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.')\n  }\n\n  function sectionSummary(id) {\n    const $sect = $('#bsbi-atlas-section-' + id)\n\n    const $d = $('<div class=\".container-fluid\">').appendTo($sect)\n    const $r = $('<div class=\"row\">').appendTo($d)\n    const $left = $('<div class=\"col-sm-8\">').appendTo($r)\n    const $right = $('<div class=\"col-sm-4\">').appendTo($r)\n    $left.append('<div id=\"bsbiMapDiv\" width=\"100%\"></div>')\n\n    //$left.append('<h4>Atlas map point</h4>')\n    $left.append('<div id=\"dotCaption\" width=\"100%\" style=\"margin-top:1em\"></div>')\n\n    $left.append('<h4>Status etc for devel</h4>')\n    $left.append('<div id=\"statusDevel\" width=\"100%\"></div>')\n\n    const $taxon = $('<div class=\"bsbi-selected-taxon-name bsbi-section-summary\"></div>').appendTo($right)\n    $taxon.css('font-size', '1.3em')\n    $right.append('<hr/>')\n    $right.append('<div id=\"bsbi-caption\"></div>')\n    \n    createMaps(\"#bsbiMapDiv\")\n    createMapControls('.bsbi-atlas-map-controls')\n    setControlState()\n  }\n\n  function sectionEcology(id) {\n    const $sect = $('#bsbi-atlas-section-' + id)\n    $sect.append('<div id=\"bsbi-phenology\"></div>')\n\n    createEcology(\"#bsbi-phenology\")\n  }\n\n  function sectionGallery(id) {\n    const $sect = $('#bsbi-atlas-section-' + id)\n    $sect.append('<div id=\"bsbi-gallery\" class=\"inline-gallery-container\"></div>')\n    const $copyright = $('<div id=\"bsbi-gallery-copyright\"></div>').appendTo($sect)\n    $copyright.text(\"Copyright Rob Still/Chris Gibson\")\n    $('#bsbi-gallery-copyright').hide()\n  }\n\n  function postProcessCaptionText(txt) {\n    let txtn = txt\n    const bsbidburl = ds.bsbi_atlas.dataBsbidb\n    //txtn  = txtn.replace(/href=\"\\/object.php/g, 'target=\"_blank\" href=\"' + bsbidburl + 'object.php')\n    //txtn  = txtn.replace(/href='\\/object.php/g, 'target=\\'_blank\\' href=\\'' + bsbidburl + 'object.php')\n\n    txtn  = txtn.replace(/object.php\\?entityid=/g, 'atlas/')\n    txtn  = txtn.replace(/&amp;class=TaxonInstance/g, '')\n\n    return txtn\n  }\n\n  function getFormattedTaxonName(vernacular, formatted) {\n    // const vernacularHtml = vernacular ? '<span class=\"taxname\"><b>' + vernacular + ' </b></span>' : ''\n    // const scientificHtml = scientific ? '<span class=\"taxname\"><i>' + scientific + ' </i></span>' : ''\n    // const authorityHtml = authority ? '<span class=\"taxname\"><span style=\"color: grey\">' + authority + '</span></span>' : ''\n\n    // return vernacularHtml+ scientificHtml + authorityHtml\n\n    return `<b>${vernacular}</b> ${formatted}`\n  }\n\n  function changeEcologyTab() {\n   \n    changeEcology(ds.bsbi_atlas.dataRoot, currentTaxon.identifier)\n  }\n\n  function changeCaption() {\n    let $p\n    const $caption = $('#bsbi-caption')\n    $caption.html('')\n    const captionRoot = ds.bsbi_atlas.dataRoot + 'bsbi/captions/'\n    const captionFile = `${captionRoot}${currentTaxon.identifier.replace(/\\./g, \"_\")}.csv?prevent-cache=${pcache}`\n    d3.csv(captionFile)\n      .then(function(d) {\n\n        //console.log('caption file', d)\n        \n        // Set taxon name\n        const tName = getFormattedTaxonName(d[0].vernacular, d[0].formattedName)\n        $('.bsbi-selected-taxon-name').html(`${tName}`)\n\n        // For caption, set the various sections\n        // Description\n        if (d[0].atlasSpeciesDescription) {\n          $caption.append('<h4>Description</h4>')\n          $p = $('<p>').appendTo($caption)\n          $p.append(postProcessCaptionText(d[0].atlasSpeciesDescription))\n          $p = $('<p>').appendTo($caption)\n          $p.append('TODO - overall status')\n        }\n\n        // Taxa covered\n        if (d[0].captionedChildTaxonIds) {\n          $caption.append('<h4>Taxa covered <span id=\"bsbi-taxa-covered-toggle\">[show]</span></h4>')\n          //$p = $('<p id=\"bsbi-taxa-covered-toggle\">').appendTo($caption)\n          //$p.html('[show]')\n          const $ul = $('<ul id=\"bsbi-taxa-covered-list\">').appendTo($caption)\n          const ddbids = d[0].captionedChildTaxonIds.split(';')\n          ddbids.forEach(function(ddbid) {\n            const $li = $('<li>').appendTo($ul)\n            const taxon = taxaList.find(function(t) {return t['ddbid'] === ddbid})\n            console.log('taxon', taxon)\n            if (taxon) {\n              //$li.html(getFormattedTaxonName(taxon['vernacular'], taxon['formattedName']))\n              const $i = $('<i>').appendTo($li)\n              const $a = $('<a>').appendTo($i)\n              $a.attr('href', `/atlas/${ddbid}`)\n              $a.attr('alt', `Link to ${taxon.taxonName}`)\n              $a.text(taxon.taxonName)\n            }\n          })\n          let taxaCoveredShown = false\n          $('#bsbi-taxa-covered-toggle').click(function() {\n            taxaCoveredShown = !taxaCoveredShown\n            if (taxaCoveredShown) {\n              $('#bsbi-taxa-covered-list').show()\n              $('#bsbi-taxa-covered-toggle').html('[hide]')\n            }\n            if (!taxaCoveredShown) {\n              $('#bsbi-taxa-covered-list').hide()\n              $('#bsbi-taxa-covered-toggle').html('[show]')\n            }\n          })\n        }\n        \n        // Trends\n        if (d[0].atlasSpeciesTrends) {\n          $caption.append('<h4>Trends</h4>')\n         \n          const $gbTrend = $('<div>').attr('id', 'trend-sum-gb2')\n          $gbTrend.hide()\n          $gbTrend.appendTo($caption)\n\n          const $irTrend = $('<div>').attr('id', 'trend-sum-ir2')\n          $irTrend.hide()\n          $irTrend.appendTo($caption)\n\n          const trendRoot = ds.bsbi_atlas.dataRoot + 'bsbi/trends/long/trends-summaries'\n          const trendGb = `${trendRoot}/Britain/${currentTaxon.identifier.replace(/\\./g, \"_\")}.csv?prevent-cache=${pcache}`\n          const trendIr = `${trendRoot}/Ireland/${currentTaxon.identifier.replace(/\\./g, \"_\")}.csv?prevent-cache=${pcache}`\n          \n          d3.csv(trendGb)\n            .then(function(d) {\n              $('<div>').text('Britain Post-1930 10 km modelled trend').appendTo($gbTrend)\n              $gbTrend.show()\n              trendSummary2('trend-sum-gb2')\n              updateTrendSummary2('trend-sum-gb2', d[0], develSummaryTrendColour)\n              $('#trend-sum-gb2').show()\n          }).catch(function(){\n            console.log('Error reading trend summary file', trendGb)\n          })\n\n          d3.csv(trendIr)\n            .then(function(d) {\n              $('<div>').text('Ireland Post-1930 10 km modelled trend').appendTo($irTrend)\n              $irTrend.show()\n              trendSummary2('trend-sum-ir2')\n              updateTrendSummary2('trend-sum-ir2', d[0], develSummaryTrendColour)\n              $('#trend-sum-ir2').show()\n            }).catch(function(){\n            console.log('Error reading trend summary file', trendIr)\n          })\n\n          \n          // Text\n          $p = $('<p>').appendTo($caption)\n          $p.append(postProcessCaptionText(d[0].atlasSpeciesTrends))\n        }\n\n        // Biogeography\n        if (d[0].atlasSpeciesBiogeography) {\n          $caption.append('<h4>Biogeography</h4>')\n          $p = $('<p>').appendTo($caption)\n          $p.append(postProcessCaptionText(d[0].atlasSpeciesBiogeography))\n        }\n\n        // Status etc\n        $('#statusDevel').html('')\n        const $ulStatus = $('<ul>').appendTo($('#statusDevel'))\n        const vals = ['statusGB','statusIE','statusCI','csRedListEngland','csRedListWales','csNationalStatus','csRedListIreland','csRedDataList2005','csRedDataList2021']\n        vals.forEach(v => {\n          const $li=$('<li>').appendTo($ulStatus)\n          $li.html(`${v}: ${d[0][v]}`)\n        })\n        \n        // Parent taxa (for hybrids)\n        if (d[0].hybridParents) {\n\n          $caption.append('<h4>Hybrid parents</h4>')\n          const $ul = $('<ul>').appendTo($caption)\n\n          const parents = d[0].hybridParents.split(';')\n          const parentIds = d[0].hybridParentIds.split(';')\n\n          // A parent id may not exist as a taxon in the altas\n          // in which case do not link to it. Check if it exists\n          // by checking whether the caption file exists.\n          parents.forEach(async (p,i) => {\n            const pid = parentIds[i] ? parentIds[i] : ''\n            const inAtlas = await captionExists(pid)\n            const $li = $('<li>').appendTo($ul)\n            const $i = $('<i>').appendTo($li)\n            if (inAtlas) {\n              const $a = $('<a>').appendTo($i)\n              $a.attr('href', `/atlas/${pid}`)\n              $a.attr('alt', `Link to ${p}`)\n              $a.text(p)\n            } else {\n              $i.text(p)\n            }\n          })\n\n          async function captionExists(id) {\n            const captionRoot = ds.bsbi_atlas.dataRoot + 'bsbi/captions/'\n            const captionFile = `${captionRoot}${id.replace(/\\./g, \"_\")}.csv?prevent-cache=${pcache}`\n            const res = await fetch(captionFile,\n              { method: \"HEAD\" }\n            )\n            return res.ok\n          }\n        }\n\n        // Authors\n        if (d[0].captionAuthors) {\n          $caption.append('<h4>Authors</h4>')\n          const $pAuthors = $('<p>').appendTo($caption)\n          const aAuthors = d[0].captionAuthors.split(';')\n          let tAuthors\n          for (let i=0; i< aAuthors.length; i++) {\n            if (i === 0) {\n              tAuthors = aAuthors[i]\n            } else if (i === aAuthors.length-1) {\n              tAuthors = `${tAuthors} and ${aAuthors[i]}`\n            } else {\n              tAuthors = `${tAuthors}, ${aAuthors[i]}`\n            }\n          }\n          $pAuthors.text(tAuthors)\n        }\n\n        // References\n        $caption.append('<h4>References <span id=\"bsbi-reference-toggle\">[show]</span></h4>')\n        const $divref = $('<div id=\"bsbi-reference-div\">').appendTo($caption)\n        $p = $('<p id=\"bsbi-reference-text\">').appendTo($divref)\n        $p.text('TODO - references')\n\n        let taxaReferenceShown = false\n        $('#bsbi-reference-toggle').click(function() {\n          taxaReferenceShown = !taxaReferenceShown\n          if (taxaReferenceShown) {\n            $('#bsbi-reference-div').show()\n            $('#bsbi-reference-toggle').html('[hide]')\n          }\n          if (!taxaReferenceShown) {\n            $('#bsbi-reference-div').hide()\n            $('#bsbi-reference-toggle').html('[show]')\n          }\n        })\n\n        // Citation\n        $caption.append('<h4>Recommended citation <span id=\"bsbi-citation-toggle\">[show]</span></h4>')\n        const $div = $('<div id=\"bsbi-citation-div\">').appendTo($caption)\n        $p = $('<p id=\"bsbi-citation-text\">').appendTo($div)\n        $p.append(getCitation(currentTaxon))\n\n        // $p.append('<i>' + d[0].taxonName + ',</i> ')\n        // $p.append('in <i>BSBI Online Plant Atlas 2020</i>, eds P.A. Stroh, T. A. Humphrey, R.J. Burkmar, O.L. Pescott, D.B. Roy, & K.J. Walker. ')\n        // $p.append(location.origin + '/atlas/' + currentTaxon.identifier)\n        // $p.append(' [Accessed ' + new Date().toLocaleDateString('en-GB') + ']')\n\n        const $but1 = $('<button id=\"bsbi-citation-copy-text\">Copy as text</button>').appendTo($div)\n        $but1.addClass('btn btn-default')\n        const $but2 = $('<button id=\"bsbi-citation-copy-html\">Copy as HTML</button>').appendTo($div)\n        $but2.addClass('btn btn-default')\n\n        let taxaCitationShown = false\n        $('#bsbi-citation-toggle').click(function() {\n          taxaCitationShown = !taxaCitationShown\n          if (taxaCitationShown) {\n            $('#bsbi-citation-div').show()\n            $('#bsbi-citation-toggle').html('[hide]')\n          }\n          if (!taxaCitationShown) {\n            $('#bsbi-citation-div').hide()\n            $('#bsbi-citation-toggle').html('[show]')\n          }\n        })\n\n        $('#bsbi-citation-copy-text').click(function() {\n          copyToClipboard($('#bsbi-citation-text').text())\n        })\n\n        $('#bsbi-citation-copy-html').click(function() {\n          copyToClipboard($('#bsbi-citation-text').html())\n        })\n\n        // Update meta tags\n        addMetaTags('title', d[0].taxonName + ' in BSBI Online Plant Atlas 2020', true)\n      })\n  }\n\n  function ecoFlora(identifier) {\n    alert(\"link to ecoflora for: \" + identifier)\n  }\n\n  function worldFloraOnline(identifier) {\n    alert(\"link to world flora online for: \" + identifier)\n  }\n}","import pkg from './package.json'\r\nimport { main } from './js/main'\r\n\r\n// Output version from package json to console\r\n// to assist with trouble shooting.\r\nconsole.log(`Running ${pkg.name} version ${pkg.version}`)\r\n\r\n// Call main function\r\nmain()\r\n"],"names":["bsbiDataAccess","periodColours","standard","x","n","a","bullseye","missing","print","periodStroke","periodMappings","getCSV","identifier","type","folder","bsbiDataRoot","replace","getPeriodText","p","nativeSpeciesStatus","period","dotCaption","Promise","resolve","reject","d3","csv","r","hectad","occurs","periodClasses","csvperiods","forEach","csvPeriod","prior","gr","shape","size","colour","opacity","stroke","caption","noCaption","then","data","legend","precision","lines","text","pop","records","e","change","early","late","legendTitle","shapes","colours","changeColours","i","capText","presentEarly","some","f","presentLate","concat","title","distAllClasses","resolution","statusText","legendText","opacities","periods","Object","keys","reverse","counts","ire","total","gb","showStatus","country","length","hectadstatus","indexOf","recent","iPeriod","iCsvperiod","point","attrs","k","totalAlien","reduce","t","totalNative","push","underline","raligned","padding","tetrad","distAllClassesTetrad","distAllClassesMonad","status_29","status_30_69","status_70_86","status_87_99","status_00_19","hybrid","hybridInfo","taxaHybridList","find","h","taxon","markup","pHybrid","console","log","pParent1","parent1","pParent2","parent2","parent1Name","parent2Name","all","taxonData","iTaxonData","match","ar","presence","change_1987_1999_vs_2000_2019","change_1930_1969_vs_2000_2019","bsbiHectadDateTetFreq","tetrads","Number","tetround","Math","ceil","sqrt","$","jQuery","addMetaTags","value","update","addHeadTag","name","content","attr","append","html","phen1","phen2","phen3","altlat","apparencyByLatData","pcache","createEcology","sel","appendTo","$phenFlexParent","$phenFlexLeft","$phenFlexRight","$altlat","css","brccharts","selector","taxa","metrics","prop","label","fill","width","height","headPad","perRow","expand","showTaxonLabel","axisLeft","showLegend","interactivity","split","chartPad","$phenSource","spread","margin","left","right","top","bottom","axisLeftLabel","axisLabelFontSize","$parent","$div","$sel","addClass","on","apparencyByLat","val","$opt","selected","selectpicker","latPhenDataTypeDropdown","ranges","min","max","radius","legendFontSize","apparency","chart","sorted","map","d","week","sort","b","setChartOpts","phenology","textId","m2d","fs","phenFlowerStart","fe","phenFlowerEnd","ls","phenLeafStart","le","phenLeafEnd","flowerStart","flowerEnd","leafStart","leafEnd","flowerRange","leafRange","source","flowerText","tweakRef","phenFlowerRef","leafText","phenLeafRef","iMetric","svg","legendOrder","leaf","start","end","flower","ref","$tmp","$span1","children","eq","$span2","dataType","numeric","filter","nd","l","altLat","mdata","distance","altitude","metric","percent","ds","drupalSettings","createGallery","id","ddbid","document","getElementById","innerHTML","captionRoot","bsbi_atlas","dataRoot","captionFile","dynamicEl","images","img","src","thumb","subHtml","lgContainer","inlineGallery","lightGallery","container","dynamic","hash","closable","download","showMaximizeIcon","appendSubHtmlTo","slideDelay","plugins","lgZoom","lgThumbnail","thumbWidth","thumbHeight","thumbMargin","setTimeout","openGallery","show","hide","copyToClipboard","textToCopy","navigator","clipboard","window","isSecureContext","writeText","textArea","createElement","style","position","body","appendChild","focus","select","res","rej","execCommand","remove","setCookie","cname","cvalue","exdays","Date","setTime","getTime","expires","toUTCString","cookie","getCookie","ca","decodeURIComponent","c","charAt","substring","getCitation","currentTaxon","forImageDownload","shortName","location","origin","toLocaleDateString","slippyMap","staticMap","gridStyle","backdrop","mapType","insetType","boundaryType","displayedMapType","atlasRangeIndex","atlasTrendIndex","slippyLegendOpts","display","scale","y","svgLegendOpts","access","trends","lower","upper","mapControlRow","classname","setControlState","disableStatus","taxaNoStatusList","isHybrid","hybridMapping","$hybridopts","mapSetCurrentTaxon","createMaps","transOptsSel","JSON","parse","stringify","brcatlas","namedTransOpts","BI3","BI4","bounds","xmin","BI1","BI2","mapTypesSel","svgMap","mapid","captionId","legendOpts","transOptsKey","mapTypesKey","mapTypesControl","transOptsControl","seaFill","gridLineColour","gridLineStyle","boundaryColour","vcColour","vcLineStyle","countryColour","countryLineStyle","leafletMap","getMapWidth","basemapConfigs","url","opts","maxZoom","attribution","subdomains","minZoom","ext","layers","callbacks","showVcs","showCountries","changeMap","retPromise","displayedMap","setMapType","setLegendOpts","setIdentfier","redrawMap","warn","clearMap","createMapControls","$container","$bgrp","$staticLabel","$slippyLabel","$loader","this","$svg","w","setSize","invalidateSize","mapInterfaceToggle","$sliderContainer","$slider","$scaleContainer","$tick","toString","$tickText","statusControl","$checDiv","is","statusCheckbox","trendControl","rasterRoot","backdrops","basemapImage","backdropSelector","setTransform","insetSelector","setGridLineStyle","s","gridStyleSelector","setVcLineStyle","setCountryLineStyle","setBoundaryColour","setShowVcs","setShowCountries","boundarySelector","initOpacity","$sliderLabel","opacitySlider","each","makeRadio","checked","$radio","$label","resolutionControl","imageType","$t","$button","$span","info","fontSize","saveMap","mapImageButton","downloadType","downloadData","mapDownloadButton","updateBsbiDataAccess","key","getStaticMap","updateTrendSummary2","rgbColourString","setColour","baseColour","grey","floor","declineStrong","declineMod","stable","increaseMod","increaseStrong","trendSummary2","svgArrow","swatches","rot","da","ss","sr","path","svgbbox","node","getBBox","iScale","xAdj","yAdj","xRot","trendSave","filename","serialize","downloadLink","dataUrl","file","link","href","dispatchEvent","MouseEvent","bubbles","cancelable","view","removeChild","xmlns","cloneSvg","cloneNode","selectAll","setAttributeNS","string","XMLSerializer","serializeToString","Blob","URL","createObjectURL","blob1","browsedFileData","aNoStatus","aIsHybrid","bCancelled","downloadPage","$file","clearCharts","noStatus","mappingUpdate","apparencyUpdate","phenologyUpdate","altlatUpdate","trendsUpdate","taxonSelectors","taxonToFile","saveImage","event","reader","FileReader","addEventListener","target","result","readAsDataURL","files","fileOpened","downloadTaxa","downloadBatchButton","cancelDownloadBatchButton","makeCheckbox","mapping","altlatChart","taxonId","eMapping","eApparency","ePhenology","eAltlat","p1","p2","p3","p4","p5","apparencyRoot","altlatRoot","altlatfile","altlatdata","trendRoot","trendGb","trendIr","pGb","pIr","develSummaryTrendColour","pkg","taxaList","sectionEmpty","$sect","sectionSummary","$d","$r","$left","$right","sectionEcology","sectionGallery","postProcessCaptionText","txt","txtn","dataBsbidb","changeEcologyTab","mapRoot","fileAll","fileLat","changeEcology","changeCaption","$caption","vernacular","formatted","tName","formattedName","atlasSpeciesDescription","captionedChildTaxonIds","$ul","$li","$i","$a","taxonName","taxaCoveredShown","click","atlasSpeciesTrends","$gbTrend","$irTrend","atlasSpeciesBiogeography","$ulStatus","v","hybridParents","captionExists","fetch","method","ok","parents","parentIds","hybridParentIds","pid","inAtlas","captionAuthors","tAuthors","$pAuthors","aAuthors","$divref","taxaReferenceShown","taxaCitationShown","ecoFlora","alert","worldFloraOnline","ready","state","pathname","sections","group","fn","external","$link","aParentids","clickedIndex","newValue","oldValue","history","pushState","parentNames","makeTabButton","$content","$h","makeSection","mainAtlasContent","changeSwatchColour","$colours","$divTrendSwatch","trendSwatchColour","JSColor","onChange","toRGBString","fromString","develTrendSummary","main"],"mappings":"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"}